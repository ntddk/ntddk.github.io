<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2016/7 | 一生あとで読んでろ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="一生あとで読んでろ">
<meta property="og:url" content="http://ntddk.github.io/archives/2016/07/index.html">
<meta property="og:site_name" content="一生あとで読んでろ">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一生あとで読んでろ">
  
  
  <link href="//fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">一生あとで読んでろ</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技術ブログ</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-home-icon" class="nav-icon" href="/"></a>
        
          <a id="nav-about-icon" class="nav-icon" href="/about"></a>
        
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-unicorn-internals-python" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/07/09/unicorn-internals-python/">Unicornのソースコードを読む (Python編)</a>
  

      </header>
    
    <time class="article-date" datetime="2016-07-09T06:20:00.000Z" itemprop="datePublished">07-09-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　※Rackサーバの方のUnicornではない．</p>
<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>　<a href="http://www.unicorn-engine.org/" target="_blank" rel="external">Unicorn</a>は<a href="http://www.qemu.org/" target="_blank" rel="external">QEMU</a>ベースの軽量，マルチプラットフォーム・マルチアーキテクチャ・JIT対応のCPUエミュレータ．周辺機器をエミュレーションしないため用途は限られるが，GoやPythonなど<a href="https://github.com/unicorn-engine/unicorn/tree/master/bindings" target="_blank" rel="external">複数言語のバインディング</a>を備えている．現在システムセキュリティ分野で最も注目されているOSSのひとつと言っても過言ではなく，<a href="https://github.com/vrtadmin/ROPMEMU" target="_blank" rel="external">AsiaCCS 2016で発表されたROPチェーン解析ツールROPMEMU</a>や，<a href="https://github.com/oblivia-simplex/roper" target="_blank" rel="external">遺伝的アルゴリズムによってROPチェーンを自動生成するツールroper</a>のバックエンドとして用いられたり，Unicornと同じように注目を集めているバイナリ解析ツール<a href="https://github.com/angr/simuvex/issues/29" target="_blank" rel="external">angrとの連携</a>が進められたりと，一大コミュニティを形成しつつある．<br>　コンセプトの説明は<a href="http://www.unicorn-engine.org/BHUSA2015-unicorn.pdf" target="_blank" rel="external">Black Hat USA 2015の発表スライド</a>に譲るとして，ここではその利用方法と内部実装にふれる．</p>
<h1 id="Pythonバインディング"><a href="#Pythonバインディング" class="headerlink" title="Pythonバインディング"></a>Pythonバインディング</h1><blockquote>
<p>　情報セキュリティに興味があり，セキュリティ関係の仕事に携わりたいという人には，Pythonはうってつけの言語だ．その理由は，リバースエンジニアリングと攻撃コード作成のためのライブラリが充実しているためだ．<br>　　　　　　　– Justin Seitz『<a href="https://www.oreilly.co.jp/books/9784873117317/" target="_blank" rel="external">サイバーセキュリティプログラミング———Pythonで学ぶハッカーの思考</a>』序文</p>
</blockquote>
<p>　リバースエンジニアリングというタスクにUnicornを用いることを考える．他言語を選ぶ積極的な理由やPythonへのアレルギーがなければ，他のライブラリとの連携も考慮して，Pythonバインディングを活用すべきだろう．</p>
<h1 id="エミュレーション"><a href="#エミュレーション" class="headerlink" title="エミュレーション"></a>エミュレーション</h1><p>　最もシンプルな用例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#-*- coding:utf-8 -*-</span></div><div class="line"><span class="comment"># unicorn/bindings/python/sample_x86.pyを抜粋・改変</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function <span class="comment"># Python 2.7を利用</span></div><div class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="comment"># エミュレーション対象の機械語</span></div><div class="line">X86_CODE32 = <span class="string">b"\x41\x4a"</span> <span class="comment"># INC ecx; DEC edx</span></div><div class="line"></div><div class="line"><span class="comment"># 各基本ブロックに対するコールバック</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_block</span><span class="params">(uc, address, size, user_data)</span>:</span></div><div class="line">    print(<span class="string">"&gt;&gt;&gt; Tracing basic block at 0x%x, block size = 0x%x"</span> %(address, size))</div><div class="line"></div><div class="line"><span class="comment"># 各命令に対するコールバック</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span><span class="params">(uc, address, size, user_data)</span>:</span></div><div class="line">    print(<span class="string">"&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = %u"</span> %(address, size))</div><div class="line"></div><div class="line"><span class="comment"># x86 32bitのコードをエミュレーション</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_i386</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">"Emulate i386 code"</span>)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># x86-32bitモードでエミュレータを初期化</span></div><div class="line">        mu = Uc(UC_ARCH_X86, UC_MODE_32)</div><div class="line"></div><div class="line">        <span class="comment"># エミュレーション用に2MBのメモリを割り当て</span></div><div class="line">        mu.mem_map(ADDRESS, <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>)</div><div class="line"></div><div class="line">        <span class="comment"># 割り当てられたメモリに機械語を書き込み</span></div><div class="line">        mu.mem_write(ADDRESS, X86_CODE32)</div><div class="line"></div><div class="line">        <span class="comment"># レジスタ初期化</span></div><div class="line">        mu.reg_write(UC_X86_REG_ECX, <span class="number">0x1234</span>) <span class="comment"># エミュレーション中に加算される</span></div><div class="line">        mu.reg_write(UC_X86_REG_EDX, <span class="number">0x7890</span>) <span class="comment"># エミュレーション中に減算される</span></div><div class="line"></div><div class="line">        <span class="comment"># 各基本ブロックに対するコールバックを設定</span></div><div class="line">        mu.hook_add(UC_HOOK_BLOCK, hook_block)</div><div class="line"></div><div class="line">        <span class="comment"># 各命令に対するコールバックを設定</span></div><div class="line">        mu.hook_add(UC_HOOK_CODE, hook_code)</div><div class="line"></div><div class="line">        <span class="comment"># エミュレーション開始</span></div><div class="line">        mu.emu_start(ADDRESS, ADDRESS + len(X86_CODE32))</div><div class="line"></div><div class="line">        <span class="comment"># レジスタの表示</span></div><div class="line">        print(<span class="string">"&gt;&gt;&gt; Emulation done. Below is the CPU context"</span>)</div><div class="line"></div><div class="line">        r_ecx = mu.reg_read(UC_X86_REG_ECX)</div><div class="line">        r_edx = mu.reg_read(UC_X86_REG_EDX)</div><div class="line">        print(<span class="string">"&gt;&gt;&gt; ECX = 0x%x"</span> %r_ecx)</div><div class="line">        print(<span class="string">"&gt;&gt;&gt; EDX = 0x%x"</span> %r_edx)</div><div class="line"></div><div class="line">        <span class="comment"># メモリから命令列を読む</span></div><div class="line">        tmp = mu.mem_read(ADDRESS, <span class="number">2</span>)</div><div class="line">        print(<span class="string">"&gt;&gt;&gt; Read 2 bytes from [0x%x] ="</span> %(ADDRESS), end=<span class="string">""</span>)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> tmp:</div><div class="line">            print(<span class="string">" 0x%x"</span> %i, end=<span class="string">""</span>)</div><div class="line">        print(<span class="string">""</span>)</div><div class="line"></div><div class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</div><div class="line">        print(<span class="string">"ERROR: %s"</span> % e)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    test_i386()</div></pre></td></tr></table></figure>
<p>　これを実行すると次のような出力が得られる．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Emulate i386 code</div><div class="line">&gt;&gt;&gt; Tracing basic block at 0x1000000, block size = 0x2</div><div class="line">&gt;&gt;&gt; Tracing instruction at 0x1000000, instruction size = 1</div><div class="line">&gt;&gt;&gt; Tracing instruction at 0x1000001, instruction size = 1</div><div class="line">&gt;&gt;&gt; Emulation done. Below is the CPU context</div><div class="line">&gt;&gt;&gt; ECX = 0x1235</div><div class="line">&gt;&gt;&gt; EDX = 0x788f</div><div class="line">&gt;&gt;&gt; Read 2 bytes from [0x1000000] = 0x41 0x4a</div></pre></td></tr></table></figure>
<p>　はい．<br>　なおエミュレーション時に各命令のトレースを得たければ，同じ開発陣による逆アセンブラ<a href="http://www.capstone-engine.org/" target="_blank" rel="external">Capstone</a>のPythonバインディングを併用して (詳細は割愛) 次のようなフックを用意すればよい：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</div><div class="line">...</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleEngine</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.capmd = Cs(CS_ARCH_X86, CS_MODE_32) <span class="comment"># アーキテクチャ指定</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">disas_single</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.capmd.disasm(data, <span class="number">16</span>): <span class="comment"># 逆アセンブル</span></div><div class="line">            print(<span class="string">"\t%s\t%s"</span> % (i.mnemonic, i.op_str))</div><div class="line">            <span class="keyword">break</span></div><div class="line"></div><div class="line">disasm = SimpleEngine()</div><div class="line">...</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span><span class="params">(uc, address, size, user_data)</span>:</span></div><div class="line">    print(<span class="string">"&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = %u, "</span> %(address, size), end=<span class="string">""</span>)</div><div class="line">    <span class="comment"># メモリから実行される命令を読む</span></div><div class="line">    ins = uc.mem_read(address, size)</div><div class="line">    disasm.disas_single(str(ins))</div></pre></td></tr></table></figure>
<p>　実行すると命令のトレースが得られる．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">&gt;&gt;&gt; Tracing instruction at 0x1000000, instruction size = 1,     inc     ecx</div><div class="line">&gt;&gt;&gt; Tracing instruction at 0x1000001, instruction size = 1,     dec     edx</div><div class="line">...</div></pre></td></tr></table></figure>
<p>　このように，Unicornではプラグイン側のエントリポイントからQEMUの機能を呼び出していくことになる．</p>
<h1 id="Pythonバインディングの内部"><a href="#Pythonバインディングの内部" class="headerlink" title="Pythonバインディングの内部"></a>Pythonバインディングの内部</h1><p>　この内部では，ctypesによる共有ライブラリのロードが行われている．<code>unicorn/bindings/python/unicorn/unicorn.py</code>を見よう：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> _lib <span class="keyword">in</span> _all_libs:</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">if</span> _lib == <span class="string">"unicorn.dll"</span>:</div><div class="line">            <span class="keyword">for</span> dll <span class="keyword">in</span> _all_windows_dlls:    <span class="comment"># load all the rest DLLs first</span></div><div class="line">                _lib_file = os.path.join(_lib_path, dll)</div><div class="line">                <span class="keyword">if</span> os.path.exists(_lib_file):</div><div class="line">                    ctypes.cdll.LoadLibrary(_lib_file)</div><div class="line">        _lib_file = os.path.join(_lib_path, _lib)</div><div class="line">        _uc = ctypes.cdll.LoadLibrary(_lib_file)</div><div class="line">        _found = <span class="keyword">True</span></div><div class="line">        <span class="keyword">break</span></div><div class="line">    <span class="keyword">except</span> OSError:</div><div class="line">        <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<p>　ここで<code>_uc</code>に<code>unicorn.dll</code> (環境によって異なるがいずれにせよ共有ライブラリ) がロードされている．<br>　さて，これまで利用してきた関数のプロトタイプ宣言は<code>unicorn/bindings/python/unicorn/unicorn.py</code>にある：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># setup all the function prototype</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_setup_prototype</span><span class="params">(lib, fname, restype, *argtypes)</span>:</span></div><div class="line">    getattr(lib, fname).restype = restype</div><div class="line">    getattr(lib, fname).argtypes = argtypes</div><div class="line"></div><div class="line">ucerr = ctypes.c_int</div><div class="line">uc_engine = ctypes.c_void_p</div><div class="line">uc_hook_h = ctypes.c_size_t</div><div class="line"></div><div class="line">_setup_prototype(_uc, <span class="string">"uc_version"</span>, ctypes.c_uint, ctypes.POINTER(ctypes.c_int), ctypes.POINTER(ctypes.c_int))</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_arch_supported"</span>, ctypes.c_bool, ctypes.c_int)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_open"</span>, ucerr, ctypes.c_uint, ctypes.c_uint, ctypes.POINTER(uc_engine))</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_close"</span>, ucerr, uc_engine)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_strerror"</span>, ctypes.c_char_p, ucerr)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_errno"</span>, ucerr, uc_engine)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_reg_read"</span>, ucerr, uc_engine, ctypes.c_int, ctypes.c_void_p)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_reg_write"</span>, ucerr, uc_engine, ctypes.c_int, ctypes.c_void_p)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_mem_read"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.POINTER(ctypes.c_char), ctypes.c_size_t)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_mem_write"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.POINTER(ctypes.c_char), ctypes.c_size_t)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_emu_start"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_uint64, ctypes.c_uint64, ctypes.c_size_t)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_emu_stop"</span>, ucerr, uc_engine)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_hook_del"</span>, ucerr, uc_engine, uc_hook_h)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_mem_map"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_size_t, ctypes.c_uint32)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_mem_map_ptr"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_size_t, ctypes.c_uint32, ctypes.c_void_p)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_mem_unmap"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_size_t)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_mem_protect"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_size_t, ctypes.c_uint32)</div><div class="line">_setup_prototype(_uc, <span class="string">"uc_query"</span>, ucerr, uc_engine, ctypes.c_uint32, ctypes.POINTER(ctypes.c_size_t))</div><div class="line"></div><div class="line"><span class="comment"># uc_hook_add is special due to variable number of arguments</span></div><div class="line">_uc.uc_hook_add = _uc.uc_hook_add</div><div class="line">_uc.uc_hook_add.restype = ucerr</div><div class="line"></div><div class="line">UC_HOOK_CODE_CB = ctypes.CFUNCTYPE(<span class="keyword">None</span>, uc_engine, ctypes.c_uint64, ctypes.c_size_t, ctypes.c_void_p)</div><div class="line">UC_HOOK_MEM_INVALID_CB = ctypes.CFUNCTYPE(</div><div class="line">    ctypes.c_bool, uc_engine, ctypes.c_int,</div><div class="line">    ctypes.c_uint64, ctypes.c_int, ctypes.c_int64, ctypes.c_void_p</div><div class="line">)</div><div class="line">UC_HOOK_MEM_ACCESS_CB = ctypes.CFUNCTYPE(</div><div class="line">    <span class="keyword">None</span>, uc_engine, ctypes.c_int,</div><div class="line">    ctypes.c_uint64, ctypes.c_int, ctypes.c_int64, ctypes.c_void_p</div><div class="line">)</div><div class="line">UC_HOOK_INTR_CB = ctypes.CFUNCTYPE(</div><div class="line">    <span class="keyword">None</span>, uc_engine, ctypes.c_uint32, ctypes.c_void_p</div><div class="line">)</div><div class="line">UC_HOOK_INSN_IN_CB = ctypes.CFUNCTYPE(</div><div class="line">    ctypes.c_uint32, uc_engine, ctypes.c_uint32, ctypes.c_int, ctypes.c_void_p</div><div class="line">)</div><div class="line">UC_HOOK_INSN_OUT_CB = ctypes.CFUNCTYPE(</div><div class="line">    <span class="keyword">None</span>, uc_engine, ctypes.c_uint32,</div><div class="line">    ctypes.c_int, ctypes.c_uint32, ctypes.c_void_p</div><div class="line">)</div><div class="line">UC_HOOK_INSN_SYSCALL_CB = ctypes.CFUNCTYPE(<span class="keyword">None</span>, uc_engine, ctypes.c_void_p)</div></pre></td></tr></table></figure>
<p>　メモリ・レジスタを読み書きできることがわかる．<br>　さきほどは基本ブロック・命令単位のコールバック関数——フック——を設置した．その他のフックも次のように書ける：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mu.hook_add(UC_HOOK_BLOCK, hook_block) <span class="comment"># 基本ブロック単位</span></div><div class="line">mu.hook_add(UC_HOOK_CODE, hook_code)   <span class="comment"># 命令単位</span></div><div class="line">mu.hook_add(UC_HOOK_CODE, hook_code, <span class="keyword">None</span>, ADDRESS, ADDRESS+<span class="number">20</span>) <span class="comment"># 指定範囲[ADDRESS, ADDRESS+20]の全命令</span></div><div class="line">mu.hook_add(UC_HOOK_INSN, hook_in, <span class="keyword">None</span>, <span class="number">1</span>, <span class="number">0</span>, UC_X86_INS_IN)   <span class="comment"># IN命令</span></div><div class="line">mu.hook_add(UC_HOOK_INSN, hook_out, <span class="keyword">None</span>, <span class="number">1</span>, <span class="number">0</span>, UC_X86_INS_OUT) <span class="comment"># OUT命令</span></div><div class="line">mu.hook_add(UC_HOOK_MEM_WRITE, hook_mem_access) <span class="comment"># メモリ書き込み</span></div><div class="line">mu.hook_add(UC_HOOK_MEM_READ, hook_mem_access)  <span class="comment"># メモリ読み込み</span></div><div class="line">mu.hook_add(UC_HOOK_MEM_READ | UC_HOOK_MEM_WRITE, hook_mem_access) <span class="comment"># その両方</span></div><div class="line">mu.hook_add(UC_HOOK_MEM_READ_UNMAPPED | UC_HOOK_MEM_WRITE_UNMAPPED, hook_mem_invalid) <span class="comment"># 無効なメモリアクセス</span></div><div class="line">mu.hook_add(UC_HOOK_INSN, hook_syscall, <span class="keyword">None</span>, <span class="number">1</span>, <span class="number">0</span>, UC_X86_INS_SYSCALL) <span class="comment"># システムコール</span></div><div class="line">mu.hook_add(UC_HOOK_INTR, hook_intr) <span class="comment"># 割り込み</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>　こうしたフックや，これまで用いてきたレジスタやメモリの読み書き・エミュレーションといった機能は<code>Uc</code>クラスのメソッドとして用意されている：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uc</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, arch, mode)</span>:</span></div><div class="line">        <span class="comment"># verify version compatibility with the core before doing anything</span></div><div class="line">        (major, minor, _combined) = uc_version()</div><div class="line">        <span class="keyword">if</span> major != uc.UC_API_MAJOR <span class="keyword">or</span> minor != uc.UC_API_MINOR:</div><div class="line">            self._uch = <span class="keyword">None</span></div><div class="line">            <span class="comment"># our binding version is different from the core's API version</span></div><div class="line">            <span class="keyword">raise</span> UcError(uc.UC_ERR_VERSION)</div><div class="line"></div><div class="line">        self._arch, self._mode = arch, mode</div><div class="line">        self._uch = ctypes.c_void_p()</div><div class="line">        status = _uc.uc_open(arch, mode, ctypes.byref(self._uch))</div><div class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</div><div class="line">            self._uch = <span class="keyword">None</span></div><div class="line">            <span class="keyword">raise</span> UcError(status)</div><div class="line">        <span class="comment"># internal mapping table to save callback &amp; userdata</span></div><div class="line">        self._callbacks = &#123;&#125;</div><div class="line">        self._ctype_cbs = &#123;&#125;</div><div class="line">        self._callback_count = <span class="number">0</span></div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">    <span class="comment"># emulate from @begin, and stop when reaching address @until</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">emu_start</span><span class="params">(self, begin, until, timeout=<span class="number">0</span>, count=<span class="number">0</span>)</span>:</span></div><div class="line">        status = _uc.uc_emu_start(self._uch, begin, until, timeout, count)</div><div class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</div><div class="line">            <span class="keyword">raise</span> UcError(status)</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">    <span class="comment"># return the value of a register</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg_read</span><span class="params">(self, reg_id)</span>:</span></div><div class="line">        <span class="keyword">if</span> self._arch == uc.UC_ARCH_X86:</div><div class="line">            <span class="keyword">if</span> reg_id <span class="keyword">in</span> [x86_const.UC_X86_REG_IDTR, x86_const.UC_X86_REG_GDTR, x86_const.UC_X86_REG_LDTR, x86_const.UC_X86_REG_TR]:</div><div class="line">                reg = uc_x86_mmr()</div><div class="line">                status = _uc.uc_reg_read(self._uch, reg_id, ctypes.byref(reg))</div><div class="line">                <span class="keyword">if</span> status != uc.UC_ERR_OK:</div><div class="line">                    <span class="keyword">raise</span> UcError(status)</div><div class="line">                <span class="keyword">return</span> reg.selector, reg.base, reg.limit, reg.flags</div><div class="line">            <span class="keyword">if</span> reg_id <span class="keyword">in</span> range(x86_const.UC_X86_REG_FP0, x86_const.UC_X86_REG_FP0+<span class="number">8</span>):</div><div class="line">                reg = uc_x86_float80()</div><div class="line">                status = _uc.uc_reg_read(self._uch, reg_id, ctypes.byref(reg))</div><div class="line">                <span class="keyword">if</span> status != uc.UC_ERR_OK:</div><div class="line">                    <span class="keyword">raise</span> UcError(status)</div><div class="line">                <span class="keyword">return</span> reg.mantissa, reg.exponent</div><div class="line"></div><div class="line">        <span class="comment"># read to 64bit number to be safe</span></div><div class="line">        reg = ctypes.c_int64(<span class="number">0</span>)</div><div class="line">        status = _uc.uc_reg_read(self._uch, reg_id, ctypes.byref(reg))</div><div class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</div><div class="line">            <span class="keyword">raise</span> UcError(status)</div><div class="line">        <span class="keyword">return</span> reg.value</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">    <span class="comment"># read data from memory</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mem_read</span><span class="params">(self, address, size)</span>:</span></div><div class="line">        data = ctypes.create_string_buffer(size)</div><div class="line">        status = _uc.uc_mem_read(self._uch, address, data, size)</div><div class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</div><div class="line">            <span class="keyword">raise</span> UcError(status)</div><div class="line">        <span class="keyword">return</span> bytearray(data)</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">    <span class="comment"># add a hook</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hook_add</span><span class="params">(self, htype, callback, user_data=None, begin=<span class="number">1</span>, end=<span class="number">0</span>, arg1=<span class="number">0</span>)</span>:</span></div><div class="line">        _h2 = uc_hook_h()</div><div class="line"></div><div class="line">        <span class="comment"># save callback &amp; user_data</span></div><div class="line">        self._callback_count += <span class="number">1</span></div><div class="line">        self._callbacks[self._callback_count] = (callback, user_data)</div><div class="line">        cb = <span class="keyword">None</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> htype == uc.UC_HOOK_INSN: <span class="comment"># 特定の命令に応じた内部処理</span></div><div class="line">            insn = ctypes.c_int(arg1)</div><div class="line">            <span class="keyword">if</span> arg1 == x86_const.UC_X86_INS_IN:  <span class="comment"># IN命令</span></div><div class="line">                cb = ctypes.cast(UC_HOOK_INSN_IN_CB(self._hook_insn_in_cb), UC_HOOK_INSN_IN_CB)</div><div class="line">            <span class="keyword">if</span> arg1 == x86_const.UC_X86_INS_OUT:  <span class="comment"># OUT命令</span></div><div class="line">                cb = ctypes.cast(UC_HOOK_INSN_OUT_CB(self._hook_insn_out_cb), UC_HOOK_INSN_OUT_CB)</div><div class="line">            <span class="keyword">if</span> arg1 <span class="keyword">in</span> (x86_const.UC_X86_INS_SYSCALL, x86_const.UC_X86_INS_SYSENTER):  <span class="comment"># SYSCALL/SYSENTER命令</span></div><div class="line">                cb = ctypes.cast(UC_HOOK_INSN_SYSCALL_CB(self._hook_insn_syscall_cb), UC_HOOK_INSN_SYSCALL_CB)</div><div class="line">            status = _uc.uc_hook_add(</div><div class="line">                self._uch, ctypes.byref(_h2), htype, cb,</div><div class="line">                ctypes.cast(self._callback_count, ctypes.c_void_p),</div><div class="line">                ctypes.c_uint64(begin), ctypes.c_uint64(end), insn</div><div class="line">            )</div><div class="line">        <span class="keyword">elif</span> htype == uc.UC_HOOK_INTR: <span class="comment"># 割り込み</span></div><div class="line">            cb = ctypes.cast(UC_HOOK_INTR_CB(self._hook_intr_cb), UC_HOOK_INTR_CB)</div><div class="line">            status = _uc.uc_hook_add(</div><div class="line">                self._uch, ctypes.byref(_h2), htype, cb,</div><div class="line">                ctypes.cast(self._callback_count, ctypes.c_void_p),</div><div class="line">                ctypes.c_uint64(begin), ctypes.c_uint64(end)</div><div class="line">            )</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> htype <span class="keyword">in</span> (uc.UC_HOOK_BLOCK, uc.UC_HOOK_CODE): <span class="comment"># 基本ブロック・命令単位</span></div><div class="line">                <span class="comment"># set callback with wrapper, so it can be called</span></div><div class="line">                <span class="comment"># with this object as param</span></div><div class="line">                cb = ctypes.cast(UC_HOOK_CODE_CB(self._hookcode_cb), UC_HOOK_CODE_CB)</div><div class="line">                status = _uc.uc_hook_add(</div><div class="line">                    self._uch, ctypes.byref(_h2), htype, cb,</div><div class="line">                    ctypes.cast(self._callback_count, ctypes.c_void_p),</div><div class="line">                    ctypes.c_uint64(begin), ctypes.c_uint64(end)</div><div class="line">                )</div><div class="line">            <span class="keyword">elif</span> htype &amp; (uc.UC_HOOK_MEM_READ_UNMAPPED |  <span class="comment"># 無効なメモリアクセス</span></div><div class="line">                          uc.UC_HOOK_MEM_WRITE_UNMAPPED |</div><div class="line">                          uc.UC_HOOK_MEM_FETCH_UNMAPPED |</div><div class="line">                          uc.UC_HOOK_MEM_READ_PROT |      <span class="comment"># 保護された領域へのメモリアクセス</span></div><div class="line">                          uc.UC_HOOK_MEM_WRITE_PROT |</div><div class="line">                          uc.UC_HOOK_MEM_FETCH_PROT):</div><div class="line">                cb = ctypes.cast(UC_HOOK_MEM_INVALID_CB(self._hook_mem_invalid_cb), UC_HOOK_MEM_INVALID_CB)</div><div class="line">                status = _uc.uc_hook_add(</div><div class="line">                    self._uch, ctypes.byref(_h2), htype, cb,</div><div class="line">                    ctypes.cast(self._callback_count, ctypes.c_void_p),</div><div class="line">                    ctypes.c_uint64(begin), ctypes.c_uint64(end)</div><div class="line">                )</div><div class="line">            <span class="keyword">else</span>: <span class="comment"># メモリ読み書き</span></div><div class="line">                cb = ctypes.cast(UC_HOOK_MEM_ACCESS_CB(self._hook_mem_access_cb), UC_HOOK_MEM_ACCESS_CB)</div><div class="line">                status = _uc.uc_hook_add(</div><div class="line">                    self._uch, ctypes.byref(_h2), htype, cb,</div><div class="line">                    ctypes.cast(self._callback_count, ctypes.c_void_p),</div><div class="line">                    ctypes.c_uint64(begin), ctypes.c_uint64(end)</div><div class="line">                )</div><div class="line"></div><div class="line">        <span class="comment"># save the ctype function so gc will leave it alone.</span></div><div class="line">        self._ctype_cbs[self._callback_count] = cb</div><div class="line"></div><div class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</div><div class="line">            <span class="keyword">raise</span> UcError(status)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> _h2.value</div></pre></td></tr></table></figure>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>　PythonからUnicornを利用する方法を紹介した．<br>　結局のところctypesでラップされており，こうした機能がどのようにして実行されるのかは本体のコードを読まなければ理解できない．そういうわけで，そのうちUnicorn本体の実装を読んでいくことにする．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/07/09/unicorn-internals-python/" data-id="cj6qhpkk9001bwgosleayqgci" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dynamic-binary-translation/">dynamic binary translation</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 ntddk<br>
      <a href="https://github.com/ntddk/hexo-theme-jathena" target="_blank">JAthena</a> by <a href="https://ntddk.github.io" target="_blank">ntddk</a> | Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>