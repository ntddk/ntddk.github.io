<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tag: virtual machine introspection | 一生あとで読んでろ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="技術ブログ">
<meta property="og:type" content="website">
<meta property="og:title" content="一生あとで読んでろ">
<meta property="og:url" content="http://ntddk.github.io/tags/virtual-machine-introspection/index.html">
<meta property="og:site_name" content="一生あとで読んでろ">
<meta property="og:description" content="技術ブログ">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一生あとで読んでろ">
<meta name="twitter:description" content="技術ブログ">
  
  
  <link href="//fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">一生あとで読んでろ</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技術ブログ</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-home-icon" class="nav-icon" href="/"></a>
        
          <a id="nav-about-icon" class="nav-icon" href="/about"></a>
        
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-thin-hypervisor-2017" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/03/04/thin-hypervisor-2017/">シン・ハイパーバイザ2017 (前編)</a>
  

      </header>
    
    <time class="article-date" datetime="2017-03-04T09:45:00.000Z" itemprop="datePublished">03-04-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　いまさらながら，<a href="http://www.adventar.org/calendars/1401" target="_blank" rel="external">情報セキュリティ系論文紹介 Advent Calendar 2016</a>あるいは<a href="http://qiita.com/advent-calendar/2016/bitvisor" target="_blank" rel="external">BitVisor Advent Calendar 2016</a>に投稿されるはずだった文章を供養する．</p>
<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>　本稿では，シン，すなわち薄いハイパーバイザ (thin hypervisor) の動向を紹介する．<br>　薄いハイパーバイザとは，小規模であることを志向したハイパーバイザだ——ということにしておこう．小規模というのは，一部のイベントのみトラップするということだ．メリットとしては，実装・学習コストやオーバーヘッド，TCB (trusted computing base) を削減できる点が挙げられる．<br>　用語の初出はBitVisorの論文<a href="https://www.os.ecc.u-tokyo.ac.jp/papers/vee2009-shina.pdf" target="_blank" rel="external">[T. Shinagawa, et al. VEE’09]</a>だが，多くはWindows向けルートキットとして開発されたBlue Pillという手法<a href="http://www.blackhat.com/presentations/bh-usa-06/BH-US-06-Rutkowska.pdf" target="_blank" rel="external">[J. Rutkowska. Black Hat USA’06]</a>の流れを汲んでいる．そのため，ブート時からゲストを掌握するのではなく，のちほど——あえてchain of trustの構築を放棄して——カーネルドライバとしてロードされるものが一般的である．そのほか，単一のゲストのみ対象とする，セキュリティを意識しているといった傾向が見られる．<br>　前編となる今回は，3種類の薄いハイパーバイザを見ていく．</p>
<h1 id="ksm"><a href="#ksm" class="headerlink" title="ksm"></a>ksm</h1><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>リポジトリ</td>
<td><a href="https://github.com/asamy/ksm" target="_blank" rel="external">https://github.com/asamy/ksm</a></td>
</tr>
<tr>
<td>形態</td>
<td>カーネルドライバ</td>
</tr>
<tr>
<td>仮想化支援機能</td>
<td>Intel VT-x with EPT</td>
</tr>
<tr>
<td>サポートしている環境</td>
<td>Windows 7/8/8.1/10, Linux</td>
</tr>
<tr>
<td>言語</td>
<td>C, アセンブリ言語</td>
</tr>
<tr>
<td>ライセンス</td>
<td>GNU GPL v2</td>
</tr>
</tbody>
</table>
<p>　ksmは高速，拡張可能かつ小規模であることを旨としているハイパーバイザで，アンチウイルスソフトウェアやサンドボックスへの利用を意識して開発されている．機能は以下の通り：</p>
<ul>
<li>IDT Shadowing</li>
<li>EPT violation #VE (Broadwell以降)</li>
<li>EPTP switching VMFUNC (Haswell以降，もしサポートされていなければVMCALLで代替)</li>
<li>Builtin Userspace physical memory sandboxer (ビルドオプション)</li>
<li>Builtin Introspection engine (ビルドオプション)</li>
<li>APIC virtualization (実験的機能)</li>
<li>VMX Nesting (実験的機能)</li>
</ul>
<p>　主なソースコードは以下の通り：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/main_nt.c" target="_blank" rel="external"><code>main_nt.c</code></a>, <a href="https://github.com/asamy/ksm/blob/master/main_linux.c" target="_blank" rel="external"><code>main_linux.c</code></a></td>
<td>カーネルドライバのエントリポイント，<code>ioctl</code>ディスパッチ</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/ksm.c" target="_blank" rel="external"><code>ksm.c</code></a></td>
<td>ハイパーバイザ全体の初期化</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/vmx.S" target="_blank" rel="external"><code>vmx.S</code></a>, <a href="https://github.com/asamy/ksm/blob/master/vmx.asm" target="_blank" rel="external"><code>vmx.asm</code></a></td>
<td>IDTやEPT violationのトラップ，ゲストのレジスタ退避</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/vcpu.c" target="_blank" rel="external"><code>vcpu.c</code></a></td>
<td>VMCSの読み書き</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/exit.c" target="_blank" rel="external"><code>exit.c</code></a></td>
<td>VMExitのハンドラ</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/um/um.c" target="_blank" rel="external"><code>um/um.c</code></a></td>
<td>ユーザーランドのエージェント</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/sandbox.c" target="_blank" rel="external"><code>sandbox.c</code></a></td>
<td>サンドボックス機能</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/introspect.c" target="_blank" rel="external"><code>introspect.c</code></a></td>
<td>イントロスペクション機能</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/epage.c" target="_blank" rel="external"><code>epage.c</code></a></td>
<td>EPTフック機能</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/mm.c" target="_blank" rel="external"><code>mm.c</code></a></td>
<td>メモリ管理</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/hotplug.c" target="_blank" rel="external"><code>hotplug.c</code></a></td>
<td>CPUホットプラグに関する処理</td>
</tr>
</tbody>
</table>
<p>　カーネルドライバをロードし，ユーザーランドのエージェントから<code>ioctl</code>を発行，サンドボックス機能またはイントロスペクション機能，EPT機能を呼び出すという流れになっている．詳細は<a href="https://github.com/asamy/ksm/blob/master/Documentation/SPEC.rst" target="_blank" rel="external"><code>Documentation/SPEC.rst</code></a>を参照のこと．</p>
<h1 id="SimpleVisor"><a href="#SimpleVisor" class="headerlink" title="SimpleVisor"></a>SimpleVisor</h1><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>リポジトリ</td>
<td><a href="https://github.com/ionescu007/SimpleVisor" target="_blank" rel="external">https://github.com/ionescu007/SimpleVisor</a></td>
</tr>
<tr>
<td>形態</td>
<td>カーネルドライバ</td>
</tr>
<tr>
<td>仮想化支援機能</td>
<td>Intel VT-x with EPT, AMD-V</td>
</tr>
<tr>
<td>サポートしている環境</td>
<td>Windows 8/8.1/10, UEFI</td>
</tr>
<tr>
<td>言語</td>
<td>C, アセンブリ言語</td>
</tr>
<tr>
<td>ライセンス</td>
<td>2 clause BSD</td>
</tr>
</tbody>
</table>
<p>　SimpleVisorは，名前の通り極力シンプルであることをめざしたハイパーバイザだ．全体で1700行程度．開発者はWindows Internalsの著者のひとりで，<a href="https://github.com/ionescu007/SimpleVisor/blob/master/README.md" target="_blank" rel="external"><code>README.md</code></a>にはこう書かれている：</p>
<blockquote>
<p>Have you always been curious on how to build a hypervisor? Has Intel’s documentation (the many hundreds of pages) gotten you down? Have the samples you’ve found online just made things more confusing, or required weeks of reading through dozens of thousands of lines and code? If so, SimpleVisor might be the project for you.</p>
</blockquote>
<p>　そういうわけで，SimpleVisorはIntel SDM (とくに，ハイパーバイザまわりは<a href="http://www.intel.co.jp/content/www/jp/ja/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3c-part-3-manual.html" target="_blank" rel="external">Vol. 3C</a>) の解読にうんざりした人向けだ．学習にはもってこい．<code>CPUID</code>, <code>INVD</code>, <code>VMX</code>, <code>XSETBV</code>のみトラップするようになっており，ネストには対応していない．しかし，XenやBochsでさえ追いついていない最新の仮想化支援機能にいちはやく追随しようとしている．<br>　主なソースコードは以下の通り：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/nt/shvos.c" target="_blank" rel="external"><code>nt/shvos.c</code></a></td>
<td>カーネルドライバのエントリポイント</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shv.c" target="_blank" rel="external"><code>shv.c</code></a></td>
<td>VMExit/VMEntryのコールバック関数の登録</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shvvp.c" target="_blank" rel="external"><code>shvvp.c</code></a></td>
<td>コールバック関数の実体，仮想CPUの初期化</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shvvmx.c" target="_blank" rel="external"><code>shvvmx.c</code></a></td>
<td>VMCSの初期化</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shvvmxhv.c" target="_blank" rel="external"><code>shvvmxhv.c</code></a></td>
<td>VMExitのハンドラ</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shvutil.c" target="_blank" rel="external"><code>shvutil.c</code></a></td>
<td>GDTの変換</td>
</tr>
</tbody>
</table>
<p>　シンプル．</p>
<h1 id="HyperPlatform"><a href="#HyperPlatform" class="headerlink" title="HyperPlatform"></a>HyperPlatform</h1><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>リポジトリ</td>
<td><a href="https://github.com/tandasat/HyperPlatform" target="_blank" rel="external">https://github.com/tandasat/HyperPlatform</a></td>
</tr>
<tr>
<td>形態</td>
<td>カーネルドライバ</td>
</tr>
<tr>
<td>仮想化支援機能</td>
<td>Intel VT-x with EPT</td>
</tr>
<tr>
<td>サポートしている環境</td>
<td>Windows 7/8.1/10</td>
</tr>
<tr>
<td>言語</td>
<td>C++, アセンブリ言語</td>
</tr>
<tr>
<td>ライセンス</td>
<td>MIT</td>
</tr>
</tbody>
</table>
<p>　HyperPlatformは，カーネルランドで動くコード，すなわちWindows向けルートキットやWindowsカーネル自体の解析を目的として開発されているハイパーバイザ．物理メモリと仮想メモリへのアクセス，関数呼び出し，命令単位のコード実行を監視できるようになっている<a href="https://recon.cx/2016/resources/slides/RECON-0xA-HyperPlatform-Satoshi.pdf" target="_blank" rel="external">[S. Tanda. REcon’16]</a>．<br>　主なソースコードは以下の通り：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/driver.cpp" target="_blank" rel="external"><code>driver.cpp</code></a></td>
<td>カーネルドライバのエントリポイント，各種コールバック関数の登録</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/log.cpp" target="_blank" rel="external"><code>log.cpp</code></a></td>
<td>ログ出力</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/global_object.cpp" target="_blank" rel="external"><code>global_object.cpp</code></a></td>
<td>グローバル変数の初期化</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/performance.cpp" target="_blank" rel="external"><code>performance.cpp</code></a></td>
<td>パフォーマンス計測</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/util.cpp" target="_blank" rel="external"><code>util.cpp</code></a></td>
<td><code>PTE_BASE</code>の取得，メモリアドレス変換，VMCALLのラッパなど</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/power_callback.cpp" target="_blank" rel="external"><code>power_callback.cpp</code></a></td>
<td>電源状態のコールバック関数</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/hotplug_callback.cpp" target="_blank" rel="external"><code>hotplug_callback.cpp</code></a></td>
<td>CPUホットプラグのコールバック関数</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/vm.cpp" target="_blank" rel="external"><code>vm.cpp</code></a></td>
<td>仮想CPUの初期化，VMCSの読み書き</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/ept.cpp" target="_blank" rel="external"><code>ept.cpp</code></a></td>
<td>EPTの構成</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/vmm.cpp" target="_blank" rel="external"><code>vmm.cpp</code></a></td>
<td>命令のトラップ，VMExitのハンドラ</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/Arch/x64/x64.asm" target="_blank" rel="external"><code>Arch/x64/x64.asm</code></a>, <a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/Arch/x86/x86.asm" target="_blank" rel="external"><code>Arch/x86/x86.asm</code></a></td>
<td>VMX命令呼び出しにともなう命令列</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/kernel_stl.cpp" target="_blank" rel="external"><code>kernel_stl.cpp</code></a></td>
<td>ntoskrnl経由でカーネルドライバからSTLを利用する</td>
</tr>
</tbody>
</table>
<p>　エントリポイントから手続き的に書き下されていて，わかりやすい．ハイパーバイザとしての機能もさることながら，STLを強引に呼び出すハックがかっこいい．<br>　この拡張例には以下がある：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/tandasat/MemoryMon" target="_blank" rel="external">MemoryMon</a></td>
<td>カーネルランドへのコード挿入を検知する</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/EopMon" target="_blank" rel="external">EopMon</a></td>
<td>マルウェアによる特権昇格攻撃を検知する</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/DdiMon" target="_blank" rel="external">DdiMon</a></td>
<td>EPTを用いたAPIフック</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/GuardMon" target="_blank" rel="external">GuardMon</a></td>
<td>PatchGuardの挙動解析</td>
</tr>
</tbody>
</table>
<p>　いずれもカーネルドライバのエントリポイントで追加機能を初期化するしくみ．<br>　やや温め納豆は遠くなりにけり．</p>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>　いずれもSandy Bridge以降のいまどきの環境であれば動作する．<br>　卒業研究ではQEMUをベースとしたマルウェア解析環境を開発していたのだけど，やはり速度面に難があるし，このあたりの技術を再検討しないとなー．<br>　なお，今回取り上げなかったハイパーバイザには以下のようなものがある：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/ainfosec/MoRE" target="_blank" rel="external">MoRE</a></td>
<td>ルートキット文脈のハイパーバイザ．やや古い</td>
</tr>
<tr>
<td><a href="https://github.com/DarthTon/HyperBone" target="_blank" rel="external">HyperBone</a></td>
<td>HyperPlatformと似た機能をもつ．やや古い</td>
</tr>
<tr>
<td><a href="https://github.com/linux-noah/noah" target="_blank" rel="external">Noah</a></td>
<td>未踏のアレ．OS X上でLinuxバイナリを動かす．MacBook持ってないので試せないのだわ</td>
</tr>
<tr>
<td><a href="https://github.com/Bareflank/hypervisor" target="_blank" rel="external">Bareflank</a></td>
<td>type 1, 2, ドライバいずれの形態のVMMもサポートしたライブラリ．しかもC++で書ける</td>
</tr>
</tbody>
</table>
<p>　なかでもBareflankがヤバいので後編ではこれを読んでいきます．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/03/04/thin-hypervisor-2017/" data-id="cjbiq70sj001q8w7tz16xkkjg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-machine-introspection/">virtual machine introspection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-xen-add-hypercall" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/09/14/xen-add-hypercall/">Xenにハイパーコールを追加する</a>
  

      </header>
    
    <time class="article-date" datetime="2015-09-14T13:00:00.000Z" itemprop="datePublished">09-14-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>いわゆるVM床抜きをXenで試す．</p>
<h1 id="Xenのインストール"><a href="#Xenのインストール" class="headerlink" title="Xenのインストール"></a>Xenのインストール</h1><p>いつかインストールしたXen 4.4.1を用いた．</p>
<ul>
<li><p>依存パッケージ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># sudo apt-get install wget git bcc bin86 gawk bridge-utils iproute libcurl3 libcurl4-openssl-dev bzip2 module-init-tools pciutils-dev build-essential make gcc libc6-dev libc6-dev-i386 linux-libc-dev zlib1g-dev python python-dev python-twisted python-gevent libncurses5-dev patch libvncserver-dev libssl-dev libsdl-dev iasl libbz2-dev e2fslibs-dev git-core uuid-dev ocaml libx11-dev bison flex ocaml-findlib xz-utils gettext libyajl-dev libpixman-1-dev libaio-dev libfdt-dev cabextract libglib2.0-dev autoconf automake libtool check libjansson-dev libfuse-dev</div></pre></td></tr></table></figure>
</li>
<li><p>Xenのビルド</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># wget http://bits.xensource.com/oss-xen/release/4.4.1/xen-4.4.1.tar.gz</div><div class="line"># tar xzvf xen-4.4.1.tar.gz</div><div class="line"># cd ./xen-4.4.1</div><div class="line"># export C_INCLUDE_PATH=/usr/include/x86_64-linux-gnu</div><div class="line"># ./configure --enable-systemd --enable-githttp</div><div class="line"># make -j4 dist-xen</div><div class="line"># make -j4 dist-tools</div></pre></td></tr></table></figure>
</li>
<li><p>DomUの設定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># sudo su</div><div class="line"># make -j4 install-xen</div><div class="line"># make -j4 install-tools</div><div class="line"># echo &quot;GRUB_CMDLINE_XEN_DEFAULT=\&quot;dom0_mem=4096M,max:4096M dom0_max_vcpus=4 dom0_vcpus_pin=true hap_1gb=false hap_2mb=false\&quot;&quot; &gt;&gt; /etc/default/grub</div><div class="line"># echo &quot;/usr/local/lib&quot; &gt; /etc/ld.so.conf.d/xen.conf</div><div class="line"># ldconfig</div><div class="line"># update-grub</div><div class="line"># echo &quot;none /proc/xen xenfs defaults,nofail 0 0&quot; &gt;&gt; /etc/fstab</div><div class="line"># echo &quot;xen-evtchn&quot; &gt;&gt; /etc/modules</div><div class="line"># echo &quot;xen-privcmd&quot; &gt;&gt; /etc/modules</div><div class="line"># update-rc.d xencommons defaults 19 18</div><div class="line"># update-rc.d xendomains defaults 21 20</div><div class="line"># update-rc.d xen-watchdog defaults 22 23</div><div class="line"># reboot</div></pre></td></tr></table></figure>
</li>
<li><p>動作確認</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># sudo xen-detect</div><div class="line">Running in PV context on Xen v4.4.</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="ハイパーコールの追加"><a href="#ハイパーコールの追加" class="headerlink" title="ハイパーコールの追加"></a>ハイパーコールの追加</h1><p>予約済みの<code>__HYPERVISOR_xc_reserved_op</code>に代わって39番目のハイパーコールを定義する．</p>
<ul>
<li><p>xen-4.4.1/xen/include/public/xen.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@@ -100,6 +100,7 @@</div><div class="line"> #define __HYPERVISOR_domctl               36</div><div class="line"> #define __HYPERVISOR_kexec_op             37</div><div class="line"> #define __HYPERVISOR_tmem_op              38</div><div class="line">+#define __HYPERVISOR_rdtsc_hypercall      39</div><div class="line"> #define __HYPERVISOR_xc_reserved_op       39 /* reserved for XenClient */</div><div class="line"></div><div class="line"> /* Architecture-specific hypercall definitions. */</div></pre></td></tr></table></figure>
</li>
<li><p>xen-4.4.1/xen/arch/x86/x86_64/entry.S</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@@ -757,6 +757,7 @@</div><div class="line">         .quad do_domctl</div><div class="line">         .quad do_kexec_op</div><div class="line">         .quad do_tmem_op</div><div class="line">+        .quad do_rdtsc_hypercall</div><div class="line">         .rept __HYPERVISOR_arch_0-((.-hypercall_table)/8)</div><div class="line">         .quad do_ni_hypercall</div><div class="line">         .endr</div><div class="line">@@ -805,6 +806,7 @@</div><div class="line">         .byte 1 /* do_domctl            */</div><div class="line">         .byte 2 /* do_kexec             */</div><div class="line">         .byte 1 /* do_tmem_op           */</div><div class="line">+        .byte 1 /* do_rdtsc_hypercall   */</div><div class="line">         .rept __HYPERVISOR_arch_0-(.-hypercall_args_table)</div><div class="line">         .byte 0 /* do_ni_hypercall      */</div><div class="line">         .endr</div></pre></td></tr></table></figure>
</li>
<li><p>xen-4.4.1/xen/include/asm-x86/hypercall.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@@ -110,4 +110,8 @@</div><div class="line"> arch_compat_vcpu_op(</div><div class="line">     int cmd, struct vcpu *v, XEN_GUEST_HANDLE_PARAM(void) arg);</div><div class="line"></div><div class="line">+extern int</div><div class="line">+do_rdtsc_hypercall(</div><div class="line">+    char* str);</div><div class="line">+</div><div class="line"> #endif /* __ASM_X86_HYPERCALL_H__ */</div></pre></td></tr></table></figure>
</li>
<li><p>xen-4.4.1/xen/arch/x86/traps.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@@ -3762,6 +3762,14 @@</div><div class="line">     __domain_crash_synchronous();</div><div class="line"> &#125;</div><div class="line"></div><div class="line">+int do_rdtsc_hypercall(char* str)</div><div class="line">+&#123;</div><div class="line">+    unsigned long long tsc;</div><div class="line">+    __asm__ volatile(&quot;rdtsc&quot; : &quot;=A&quot; (tsc));</div><div class="line">+    printk(&quot;str: %s, tsc: %llu\n&quot;, str, tsc);</div><div class="line">+    return 0;</div><div class="line">+&#125;</div><div class="line">+</div><div class="line"> /*</div><div class="line">  * Local variables:</div><div class="line">  * mode: C</div></pre></td></tr></table></figure>
</li>
</ul>
<p>このハイパーコールは引数として受け取った文字列をTSCの値とともにコンソールログに出力する．有効化するには再度<code>make -j4 dist-xen</code>して再起動するとよい．</p>
<h1 id="ハイパーコールの呼び出し"><a href="#ハイパーコールの呼び出し" class="headerlink" title="ハイパーコールの呼び出し"></a>ハイパーコールの呼び出し</h1><p>ハイパーコールの呼び出しはlibxcやlibxlによって抽象化されているが，ここではそれらが内部で参照している/proc/xen/privcmdに対してioctlを発行してみる．</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// rdtsc_hypercall.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;xenctrl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;xen/sys/privcmd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>)</div><div class="line">    &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"input the param"</span>);</div><div class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">char</span> *message = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*(<span class="built_in">strlen</span>(argv[<span class="number">1</span>])+<span class="number">1</span>));</div><div class="line">    <span class="built_in">strcpy</span>(message, argv[<span class="number">1</span>]);</div><div class="line"></div><div class="line">    <span class="keyword">privcmd_hypercall_t</span> my_hypercall = &#123;</div><div class="line">            <span class="number">39</span>, <span class="comment">// __HYPERVISOR_rdtsc_hypercall</span></div><div class="line">            &#123;(__u64)message, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/xen/privcmd"</span>, O_RDWR);</div><div class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"cannot open /proc/xen/privcmd"</span>);</div><div class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(!ioctl(fd, IOCTL_PRIVCMD_HYPERCALL, &amp;my_hypercall))</div><div class="line">    &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"cannot call do_rdtsc_hypercall"</span>);</div><div class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>このプログラムを実行するとハイパーコールが呼び出されたことが分かる．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># gcc -o rdtsc_hypercall rdtsc_hypercall.c</div><div class="line"># sudo ./rdtsc_hypercall test</div><div class="line"># sudo xl dmesg | less</div><div class="line">(XEN) str: test, tsc: 2835883086</div></pre></td></tr></table></figure>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>Xenに追加したハイパーコールを呼び出すことができた．<br>さしあたってはMirage OSからこのハイパーコールを呼び出す方法を知りたいのだが．</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li>“C77 - paravirt.org - circle,” <a href="http://circle.paravirt.org/c77" target="_blank" rel="external">http://circle.paravirt.org/c77</a></li>
<li>“笑遍世界 &gt;&gt; Xen添加一个hypercall,” <a href="http://smilejay.com/2012/05/xen_hypercall/" target="_blank" rel="external">http://smilejay.com/2012/05/xen_hypercall/</a></li>
<li>“Making a New Hypercall &amp;&amp; Invoking It from userland via Privcmd | Sanity of Fortunate Fool” <a href="http://sanifool.com/2013/02/08/invoking-an-hypercall-from-userland-via-privcmd/" target="_blank" rel="external">http://sanifool.com/2013/02/08/invoking-an-hypercall-from-userland-via-privcmd/</a></li>
<li>“CPUクロックに基づく相対時刻の計測,” <a href="http://www.02.246.ne.jp/~torutk/cxx/clock/cpucounter.html" target="_blank" rel="external">http://www.02.246.ne.jp/~torutk/cxx/clock/cpucounter.html</a></li>
<li>“libxenctrlのメモ - はわわーっ,” <a href="http://yomi322.hateblo.jp/entry/2015/02/19/235522" target="_blank" rel="external">http://yomi322.hateblo.jp/entry/2015/02/19/235522</a></li>
<li>“libxenctrlのメモ #2 - はわわーっ,” <a href="http://yomi322.hateblo.jp/entry/2015/02/20/212853" target="_blank" rel="external">http://yomi322.hateblo.jp/entry/2015/02/20/212853</a></li>
<li>“xenのハイパーコールを呼んでみる - はわわーっ,” <a href="http://yomi322.hateblo.jp/entry/2015/02/21/145334" target="_blank" rel="external">http://yomi322.hateblo.jp/entry/2015/02/21/145334</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2015/09/14/xen-add-hypercall/" data-id="cjbiq70sn001x8w7txproq83m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-machine-introspection/">virtual machine introspection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-automated-malware-analysis-using-decaf-in-seccamp15" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/08/16/automated-malware-analysis-using-decaf-in-seccamp15/">DECAFによるマルウェア自動解析</a>
  

      </header>
    
    <time class="article-date" datetime="2015-08-16T09:00:00.000Z" itemprop="datePublished">08-16-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>2015.08.11~15にわたって開催された<a href="https://www.ipa.go.jp/jinzai/camp/2015/zenkoku2015.html" target="_blank" rel="external">セキュリティ・キャンプ全国大会 2015</a>に解析トラックの講師として参加した．講義では「仮想化技術を用いてマルウェア解析」と題して，QEMUをベースに開発が行われている<a href="https://github.com/sycurelab/DECAF" target="_blank" rel="external">DECAF</a>という解析プラットフォームを用いて演習を行った．</p>
<h1 id="講義資料"><a href="#講義資料" class="headerlink" title="講義資料"></a>講義資料</h1><script async class="speakerdeck-embed" data-id="11c7632b9b844e199ac966e4494a1dd2" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>

<h1 id="講義内容"><a href="#講義内容" class="headerlink" title="講義内容"></a>講義内容</h1><p>演習では実際のマルウェアに用いられている解析妨害機能を備えたサンプルプログラムを扱った．素のDECAFには解析妨害機能への対策が施されていない．そこで，受講者にはDECAFのプラグインを拡張し，対策手法を実装して頂いた．<br>演習で用いたプログラムはGitHub上で公開している．</p>
<ul>
<li>解析妨害機能を備えたサンプルプログラム<ul>
<li><a href="https://github.com/ntddk/blue" target="_blank" rel="external">ntddk/blue</a></li>
</ul>
</li>
<li>DECAFプラグインのひな形<ul>
<li><a href="https://github.com/ntddk/geteip" target="_blank" rel="external">ntddk/geteip</a></li>
</ul>
</li>
</ul>
<p>ひな形にある通り，IsDebuggerPresent()をフックするDECAFプラグインは以下のように書ける．</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> DECAF_Handle isdebuggerpresent_handle = DECAF_NULL_HANDLE;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">        <span class="keyword">uint32_t</span> call_stack[<span class="number">1</span>]; <span class="comment">//paramters and return address</span></div><div class="line">        DECAF_Handle hook_handle;</div><div class="line">&#125; IsDebuggerPresent_hook_context_t;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * BOOL IsDebuggerPresent(VOID);</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">IsDebuggerPresent_ret</span><span class="params">(<span class="keyword">void</span> *param)</span></span></div><div class="line">&#123;</div><div class="line">        IsDebuggerPresent_hook_context_t *ctx = (IsDebuggerPresent_hook_context_t *)param;</div><div class="line">        hookapi_remove_hook(ctx-&gt;hook_handle);</div><div class="line">        DECAF_printf(<span class="string">"EIP = %08x, EAX = %d\n"</span>, cpu_single_env-&gt;eip, cpu_single_env-&gt;regs[R_EAX]);</div><div class="line">        <span class="built_in">free</span>(ctx);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">IsDebuggerPresent_call</span><span class="params">(<span class="keyword">void</span> *opaque)</span></span></div><div class="line">&#123;</div><div class="line">        DECAF_printf(<span class="string">"IsDebuggerPresent "</span>);</div><div class="line">        IsDebuggerPresent_hook_context_t *ctx = (IsDebuggerPresent_hook_context_t*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(IsDebuggerPresent_hook_context_t));</div><div class="line">        <span class="keyword">if</span>(!ctx) <span class="keyword">return</span>;</div><div class="line">        DECAF_read_mem(<span class="literal">NULL</span>, cpu_single_env-&gt;regs[R_ESP], <span class="number">4</span>, ctx-&gt;call_stack);</div><div class="line">        ctx-&gt;hook_handle = hookapi_hook_return(ctx-&gt;call_stack[<span class="number">0</span>], IsDebuggerPresent_ret, ctx, <span class="keyword">sizeof</span>(*ctx));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">geteip_loadmainmodule_callback</span><span class="params">(VMI_Callback_Params* params)</span></span></div><div class="line">&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(params-&gt;cp.name,targetname) == <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">                DECAF_printf(<span class="string">"Process %s you spcecified starts \n"</span>, params-&gt;cp.name);</div><div class="line">                target_cr3 = params-&gt;cp.cr3;</div><div class="line">                isdebuggerpresent_handle = hookapi_hook_function_byname(<span class="string">"kernel32.dll"</span>, <span class="string">"IsDebuggerPresent"</span>, <span class="number">1</span>, target_cr3, IsDebuggerPresent_call, <span class="literal">NULL</span>, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>現在のプロセスがデバッガのコンテキストで実行されていない場合，IsDebuggerPresent()は0を返す．ここで，IsDebuggerPresent()の戻り値を0にするには，モジュール（この場合はkernel32.dll）から戻る段階でeaxを書き換えてやればよい．</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">IsDebuggerPresent_ret</span><span class="params">(<span class="keyword">void</span> *param)</span></span></div><div class="line">&#123;</div><div class="line">        IsDebuggerPresent_hook_context_t *ctx = (IsDebuggerPresent_hook_context_t *)param;</div><div class="line">        hookapi_remove_hook(ctx-&gt;hook_handle);</div><div class="line">        cpu_single_env-&gt;regs[R_EAX] = <span class="number">0</span>; <span class="comment">// 追加</span></div><div class="line">        DECAF_printf(<span class="string">"EIP = %08x, EAX = %d\n"</span>, cpu_single_env-&gt;eip, cpu_single_env-&gt;regs[R_EAX]);</div><div class="line">        <span class="built_in">free</span>(ctx);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>このようにDECAFのプラグインを書くことで，ゲストOSに解析用のエージェントを挿入することなくAPIの戻り値を書き換えることができる．<br>APIの引数を書き換えたい場合はモジュールに入る段階でコンテキスト構造体の<code>call_stack[]</code>を書き換えてやればよい．</p>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>受講者にサンドボックス開発の楽しさと難しさを実感してもらえたなら，講師として冥利に尽きる．<br>サンプルプログラムには4種類の解析妨害機能を実装しており，APIフックで対処できるのはうち前半2つだけとなっている．限られた演習時間の制約上，3つ目以降の解析妨害機能を回避できた受講者はいなかった．解析トラックリーダーの岩村さんから，受講者の2割がギリギリ解けないような問題を作るようにと仰せつかっていたが，やや意地悪な問題設定だったと思う．<br>なお，今回は拙作のサンプルを用いたが，より多くの解析妨害機能を備えたOSSに<a href="https://github.com/a0rtega/pafish" target="_blank" rel="external">pafish</a>がある．pafishはBackdoor.Win32.Agent.dkbp(MD5: de1af0e97e94859d372be7fcf3a5daa5)など一部のマルウェアに流用されている．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2015/08/16/automated-malware-analysis-using-decaf-in-seccamp15/" data-id="cjbiq70rw000a8w7tzoiv3laz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dynamic-binary-translation/">dynamic binary translation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/taint-analysis/">taint analysis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-machine-introspection/">virtual machine introspection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pin-to-pemu" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/04/03/pin-to-pemu/">PinからPEMUへ</a>
  

      </header>
    
    <time class="article-date" datetime="2015-04-03T11:45:00.000Z" itemprop="datePublished">04-03-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Dynamic-Binary-Instrumentation"><a href="#Dynamic-Binary-Instrumentation" class="headerlink" title="Dynamic Binary Instrumentation"></a>Dynamic Binary Instrumentation</h1><p>Dynamic Binary Instrumentation(DBI)とは，実行中のプログラムにコードを挿入する技術である．<br>その目的は，プログラムの性能評価であったり，アーキテクチャのシミュレーションであったり，プログラムのデバッグであったり，プログラムのsheparding（ポリシを用いたセキュリティ制限）であったり，プログラムの最適化であったり，テイント解析などのデータフロー解析であったり，リバースエンジニアリングであったり，マルウェア解析であったり，……と多岐にわたっている．<br>デバッガとDBIを区別することは難しく，ニュアンスの問題になってしまうが，DBIはより「挿入するコードがプログラマブルであること」を重視している．また，instrumentation（名詞）/instrument（動詞）という語は，コードの挿入を通してプログラムの情報を取得したり，プログラムを制御したりといったニュアンスを含んでいる．<br>DBIのメリットとして，言語に依存しないこと，古いソフトウェアに対しても適用できること，再コンパイルの必要がないこと，動的に生成されるコードを扱うことができること，実行中のプロセスにアタッチできることが挙げられる．</p>
<h1 id="Pin"><a href="#Pin" class="headerlink" title="Pin"></a>Pin</h1><p>Intelによって開発されている<a href="https://software.intel.com/en-us/articles/pin-a-dynamic-binary-instrumentation-tool" target="_blank" rel="external">Pin</a>は，DBIフレームワークの中でも最も成功している一つであり，そのAPIの数は450種類を越える．<br>Pinにおけるinstrumentationの手法は，コードの実行時にinstrumentするjust-in-time Instrumentation(JITI)と，イメージ（実行ファイルや共有ライブラリ，構造体）のロード時にinstrumentするahead-of-time-insturumentation(AOTI)の二種類に大別される．<br>これらのinstrumentにあたって，Pinは解析対象のプログラムにpinvm.dllを挿入する．</p>
<h2 id="JITI"><a href="#JITI" class="headerlink" title="JITI"></a>JITI</h2><p>JIITは以下の三種類を単位として行うことができる．</p>
<h3 id="Instruction-Level"><a href="#Instruction-Level" class="headerlink" title="Instruction Level"></a>Instruction Level</h3><p>第一に，最も低い粒度として，命令単位のinstrumentationがサポートされている．<br>これは，<code>INS_AddInstrumentFunction</code>のコールバックとして実現される．関連するAPIは，Pin 2.1.3の時点で142種類存在する．</p>
<h3 id="Basic-Block-Level-BBL"><a href="#Basic-Block-Level-BBL" class="headerlink" title="Basic Block Level(BBL)"></a>Basic Block Level(BBL)</h3><p>第二に，Basic Block(BB)単位のinstrumentationがサポートされている．<br>ここでのBBとは，一つの入口と一つの出口を持ち，内部に分岐を含まない命令列のことであり，コンパイラ最適化におけるそれと同義である．Pinでは，<code>BBL_InsHead</code>や<code>BBL_InsTail</code>，<code>BBL_Next</code>や<code>BBL_Prev</code>といった関数を用いてBBの有向グラフを操作することができる．一方で<code>BBL_AddInstrumentationFunction</code>のコールバックは<strong>存在しない</strong>．関連するAPIは，Pin 2.1.3の時点で14種類存在する．</p>
<h3 id="Trace-Level"><a href="#Trace-Level" class="headerlink" title="Trace Level"></a>Trace Level</h3><p>第三に，Trace単位のinstrumentationがサポートされている．<br>Traceとは，Pin独自の単位であり，分岐命令を入り口とし，無条件分岐（<code>jmp</code>, <code>call</code>, <code>ret</code>など）を出口とする命令列のことである．つまり，Traceは<strong>複数のBBを含みうる</strong>．これは，<code>TRACE_AddInstrumentFunction</code>のコールバックとして実現される．関連するAPIは，Pin 2.1.3の時点で14種類存在する．<br>Pinでは，objdumpなどと同様に線型分析法によってバイナリを逆アセンブルし，Traceを取得する．ここで，JITIに用いるVMをトラップすることなく別のTraceに分岐を行うための<a href="http://www.cs.virginia.edu/kim/courses/cs851/papers/luk05pin.pdf" target="_blank" rel="external">trace-linking optimization[PDF]</a>が行われる．そのため，Trace単位のinstrumentationが命令単位のinstrumentationよりも高速になる場合がある．</p>
<h2 id="AOTI"><a href="#AOTI" class="headerlink" title="AOTI"></a>AOTI</h2><p>AOTIは以下の二種類を単位として行うことができる．</p>
<h3 id="IMG-instrumentation"><a href="#IMG-instrumentation" class="headerlink" title="IMG instrumentation"></a>IMG instrumentation</h3><p>第一に，IMG単位のinstrumentationがサポートされている．<br>IMGは，特定の実行ファイルないし共有ライブラリ，構造体に相当する単位である．これは，<code>IMG_AddInstrumentFunction</code> APIによって実現される．また，IMGのセクション(SEC)についてもinstrumentを行うことができる．関連するAPIは，IMGについて27種類，SECについて16種類が存在する．</p>
<h3 id="RTN-instrumentation"><a href="#RTN-instrumentation" class="headerlink" title="RTN instrumentation"></a>RTN instrumentation</h3><p>第二に，RTN単位のinstrumentationがサポートされている．<br>RTNとは関数(Routine)に相当する単位である．これは，<code>RTN_AddInstrumentFunction</code> APIによって実現される．関連するAPIは，Pin 2.1.3の時点で39種類存在する．</p>
<h2 id="Transparency"><a href="#Transparency" class="headerlink" title="Transparency"></a>Transparency</h2><p>このように様々な機能を備えるPinだが，マルウェア解析においてはどれほど有用なのだろうか．<br>Pinのinstrumentationは，素朴なDLLインジェクションによって成り立っており，Anti-Debuggingについては考えられていない．そのためPinは，親プロセス，引数，ロードされるpinvm.dll, エクスポート関数である<code>CharmVersionC</code>, <code>ZwAllocateVirtualMemory</code>の実行権限，<code>KiUserApcDispatcher</code>, <code>KiUserCallbackDispatcher</code>, <code>KiUserExceptionDispatcher</code>, <code>LdrInitializeThunk</code>のインラインフック，命令のパターン，セクション名，<code>FSTENV</code>命令，<code>FSAVE</code>命令，<code>FXSAVE</code>命令，……といった様々な要素から検出される危険性を孕んでいる．<br>これらは，<a href="http://corelabs.coresecurity.com/index.php?module=Wiki&amp;action=view&amp;type=tool&amp;name=eXait" target="_blank" rel="external">eXait</a>を用いてテストできる．なお，筆者の環境では<code>int2e</code>/<code>SYSENTER</code>についてfalse positiveが発生した．<br>Pinを検出するマルウェアの存在は寡聞にして知らないが，Pinをマルウェア解析に用いるのであれば，現状の構造は不適切である．<br>Anti-Debuggingのイタチごっこから脱するためには，エージェントをゲストOSに挿入するin-VMではなく，エージェントをゲストOSに挿入しないout-of-VMな解析環境でなければならない．</p>
<h1 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h1><p>さらにPinにはカーネルへのinstrumentationが不可能であるという欠点が存在する．<br>翻って<a href="https://github.com/qemu/qemu" target="_blank" rel="external">QEMU</a>は，フルシステムエミュレーションを行うため，アーキテクチャに依存することなくカーネルへのinstrumentationを行うことができる．しかしながら，QEMUのソースコードは難解であり，PinのようにユーザーフレンドリーなAPIが提供されていない．QEMUはC言語によるメタプログラミングとオブジェクト指向の良質なサンプルであるとも言えるが，できることなら避けて通りたい道である．</p>
<h1 id="TEMU"><a href="#TEMU" class="headerlink" title="TEMU"></a>TEMU</h1><p>QEMUにテイント解析機能を搭載し，これまで多くの研究で用いられてきた<a href="http://bitblaze.cs.berkeley.edu/temu.html" target="_blank" rel="external">TEMU</a>は，QEMUのソースコードを理解するための労力を削減することに成功した（と，後述するPEMUの論文にすら書かれている）が，APIの充実度はPinに劣っている．また，カーネルモジュールをゲストOSに挿入する必要があり，マルウェアから検出される可能性があること，いまや時代遅れのQEMU 0.9.1をベースとしていることから，現代的なマルウェア解析環境の候補からは外れつつある．<br>後継の<a href="https://github.com/sycurelab/DECAF" target="_blank" rel="external">DECAF</a>はQEMU 1.0.0をベースとしており，カーネルモジュールを必要としないものの，APIの充実度はTEMUと変わらない．</p>
<h1 id="PEMU"><a href="#PEMU" class="headerlink" title="PEMU"></a>PEMU</h1><p>こうした流れを汲んで開発されたのが，VEE’15にて新たに発表された<a href="https://github.com/utds3lab/pemu" target="_blank" rel="external">PEMU</a>である．嬉しい事にオープンソースとして提供されている．<br>Pinはin-VMであり，マルウェアの解析やカーネルへのinstrumentationに適さない．QEMUやTEMUはout-of-VMだが，Pinほど充実したAPIを用いることができない．そこでPEMUは，両者の利点と欠点を踏まえた上で，以下の四点を目的として開発された．</p>
<ol>
<li>Rich APIs<ul>
<li>Pinの既存APIをそのまま流用できること</li>
</ul>
</li>
<li>Cross-OS<ul>
<li>WindowsとLinuxをサポート</li>
</ul>
</li>
<li>Strong Isolation<ul>
<li>ゲストOSのRing 3やRing 0ではなく，out-of-VM(Ring -1)から監視(VM Introspection)を行うこと</li>
</ul>
</li>
<li>VM Introspection<ul>
<li>ゲストOSのプロセスやカーネルのセマンティクス情報を取得するAPIを提供すること</li>
</ul>
</li>
</ol>
<p>これらを達成するため，PEMUはQEMUの動的バイナリ変換器Tiny Code Generator(TCG)に手を加えてPin APIのサポートを追加した．</p>
<h2 id="Instrumentation-Engine"><a href="#Instrumentation-Engine" class="headerlink" title="Instrumentation Engine"></a>Instrumentation Engine</h2><p>さて，PEMUにおけるinstrumentationはどのようになっているのだろうか．<br>問題となるのは，QEMUとPinとの差異である．QEMUは命令とBB単位でしかinstrumentできず，PinにおけるTrace単位をサポートしていない．また，PEMUのベースとなっているQEMU 1.5.3では，BBの数が640までと制限されている．<br>そこで，PEMUではBBとTraceを対応付けるTRACE Constructorと，PinのAPIを通じてinstrumentするCode Injectorが導入された．</p>
<h3 id="TRACE-Constructor"><a href="#TRACE-Constructor" class="headerlink" title="TRACE Constructor"></a>TRACE Constructor</h3><p>TRACE Constructorは，複数のBBを組み合わせてTraceの単位に抽象化するものである．<br>まずXED2ライブラリを用いて，ゲストの実行前にQEMUでBBの先頭から条件分岐命令まで逆アセンブルを行う(<code>/target-i386/PEMU/DISAS.c</code>)．スワップされたか，ロードされていない命令については，ページフォルトを通じて取得する．さらに，コードを挿入する命令の位置をglobal hooking point hash-table(HPHT)にキャッシュする(<code>/target-i386/PEMU/hashTable.c</code>)．<br>ここにおけるアルゴリズムは以下のようになっている．</p>
<p><img src="/image/pemu_algorithm.png"></p>
<p>まず，Trace単位の開始アドレスであるPCの度にXED2を呼び出し，PCをTPCという保存領域に保存する．次に，全命令を逆アセンブルし，命令単位のinstrumentationが必要な場合はそのアドレスをHPHTに保存する．さらに，無条件分岐の度にBBとTraceを対応付け，BB単位のinstrumentationが必要な場合はそのアドレスをHPHTに保存する．そして，新しいBBを割り当て，次のTrace単位が始まるアドレスを探す．Trace単位のinstrumentationが必要な場合はそのアドレスをHPHTに保存する．そして，さらなるTraceを逆アセンブルしていくといった仕組みになる．</p>
<h3 id="Code-Injector"><a href="#Code-Injector" class="headerlink" title="Code Injector"></a>Code Injector</h3><p>TraceとBBの対応が取れた後は，QEMUのTCGが提供する<code>tcg_gen_helper</code>を用いてHPHTを参照し，instrumentを行えばよい（<code>/target-i386/PEMU/pemu_hook_helper.c</code>）．<br>IMGやSEC単位のinstrumentは<code>malloc</code>などの引数を確認する（セマンティクス情報を復元する）ことで実現している．<br>全体像は以下のようになる．</p>
<p><img src="/image/pemu_engine.png"></p>
<h2 id="Introspection-Engine"><a href="#Introspection-Engine" class="headerlink" title="Introspection Engine"></a>Introspection Engine</h2><p>PEMUでは，Page Global Directory(PGD)とCR3レジスタの対応を用いてプロセスの識別を行う(<code>target-i386/PEMU/pemu_helper.h</code>)．ここでは，プロセス作成時に発生するCR3レジスタへの<code>MOV</code>を検出して利用する．終了したプロセスのCR3は再利用されるため，プロセスの終了を検出する必要があるが，これは<code>exit</code> syscallを監視することで実現できる．スレッドは，kernel stack pointerのマスクから識別する．<br>ゲストとのセマンティックギャップの解決にあたっては，一時的にゲストを停止してシステムコールを挿入する手法を用いる．<code>PEMU_</code>というprefixでsyscallに相当するAPIが提供され，<code>getpid</code>, <code>gettimeofday</code>などゲストOSの情報を取得するためのAPI 28種類と，<code>open</code>, <code>fstat</code>, <code>lseek</code>などゲストOSを操作するためのAPI 15種を用いることができる．これらは都度レジスタコンテキストの退避と復元を伴って実行される．</p>
<h2 id="評価"><a href="#評価" class="headerlink" title="評価"></a>評価</h2><p>論文での性能評価では，32-bit Ubuntu 12.04(Linux kernel 3.0.0-31-generic-pae)をホストとし，Intel Core i7, メモリ8GBのマシンが用いられた．速度の評価には32-bit Ubuntu 11.04(Linux kernel 2.6.38-8-generic)がゲストとして用いられた．<br>その結果として，PEMUではQEMUよりも4.33倍，Pinよりも83.61倍のオーバーヘッドが生じることが明らかになっている．</p>
<p><img src="/image/pemu_performance.png"></p>
<p>また，eXaitを用いた検出テストのため，Windows XP 32bitがゲストとして用いられた．論文ではeXaitの17手法全てがPinを検出した一方で，いずれの手法もPEMUを検出することができなかった．</p>
<h2 id="関連研究"><a href="#関連研究" class="headerlink" title="関連研究"></a>関連研究</h2><p>PEMUがQEMUにPin APIのサポートを追加したのに対して，<a href="http://dl.acm.org/citation.cfm?id=1254830" target="_blank" rel="external">PinOS</a>はXenにPin APIのサポートを追加した．だがPinOSのinstrumentationは貧弱であり，セマンティクス情報を取得するAPIが提供されていない．また，解析ルーチンがカーネルや解析対象からアクセスできるため，isolationとして不十分である．<br>また，PinOS以外にカーネルへのinstrumentationをサポートしている<a href="https://github.com/DynamoRIO/drk" target="_blank" rel="external">DRK</a>は，LKMとして実装されているため，in-VMな手法に留まっている．</p>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>こうして，Pin APIを用いてout-of-VMにマルウェアを解析するための道標が示された．<br>今後のPEMUを用いた研究に期待したい，と他人事のように言っている場合ではなく，そろそろ論文を書かなければ．</p>
<h1 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h1><p>PEMUは新しいといえどQEMU 1.5.3をベースとしており，やがてはQEMU 0.9.1をベースとしているTEMUのように技術的負債となるだろう．<br>そこで，PEMUを<a href="https://github.com/ntddk/pemu" target="_blank" rel="external">forkし</a>，<a href="https://github.com/ntddk/pemu/commit/af5bf0b7a3efcbb7c4b21abbfba0da02f034f95a" target="_blank" rel="external">QEMU 1.5.3からQEMU 2.2.1にアップデートを試みた</a>．が，QEMU 2.2.1に至るまで<code>cpu_single_env</code>変数が廃止されたことと，謎のコンパイルエラーが発生することから頓挫中である．そのうち何とかする．</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li>Chi-Keung Luk, Robert Cohn, Robert Muth, Harish Patil, Artur Klauser, Geoff Lowney, Steven Wallace, Vijay Janapa Reddi and Kim Hazelwood,<br>“<a href="http://www.cs.virginia.edu/kim/courses/cs851/papers/luk05pin.pdf" target="_blank" rel="external">Pin: building customized program analysis tools with dynamic instrumentation[PDF]</a>,”<br>In Proceedings of the 2005 ACM SIGPLAN conference on Programming language design and implementation, PLDI’05, pp. 190–200, 2005.</li>
<li>Francisco Falcón, Nahuel Riva,<br>“<a href="http://recon.cx/2012/schedule/events/216.en.html" target="_blank" rel="external">Dynamic Binary Instrumentation Frameworks: I know you’re there spying on me</a>,”<br>RECon 2012.</li>
<li>Junyuan Zeng, Yangchun Fu, and Zhiqiang Lin,<br>“<a href="http://dl.acm.org/citation.cfm?id=2731201" target="_blank" rel="external">PEMU: A Pin Highly Compatible Out-of-VM Dynamic Binary Instrumentation Framework</a>,”<br>In Proceedings of the 11th ACM SIGPLAN/SIGOPS International Conference on Virtual Execution Environments, pp. 147-160, VEE’15, 2015.</li>
<li>Prashanth P. Bungale, Chi-Keung Luk,<br>“<a href="http://dl.acm.org/citation.cfm?id=1254830" target="_blank" rel="external">PinOS: a programmable framework for whole-system dynamic instrumentation</a>,”<br>In Proceedings of the 3rd international conference on Virtual execution environments, VEE’07, pp. 137-147, 2007.</li>
<li>Peter Feiner, Angela Demke, and Ashvin Goel,<br>“<a href="http://dl.acm.org/citation.cfm?id=2150992" target="_blank" rel="external">Comprehensive Kernel Instrumentation via Dynamic Binary Translation</a>,”<br>In Proceedings of the 17th international conference on Architectural Support for Programming Languages and Operating Systems, ASPLOS’12, pp. 135-146, 2012.</li>
<li>Yangchun Fu, Junyuan Zeng, and Zhiqiang Lin,<br>“<a href="https://www.usenix.org/conference/atc14/technical-sessions/presentation/fu" target="_blank" rel="external">HYPERSHELL: A Practical Hypervisor Layer Guest OS Shell for Automated In-VM Management</a>,”<br>In Proceedings of the 2014 USENIX conference on USENIX Annual Technical Conference, USENIX ATC’14, pp. 85-96, 2014.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2015/04/03/pin-to-pemu/" data-id="cjbiq70s900158w7trmxg1w2a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dynamic-binary-translation/">dynamic binary translation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/taint-analysis/">taint analysis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-machine-introspection/">virtual machine introspection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sandbox-transparency-in-the-wild" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/03/14/sandbox-transparency-in-the-wild/">続・サンドボックスの透明性</a>
  

      </header>
    
    <time class="article-date" datetime="2015-03-14T12:00:00.000Z" itemprop="datePublished">03-14-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="耐解析機能の分類"><a href="#耐解析機能の分類" class="headerlink" title="耐解析機能の分類"></a>耐解析機能の分類</h1><p><a href="https://twitter.com/gabrielnb" target="_blank" rel="external">Gabriel N. Barbosa</a>と<a href="https://twitter.com/BSDaemon" target="_blank" rel="external">Rodrigo R. Branco</a>は，マルウェアの耐解析機能を<strong>Anti-Debugging, Anti-Disassembly, Obfuscation, Anti-VM</strong>の四種類に分類した．彼らはIntelのセキュリティ研究者であり，マルウェアに備わった耐解析機能の統計を過去二回に渡って発信してきた．<br>気になるのは，サンドボックスの実装にあたって問題となるAnti-VMだ．8,103,167もの検体を用いた調査によると，その内訳は以下のようになっている．</p>
<p><img src="/image/anti-vm.jpg" title="" prevalent="" characteristics="" in="" modern="" malware"より"=""></p>
<p>これらはいずれもVMware社製品を検出するための手法である．残念ながら他の仮想マシンモニタについての情報は掲載されて<strong>いない</strong>．</p>
<h1 id="仮想マシンモニタの分類"><a href="#仮想マシンモニタの分類" class="headerlink" title="仮想マシンモニタの分類"></a>仮想マシンモニタの分類</h1><p><a href="http://ntddk.github.io/2015/01/23/sandbox-transparency/">以前にも少しばかり述べた</a>，サンドボックスの透明性(transparency)に関する話を蒸し返そう．<br>サンドボックスにOut-of-the-boxなVMIを採用すれば，少なくともAnti-Debuggingについては無視できる．<br>では，サンドボックスにXenを用いれば，QEMUより検出されにくくなるだろうか．あるいは，その逆はどうだろうか．<br>多くの研究者が好き勝手なことを言っているが，仮想マシンモニタの実現手法をもってサンドボックスの透明性を語るのは些か性急だろう．なぜなら，サンドボックスの透明性はその設計ではなくマルウェアの実装によって左右されるからだ．<strong>Out-of-the-box VMIは設計の話だが，Anti-VMは実装の話だ</strong>（と思う）．<br>ところで私は，仮想マシンモニタの実現手法を「プロセッサ拡張によるもの」と「バイナリ変換によるもの」に分類していたが，別の分類方法を見つけた．</p>
<p><img src="/image/vm-class.png" title="" a="" survey="" of="" security="" issues="" in="" hardware="" virtualization"より"=""></p>
<p>命令セットアーキテクチャを基準に分類することで，より分かりやすくなっている．今後はこの図に準拠したい．<br>話を戻そう．<br>何が言いたいのかというと，in-the-wildなマルウェアに備わったAnti-VMの内訳が分からないことには，サンドボックスの透明性について云々することはできないということだ．</p>
<h1 id="検体"><a href="#検体" class="headerlink" title="検体"></a>検体</h1><p>誰もやっていないようなので，調べてみることにした．<br>やや恣意的（誤用？）な選択だが，今回は<a href="http://virusshare.com/" target="_blank" rel="external">VirusShare.com</a>からCitadelのバリアント479検体や，Mandiantの<a href="http://intelreport.mandiant.com/Mandiant_APT1_Report.pdf" target="_blank" rel="external">APT1レポート</a>にて報告された中国軍総参謀部第三部第二局こと61398部隊<strong>と思しき</strong>グループ製の874検体を含む<strong>総計33,260検体</strong>を用いた．</p>
<h1 id="Anti-VMの実態"><a href="#Anti-VMの実態" class="headerlink" title="Anti-VMの実態"></a>Anti-VMの実態</h1><p><a href="http://plusvic.github.io/yara/" target="_blank" rel="external">YARA</a>を用いてAnti-VMの実態を調べた．<br>ルールには公式の<a href="http://yararules.com/rules/antidebug.yar" target="_blank" rel="external">antidebug.yar</a>を用いた．なお，このルールにはAnti-VMのみならずAnti-Debuggerについても記載されている．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"># awk &apos;&#123; print $1&#125;&apos; yara.log | sort | uniq -c | sort -r</div><div class="line">  20340 DebuggerPattern__RDTSC</div><div class="line">  18966 DebuggerPattern__CPUID</div><div class="line">   9292 DebuggerTiming__Ticks</div><div class="line">   7371 DebuggerPattern__SEH_Inits</div><div class="line">   6955 DebuggerException__UnhandledFilter</div><div class="line">   5715 DebuggerTiming__PerformanceCounter</div><div class="line">   4377 DebuggerPattern__SEH_Saves</div><div class="line">   2949 DebuggerCheck__API</div><div class="line">   2631 DebuggerCheck__QueryInfo</div><div class="line">   2182 SEH__vba</div><div class="line">   1315 DebuggerOutput__String</div><div class="line">    887 ThreadControl__Context</div><div class="line">    604 vmdetect</div><div class="line">    303 DebuggerException__SetConsoleCtrl</div><div class="line">    186 SEH__vectored</div><div class="line">     83 DebuggerHiding__Thread</div><div class="line">     80 DebuggerHiding__Active</div><div class="line">     52 DebuggerException__ConsoleCtrl</div><div class="line">     10 Check_Dlls</div><div class="line">      5 DebuggerCheck__RemoteAPI</div><div class="line">      2 DebuggerCheck__GlobalFlags</div><div class="line">      1 ▒▒DebuggerPattern__RDTSC</div><div class="line">      1 Debuggeattern__SEH_Inits</div><div class="line">      1 Check_VBox_VideoDrivers</div><div class="line">      1 Check_VBox_Description</div></pre></td></tr></table></figure>
<p>マルウェアの開発者がよりgenericな手法を好むことは，<code>RDTSC</code>命令を用いる検体が61.15%, <code>CPUID</code>命令を用いる検体が57.02%含まれていることからも明らかだ．たった2バイトを基準に検出しているため，false positiveだらけなのだろうとはいえ．<br>一方でvmdetectとして計上された検体は全体の1.18%に過ぎない．これはVMware, Virtual PC, Xen, Virtual Boxに関する文字列が含まれる検体を抽出するルールであり，コードは以下のようになっている．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line">rule vmdetect</div><div class="line">&#123;</div><div class="line">    meta:</div><div class="line">        author = &quot;nex&quot;</div><div class="line">        description = &quot;Possibly employs anti-virtualization techniques&quot;</div><div class="line"></div><div class="line">    strings:</div><div class="line">        // Binary tricks</div><div class="line">        $vmware = &#123;56 4D 58 68&#125;</div><div class="line">        $virtualpc = &#123;0F 3F 07 0B&#125;</div><div class="line">        $ssexy = &#123;66 0F 70 ?? ?? 66 0F DB ?? ?? ?? ?? ?? 66 0F DB ?? ?? ?? ?? ?? 66 0F EF&#125;</div><div class="line">        $vmcheckdll = &#123;45 C7 00 01&#125;</div><div class="line">        $redpill = &#123;0F 01 0D 00 00 00 00 C3&#125;</div><div class="line"></div><div class="line">        // Random strings</div><div class="line">        $vmware1 = &quot;VMXh&quot;</div><div class="line">        $vmware2 = &quot;Ven_VMware_&quot; nocase</div><div class="line">        $vmware3 = &quot;Prod_VMware_Virtual_&quot; nocase</div><div class="line">        $vmware4 = &quot;hgfs.sys&quot; nocase</div><div class="line">        $vmware5 = &quot;mhgfs.sys&quot; nocase</div><div class="line">        $vmware6 = &quot;prleth.sys&quot; nocase</div><div class="line">        $vmware7 = &quot;prlfs.sys&quot; nocase</div><div class="line">        $vmware8 = &quot;prlmouse.sys&quot; nocase</div><div class="line">        $vmware9 = &quot;prlvideo.sys&quot; nocase</div><div class="line">        $vmware10 = &quot;prl_pv32.sys&quot; nocase</div><div class="line">        $vmware11 = &quot;vpc-s3.sys&quot; nocase</div><div class="line">        $vmware12 = &quot;vmsrvc.sys&quot; nocase</div><div class="line">        $vmware13 = &quot;vmx86.sys&quot; nocase</div><div class="line">        $vmware14 = &quot;vmnet.sys&quot; nocase</div><div class="line">        $vmware15 = &quot;vmicheartbeat&quot; nocase</div><div class="line">        $vmware16 = &quot;vmicvss&quot; nocase</div><div class="line">        $vmware17 = &quot;vmicshutdown&quot; nocase</div><div class="line">        $vmware18 = &quot;vmicexchange&quot; nocase</div><div class="line">        $vmware19 = &quot;vmdebug&quot; nocase</div><div class="line">        $vmware20 = &quot;vmmouse&quot; nocase</div><div class="line">        $vmware21 = &quot;vmtools&quot; nocase</div><div class="line">        $vmware22 = &quot;VMMEMCTL&quot; nocase</div><div class="line">        $vmware23 = &quot;vmx86&quot; nocase</div><div class="line">        $vmware24 = &quot;vmware&quot; nocase</div><div class="line">        $virtualpc1 = &quot;vpcbus&quot; nocase</div><div class="line">        $virtualpc2 = &quot;vpc-s3&quot; nocase</div><div class="line">        $virtualpc3 = &quot;vpcuhub&quot; nocase</div><div class="line">        $virtualpc4 = &quot;msvmmouf&quot; nocase</div><div class="line">        $xen1 = &quot;xenevtchn&quot; nocase</div><div class="line">        $xen2 = &quot;xennet&quot; nocase</div><div class="line">        $xen3 = &quot;xennet6&quot; nocase</div><div class="line">        $xen4 = &quot;xensvc&quot; nocase</div><div class="line">        $xen5 = &quot;xenvdb&quot; nocase</div><div class="line">        $xen6 = &quot;XenVMM&quot; nocase</div><div class="line">        $virtualbox1 = &quot;VBoxHook.dll&quot; nocase</div><div class="line">        $virtualbox2 = &quot;VBoxService&quot; nocase</div><div class="line">        $virtualbox3 = &quot;VBoxTray&quot; nocase</div><div class="line">        $virtualbox4 = &quot;VBoxMouse&quot; nocase</div><div class="line">        $virtualbox5 = &quot;VBoxGuest&quot; nocase</div><div class="line">        $virtualbox6 = &quot;VBoxSF&quot; nocase</div><div class="line">        $virtualbox7 = &quot;VBoxGuestAdditions&quot; nocase</div><div class="line">        $virtualbox8 = &quot;VBOX HARDDISK&quot;  nocase</div><div class="line"></div><div class="line">        // MAC addresses</div><div class="line">        $vmware_mac_1a = &quot;00-05-69&quot;</div><div class="line">        $vmware_mac_1b = &quot;00:05:69&quot;</div><div class="line">        $vmware_mac_1c = &quot;000569&quot;</div><div class="line">        $vmware_mac_2a = &quot;00-50-56&quot;</div><div class="line">        $vmware_mac_2b = &quot;00:50:56&quot;</div><div class="line">        $vmware_mac_2c = &quot;005056&quot;</div><div class="line">        $vmware_mac_3a = &quot;00-0C-29&quot; nocase</div><div class="line">        $vmware_mac_3b = &quot;00:0C:29&quot; nocase</div><div class="line">        $vmware_mac_3c = &quot;000C29&quot; nocase</div><div class="line">        $vmware_mac_4a = &quot;00-1C-14&quot; nocase</div><div class="line">        $vmware_mac_4b = &quot;00:1C:14&quot; nocase</div><div class="line">        $vmware_mac_4c = &quot;001C14&quot; nocase</div><div class="line">        $virtualbox_mac_1a = &quot;08-00-27&quot;</div><div class="line">        $virtualbox_mac_1b = &quot;08:00:27&quot;</div><div class="line">        $virtualbox_mac_1c = &quot;080027&quot;</div><div class="line"></div><div class="line">    condition:</div><div class="line">        any of them</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>見ての通りQEMUに関する記述が存在しない．<br>そこで，vmdetectに以下の様なコードを追加し，再度スキャンしてみた．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">rule vmdetect</div><div class="line">&#123;</div><div class="line">    ~ 略 ~</div><div class="line"></div><div class="line">    strings:</div><div class="line">        $QEMU1 = &quot;Bochs&quot; nocase</div><div class="line">        $QEMU3 = &quot;QEMU_AUDIO_DRV&quot; nocase</div><div class="line">        $QEMU4 = &quot;QEMU VVFAT&quot; nocase</div><div class="line">        $QEMU5 = &quot;QEMU ADB Mouse&quot; nocase</div><div class="line">        $QEMU6 = &quot;QEMU ADS7846-driven Touchscreen&quot; nocase</div><div class="line">        $QEMU7 = &quot;QEMU HARDDISK&quot; nocase</div><div class="line">        $QEMU8 = &quot;QEMU CD-ROM&quot; nocase</div><div class="line">        $QEMU9 = &quot;QEMU MICRODRIVE&quot; nocase</div><div class="line">        $QEMU10 = &quot;QEMU-MEMORY&quot; nocase</div><div class="line">        $QEMU11 = &quot;QEMU_BIOS&quot; nocase</div><div class="line">        $QEMU12 = &quot;QEMU PS/2 Mouse&quot; nocase</div><div class="line">        $QEMU13 = &quot;QEMU Sun Mouse&quot; nocase</div><div class="line">        $QEMU14 = &quot;QEMU TSC2102-driven Touchscreen&quot; nocase</div><div class="line">        $QEMU15 = &quot;QEMU USB Mouse&quot; nocase</div><div class="line">        $QEMU16 = &quot;QEMU USB Tablet&quot; nocase</div><div class="line">        $QEMU17 = &quot;QEMU_VERSION&quot; nocase</div><div class="line">        $QEMU18 = &quot;QEMU USB Keyboard&quot; nocase</div><div class="line">        $QEMU19 = &quot;QEMU USB Hub&quot; nocase</div><div class="line">        $QEMU20 = &quot;QEMU USB MSD&quot; nocase</div><div class="line">        $QEMU21 = &quot;QEMU PenPartner tablet&quot; nocase</div><div class="line">        $QEMU22 = &quot;QEMUware SVGA&quot; nocase</div><div class="line"></div><div class="line">    condition:</div><div class="line">        any of them</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>結果は608検体．QEMUを検出するのは4検体だけという結果になった．<br>自分がマルウェアを開発する立場だったらこうした文字列をそのまま埋め込むことはしないし，このルールは表層的なものでしかなく，例えばQEMUの動的バイナリ変換のスケジューリングに着目したAnti-VMを検出することはできない．<br>とはいえ，おかげで現状を大雑把に把握することはできた．</p>
<h1 id="パッカーの実態"><a href="#パッカーの実態" class="headerlink" title="パッカーの実態"></a>パッカーの実態</h1><p>ついでに，<a href="http://www.softpedia.com/get/Programming/Packers-Crypters-Protectors/PEiD-updated.shtml" target="_blank" rel="external">PEiD</a>を用いてパッカーの利用状況を調べた．<br>UserDBには<a href="https://code.google.com/p/reverse-engineering-scripts/downloads/detail?name=UserDB.TXT" target="_blank" rel="external">Bob / Team PEiD signatures</a>を用いた．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div></pre></td><td class="code"><pre><div class="line"># awk &apos;&#123;&#123;for(i=3;i&lt;NF;i++)printf(&quot;%s &quot;,$i) &#125;print($NF)&#125;&apos; peid.log | sort | uniq -c | sort -r</div><div class="line">  21159 Nothing found *</div><div class="line">   3065 Nothing found [Overlay] *</div><div class="line">   1412 Microsoft Visual Basic 5.0 / 6.0</div><div class="line">    916 Microsoft Visual C++ 8.0 DLL Method2</div><div class="line">    747 Microsoft Visual C++ 6.0</div><div class="line">    685 Microsoft Visual Basic 5.0 - 6.0</div><div class="line">    405 Borland Delphi 6.0 - 7.0 [Overlay]</div><div class="line">    351 UPX 0.89.6 - 1.02 / 1.05 - 2.90 -&gt; Markus &amp; Laszlo</div><div class="line">    333 Microsoft Visual C++ 7.0 [Overlay]</div><div class="line">    320 UPX 2.93 - 3.00 [LZMA] -&gt; Markus Oberhumer, Laszlo Molnar &amp; John Reiser [Overlay] *</div><div class="line">    239 Borland Delphi 6.0 - 7.0</div><div class="line">    201 Microsoft Visual C++ 6.0 [Overlay]</div><div class="line">    185 UPX 0.89.6 - 1.02 / 1.05 - 2.90 -&gt; Markus &amp; Laszlo [Overlay]</div><div class="line">    167 Nullsoft PiMP Stub [Nullsoft PiMP SFX] *</div><div class="line">     99 Microsoft Visual C++ 6.0 DLL</div><div class="line">     83 Microsoft Visual C++ 7.0 [Debug] [Overlay]</div><div class="line">     82 Nothing found [Debug] *</div><div class="line">     79 UPX 0.89.6 - 1.02 / 1.05 - 2.90 (Delphi) stub -&gt; Markus &amp; Laszlo [Overlay]</div><div class="line">     63 Microsoft Visual C++ 7.0</div><div class="line">     62 Microsoft Visual C# / Basic .NET</div><div class="line">     61 Microsoft Visual Basic 5.0 / 6.0 [Overlay]</div><div class="line">     42 Themida 1.8.x.x - 1.9.x.x -&gt; Oreans Technologies</div><div class="line">     42 ASPack 2.12 -&gt; Alexey Solodovnikov [Overlay]</div><div class="line">     38 ASProtect 1.2x - 1.3x [Registered] -&gt; Alexey Solodovnikov</div><div class="line">     32 ASPack 2.12 -&gt; Alexey Solodovnikov</div><div class="line">     31 PE Win32 DLL (0 EntryPoint)</div><div class="line">     31 Nothing found [RAR SFX] *</div><div class="line">     31 Microsoft Visual C++ 6.0 DLL [Overlay]</div><div class="line">     28 Borland C++</div><div class="line">     26 PECompact 2.x -&gt; Jeremy Collake [Overlay]</div><div class="line">     24 Morphine 1.2 - 1.3 -&gt; rootkit</div><div class="line">     23 MinGW GCC 3.x [Overlay] *</div><div class="line">     22 UPX 0.89.6 - 1.02 / 1.05 - 2.90 (Delphi) stub -&gt; Markus &amp; Laszlo</div><div class="line">     22 Microsoft Visual C# / Basic .NET [Overlay]</div><div class="line">     19 Nothing found [ZIP SFX] *</div><div class="line">     18 PECompact 2.x -&gt; Jeremy Collake</div><div class="line">     18 Microsoft Visual C++ 7.0 [Debug]</div><div class="line">     15 Borland C++ [Overlay]</div><div class="line">     14 Borland Delphi 4.0 - 5.0</div><div class="line">     14 ASProtect 1.33 - 2.1 Registered -&gt; Alexey Solodovnikov *</div><div class="line">     13 UPX 2.93 - 3.00 [LZMA] -&gt; Markus Oberhumer, Laszlo Molnar &amp; John Reiser *</div><div class="line">     13 Microsoft Visual C++ 6.0 [Debug]</div><div class="line">     13 Microsoft Visual C++ 5.0</div><div class="line">     12 UPX 0.80 - 1.24 DLL -&gt; Markus &amp; Laszlo</div><div class="line">     12 BobSoft Mini Delphi -&gt; BoB / BobSoft [Overlay] *</div><div class="line">     11 Themida 1.8.x.x -&gt; Oreans Technologies *</div><div class="line">     11 Microsoft Visual C++ Private Version 1</div><div class="line">     11 Borland Delphi 6.0</div><div class="line">     11 Borland Delphi 2.0 [Overlay]</div><div class="line">     10 BobSoft Mini Delphi -&gt; BoB / BobSoft *</div><div class="line">      9 NsPack 2.9 -&gt; North Star *</div><div class="line">      9 Microsoft Visual C++ 5.0 [Debug]</div><div class="line">      8 Microsoft Visual C++ 7.1 DLL</div><div class="line">      8 Microsoft Visual C++ 7.0 Method2</div><div class="line">      7 Xtreme-Protector v1.05 *</div><div class="line">      7 Microsoft Visual C++ 8.0 DLL Method2 [Overlay]</div><div class="line">      6 Xtreme-Protector v1.05 [Overlay] *</div><div class="line">      6 Microsoft Visual C++ 8.0 [Debug] [Debug]</div><div class="line">      6 ASProtect 1.2x - 1.3x [Registered] -&gt; Alexey Solodovnikov [Overlay]</div><div class="line">      5 nSPack 3.7 -&gt; North Star/Liu Xing Ping</div><div class="line">      5 Wise Installer Stub [Overlay] *</div><div class="line">      5 WinZip 32-bit SFX 8.x module</div><div class="line">      5 Thinstall 2.4x - 2.5x -&gt; Jitit Software [Overlay] *</div><div class="line">      5 PureBasic 4.x -&gt; Neil Hodgson *</div><div class="line">      5 PE Win32 DLL (0 EntryPoint) [Overlay]</div><div class="line">      5 Microsoft Visual C++ 7.1 DLL [Overlay]</div><div class="line">      4 tElock 0.98b1 -&gt; tE!</div><div class="line">      4 Themida 1.8.x.x - 1.9.x.x -&gt; Oreans Technologies [Overlay]</div><div class="line">      4 PureBasic 4.x -&gt; Neil Hodgson [Overlay] *</div><div class="line">      4 PC-Guard 5.0 -&gt; Blagoje Ceklic [Overlay]</div><div class="line">      4 MoleBox v2.0 *</div><div class="line">      4 Microsoft Visual C++ 8.0 [Debug]</div><div class="line">      4 Microsoft Visual C++ 5.0 [Overlay]</div><div class="line">      4 Borland Delphi 4.0 - 5.0 [Overlay]</div><div class="line">      4 Borland C++ 1999 [Overlay]</div><div class="line">      4 Borland C++ 1999</div><div class="line">      4 Armadillo 3.78 - 4.xx -&gt; Silicon Realms Toolworks</div><div class="line">      4 Armadillo 1.xx - 2.xx -&gt; Silicon Realms Toolworks</div><div class="line">      4 ASProtect 2.1x SKE -&gt; Alexey Solodovnikov</div><div class="line">      3 nSPack 3.7 -&gt; North Star/Liu Xing Ping [Overlay]</div><div class="line">      3 Upack 0.39 beta -&gt; Dwing</div><div class="line">      3 UPX 0.80 - 1.24 DLL -&gt; Markus &amp; Laszlo [Overlay]</div><div class="line">      3 Themida 1.2.0.1 (compressed) -&gt; Oreans Technologies [Overlay]</div><div class="line">      3 Themida 1.2.0.1 (compressed) -&gt; Oreans Technologies</div><div class="line">      3 NsPack 3.4 -&gt; North Star *</div><div class="line">      3 NakedPacker 1.0 - by BigBoote *</div><div class="line">      3 MinGW GCC 3.x [ZIP SFX] *</div><div class="line">      3 Microsoft Visual C++ [Overlay]</div><div class="line">      3 Microsoft Visual C++ 6.0 SPx Method 1</div><div class="line">      3 Microsoft Visual Basic 5.0 - 6.0 [Overlay]</div><div class="line">      3 Inno Setup Module Heuristic Mode [Overlay]</div><div class="line">      3 ASProtect 2.1x SKE -&gt; Alexey Solodovnikov [Overlay]</div><div class="line">      2 tElock 0.90 -&gt; tE! [Overlay]</div><div class="line">      2 Upack 0.28 - 0.399 (relocated image base) - Delphi, .NET, DLL -&gt; Dwing</div><div class="line">      2 Upack 0.24 - 0.29 beta -&gt; Dwing</div><div class="line">      2 UltraProtect 1.x -&gt; RISCO Software Inc. [Overlay]</div><div class="line">      2 UltraProtect 1.x -&gt; RISCO Software Inc.</div><div class="line">      2 UPX 0.89.6 - 1.02 / 1.05 - 2.90 -&gt; Markus &amp; Laszlo [RAR SFX]</div><div class="line">      2 SVKP 1.3x -&gt; Pavol Cerven</div><div class="line">      2 PureBasic DLL -&gt; Neil Hodgson *</div><div class="line">      2 PEtite 2.x [Level 0] -&gt; Ian Luck</div><div class="line">      2 PE-Armor V0.7X -&gt; hying *</div><div class="line">      2 PC-Guard 5.0 -&gt; Blagoje Ceklic</div><div class="line">      2 Nullsoft Install System 2.1x [Nullsoft PiMP SFX]</div><div class="line">      2 NsPack 1.4 -&gt; Liuxingping *</div><div class="line">      2 NTKrnl Security Suite -&gt; NTKrnl Team</div><div class="line">      2 Morphine 1.4 - 2.7 -&gt; Holy_Father &amp; Ratter/29A</div><div class="line">      2 MinGW GCC 3.x *</div><div class="line">      2 Microsoft Visual C++ Private Version 1 [Overlay]</div><div class="line">      2 Microsoft Visual C++ DLL Method 1</div><div class="line">      2 Microsoft Visual C++ 7.0 Method2 [Debug] [Overlay]</div><div class="line">      2 Microsoft Visual C++ 7.0 DLL Method 3</div><div class="line">      2 Microsoft Visual C++</div><div class="line">      2 Microsoft Visual Basic 5.0 / 6.0 [Debug]</div><div class="line">      2 MASM32 / TASM32</div><div class="line">      2 EXECryptor 2.2.4 -&gt; Strongbit/SoftComplete Development (h1) *</div><div class="line">      2 EXECryptor 1.x.x -&gt; SoftComplete Developement</div><div class="line">      2 Borland Delphi DLL</div><div class="line">      2 Borland Delphi 6.0 [Overlay]</div><div class="line">      2 Borland Delphi 3.0</div><div class="line">      2 Borland C++ DLL Method 2 [Overlay]</div><div class="line">      1 yoda&apos;s Protector 1.3 -&gt; Ashkbiz Danehkar</div><div class="line">      1 yoda&apos;s Protector 1.03.3 -&gt; Ashkbiz Danehkar</div><div class="line">      1 yoda&apos;s Protector 1.03.2 -&gt; Ashkbiz Danehkar</div><div class="line">      1 tElock v0.90 [Overlay] *</div><div class="line">      1 tElock v0.90 *</div><div class="line">      1 tElock 1.0 (private) -&gt; tE!</div><div class="line">      1 tElock 0.61 -&gt; tE!</div><div class="line">      1 nSpack V2.3 -&gt; LiuXingPing *</div><div class="line">      1 eXPressor 1.3.0 -&gt; CGSoftLabs</div><div class="line">      1 Winkript 1.0 -&gt; Mr. Crimson/WKT</div><div class="line">      1 WinRAR 32-bit SFX Module [RAR SFX] *</div><div class="line">      1 WWPack32 1.x -&gt; Piotr Warezak</div><div class="line">      1 Upack 0.28 - 0.399 (relocated image base) - Delphi, .NET, DLL -&gt; Dwing [Overlay]</div><div class="line">      1 Upack 0.24 - 0.29 beta -&gt; Dwing [Overlay]</div><div class="line">      1 UPX 1.03 - 1.04 -&gt; Markus &amp; Laszlo [Overlay]</div><div class="line">      1 UPX 1.03 - 1.04 -&gt; Markus &amp; Laszlo</div><div class="line">      1 UPX 0.89.6 - 1.02 / 1.05 - 2.90 -&gt; Markus &amp; Laszlo [Nullsoft PiMP SFX]</div><div class="line">      1 Themida 1.8.x.x -&gt; Oreans Technologies [Overlay] *</div><div class="line">      1 Themida -&gt; Oreans Technologies 2004 *</div><div class="line">      1 SafeDisc 2.05.030 -&gt; Macrovision [Overlay]</div><div class="line">      1 RLPack V1.11 -&gt; ap0x [Overlay] *</div><div class="line">      1 RLPack 1.20 Basic Edition [aPLib] -&gt; Ap0x *</div><div class="line">      1 RCryptor v1.6d --&gt; Vaska *</div><div class="line">      1 Pelles C 3.00, 4.00, 4.50 EXE (X86 CRT-LIB) [Overlay]</div><div class="line">      1 PKLITE32 v1.1 *</div><div class="line">      1 PEtite 2.x [Level 1/9] -&gt; Ian Luck [Overlay]</div><div class="line">      1 PEtite 2.x [Level 1/9] -&gt; Ian Luck</div><div class="line">      1 PEncrypt 4.0 Gamma / 4.0 Phi -&gt; junkcode</div><div class="line">      1 PESpin 0.3x - 1.xx -&gt; cyberbob</div><div class="line">      1 PECompact 2.xx --&gt; BitSum Technologies [Overlay] *</div><div class="line">      1 PECompact 2.xx --&gt; BitSum Technologies *</div><div class="line">      1 PECompact 1.40 - 1.45 -&gt; Jeremy Collake [Overlay]</div><div class="line">      1 PEBundle 2.0x - 2.4x-&gt; Jeremy Collake</div><div class="line">      1 PEBundle 0.2 - 3.x -&gt; Jeremy Collake</div><div class="line">      1 PE Pack 1.0 -&gt; ANAKiN [Overlay]</div><div class="line">      1 PE Pack 1.0 -&gt; ANAKiN</div><div class="line">      1 PE Crypt 1.02 -&gt; random, killa &amp; acpizer</div><div class="line">      1 Obsidium 1.3.0.4 -&gt; Obsidium Software [Overlay]</div><div class="line">      1 Nullsoft PiMP stub [Nullsoft PiMP SFX]</div><div class="line">      1 Nullsoft Install System 2.x [Nullsoft PiMP SFX]</div><div class="line">      1 NsPack 2.9 -&gt; North Star [Overlay] *</div><div class="line">      1 Nothing found [CAB SFX] *</div><div class="line">      1 NSPack 3.x -&gt; Liu Xing Ping *</div><div class="line">      1 Morphine 1.4 - 2.7 -&gt; Holy_Father &amp; Ratter/29A [Overlay]</div><div class="line">      1 MoleBox v2.0 [Overlay] *</div><div class="line">      1 Microsoft Visual C++ 8.0 [Debug] [Overlay]</div><div class="line">      1 Microsoft Visual C++ 7.0 Method2 [Overlay]</div><div class="line">      1 Microsoft Visual C++ 7.0 DLL Method 3 [Overlay]</div><div class="line">      1 Microsoft Visual C++ 6.0 [ZIP SFX]</div><div class="line">      1 Microsoft Visual C++ 6.0 SPx Method 1 [Overlay]</div><div class="line">      1 Microsoft Visual C++ 6.0 DLL [Debug]</div><div class="line">      1 Microsoft Visual C++ 4.x [Overlay]</div><div class="line">      1 Microsoft Visual C++ 4.x [Debug]</div><div class="line">      1 Microsoft Visual Basic 6.0 DLL [Overlay]</div><div class="line">      1 Microsoft CAB SFX module</div><div class="line">      1 LCC Win32 1.x -&gt; Jacob Navia</div><div class="line">      1 KByS V0.28 -&gt; shoooo [Overlay] *</div><div class="line">      1 KByS V0.22 -&gt; shoooo *</div><div class="line">      1 InstallShield AFW [Overlay]</div><div class="line">      1 Install Stub 32-bit -&gt; InstallShield [Overlay]</div><div class="line">      1 Inno Installer 4.0.5 [Inno SFX]</div><div class="line">      1 FSG 2.0 -&gt; bart/xt</div><div class="line">      1 EZIP 1.0 -&gt; Jonathan Clark [Overlay]</div><div class="line">      1 EXECryptor 1.x.x -&gt; SoftComplete Developement [Overlay]</div><div class="line">      1 CD-Cops II -&gt; Link Data Security [Overlay]</div><div class="line">      1 Borland Delphi DLL [Overlay]</div><div class="line">      1 Borland Delphi 5.0 KOL/MCK [Overlay]</div><div class="line">      1 Borland Delphi 5.0 KOL [Overlay]</div><div class="line">      1 Borland Delphi 3.0 [Overlay]</div><div class="line">      1 Borland Delphi 2.0 [Inno SFX]</div><div class="line">      1 Borland Delphi 2.0</div><div class="line">      1 Borland Component</div><div class="line">      1 Armadillo v1.71 [Overlay] *</div><div class="line">      1 Armadillo 3.78 - 4.xx -&gt; Silicon Realms Toolworks [Overlay]</div><div class="line">      1 Armadillo 2.01 -&gt; Silicon Realms Toolworks [Overlay]</div><div class="line">      1 ASProtect SKE 2.1x (exe) -&gt; Alexey Solodovnikov [Overlay] *</div><div class="line">      1 ASProtect 2.0x Registered -&gt; Alexey Solodovnikov [Overlay]</div><div class="line">      1 ASProtect 2.0x Registered -&gt; Alexey Solodovnikov</div><div class="line">      1 ASProtect 1.33 - 2.1 Registered -&gt; Alexey Solodovnikov [Overlay] *</div><div class="line">      1 ASProtect 1.2 / 1.2c-&gt; Alexey Solodovnikov</div><div class="line">      1 ASPack 2.12b -&gt; Alexey Solodovnikov</div><div class="line">      1 ASPack 1.08.03 -&gt; Alexey Solodovnikov [Overlay]</div><div class="line">      1 ASPack 1.06b / 1.061b -&gt; Alexey Solodovnikov [Overlay]</div><div class="line">      1 AHTeam EP Protector 0.3 (fake Microsoft Visual C++ 7.0) -&gt; FEUERRADER *</div><div class="line">      1 ACProtect V2.0 -&gt; risco *</div><div class="line">      1 ACProtect 2.00 - RISCO Software Inc. [Overlay]</div><div class="line">      1 ACProtect 1.40 - 1.41 - RISCO Software Inc.</div><div class="line">      1 .BJFNT 1.1b -&gt; :MARQUiS:</div><div class="line">      1 * PseudoSigner 0.2 [Microsoft Visual Basic 5.0 - 6.0] --&gt; Anorganix [Overlay] *</div><div class="line">      1 * PseudoSigner 0.2 [Microsoft Visual Basic 5.0 - 6.0] --&gt; Anorganix *</div></pre></td></tr></table></figure>
<p>ほとんど検出できていないのが残念．ひときわ面倒なThemidaは11検体だった．</p>
<h1 id="サンドボックスの実態"><a href="#サンドボックスの実態" class="headerlink" title="サンドボックスの実態"></a>サンドボックスの実態</h1><p>サンドボックスの透明性が研究されている一方で，実際のマルウェアはあまり凝ったAnti-VMを備えていなかった．<br>一方で，現実のサンドボックスはどうだろうか．いくら論文で優れた手法が編み出されようが，役立てられていなければ意味がない．<br>そこで，一般に公開されているサンドボックスに対してシステム情報を取得するプログラムを挿入し，仮想マシンモニタの種類を判別できるかどうか試してみたのだが，実態はあまりにもお粗末だった．<br>詳細は言うまい．<br>だが，systeminfoコマンドとNtQuerySystemInformationだけで露見する代物ばかりだった．<br>マルウェアの解析ではなく検出を目的としたサービス，言ってしまえばVirusTotalをサンドボックスのフロントエンドとしたことが，この一因として挙げられる．<br>凝ったAnti-VMを備えたマルウェアがあまり多くないことも考えると，現状のサンドボックスで十分だということなのだろうか．</p>
<h1 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h1><p>研究をしているうちに袋小路に突入してしまい，サンドボックスの透明性やAnti Anti-VMあくまでマルウェア解析の一側面に過ぎないことを私は忘れかけていた．<br>本質は別のところにある．</p>
<h1 id="TEQUILABOOMBOOM"><a href="#TEQUILABOOMBOOM" class="headerlink" title="TEQUILABOOMBOOM"></a>TEQUILABOOMBOOM</h1><p>公開されているサンドボックスの中にTEQUILABOOMBOOMというホスト名のものがあった．<br><a href="http://www.virusradar.com/en/Win32 Kasidet.AA/description" target="_blank" rel="external">Trojan.Win32.Inject.uljv</a>や<a href="http://securitykitten.github.io/vm-checking-and-detecting/" target="_blank" rel="external">Backdoor.Win32.Agent.dkbp</a>など一部のマルウェアは，このホスト名に基づいてサンドボックスを検出することが知られている．調べてみると，<a href="http://webcache.googleusercontent.com/search?q=cache:hackforums.net/printthread.php?tid=3733605" target="_blank" rel="external">Question about keylogged PC - Printable Version</a>や<a href="http://webcache.googleusercontent.com/search?q=cache:wrb-hdtEFFkJ:www.hackforums.net/showthread.php%3Ftid%3D4522377%26page%3D16+&amp;cd=9&amp;hl=ja&amp;ct=clnk&amp;gl=jp" target="_blank" rel="external">[FUD][FREE] Agent Tesla [Keylogger] [ClipboardLogger] [On-Screen Keyboard Logger] - Page 16</a>など，2013年の時点で情報が攻撃者の間で共有されている．</p>
<blockquote>
<p>So I managed to crypt a keylogger and have my victim download it through dropbox (I think). I haven’t received any logs yet but it shows that I’m connected to a computer from france which is janettedoe@TEQUILABOOMBOOM. I’m not sure how this is possible, or if it’s some sort of error. Does anybody know what this is? My keylogger hasn’t been sent anywhere other than to my targets email. </p>
</blockquote>
<p>どうやらこれはGoogleが動かしているCuckoo Sandboxが用いるホスト名らしく，攻撃者によるサンドボックスの実態調査が進んでいることを伺わせる．<br>サンドボックスの透明性について拘りすぎる必要はないにせよ，その情報が攻撃者の手に渡ることを前提としたサービスについては検討の余地がある．</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li>Gabriel Negreira Barbosa, Rodrigo Rubira Branco,<br>“<a href="https://www.blackhat.com/docs/us-14/materials/us-14-Branco-Prevalent-Characteristics-In-Modern-Malware.pdf" target="_blank" rel="external">Prevalent Characteristics in Modern Malware[PDF]</a>,”<br>Black Hat USA 2014.</li>
<li>Gábor Pék, Levente Buttyán, Boldizsár Bencsáth,<br>“<a href="http://www.profsandhu.com/cs6393_s14/csur_hw_virt_2013.pdf" target="_blank" rel="external">A Survey of Security Issues in Hardware Virtualization[PDF]</a>,”<br>ACM Computing Surveys, vol. 45, issue. 3, 2013.</li>
<li>“VirusShare.com,” <a href="http://virusshare.com/" target="_blank" rel="external">http://virusshare.com/</a></li>
<li><a href="http://intelreport.mandiant.com/Mandiant_APT1_Report.pdf" target="_blank" rel="external">http://intelreport.mandiant.com/Mandiant_APT1_Report.pdf[PDF]</a></li>
<li>“YARA - The pattern matching swiss knife for malware researchers,” <a href="http://plusvic.github.io/yara/" target="_blank" rel="external">http://plusvic.github.io/yara/</a></li>
<li>“PEiD Download - Softpedia,” <a href="http://www.softpedia.com/get/Programming/Packers-Crypters-Protectors/PEiD-updated.shtml" target="_blank" rel="external">http://www.softpedia.com/get/Programming/Packers-Crypters-Protectors/PEiD-updated.shtml</a></li>
<li>“Win32/Kasidet.AA | ESET Virusradar,” <a href="http://www.virusradar.com/en/Win32 Kasidet.AA/description" target="_blank" rel="external">http://www.virusradar.com/en/Win32 Kasidet.AA/description</a></li>
<li>“VM Checking and Detecting Adventures in Security,” <a href="http://securitykitten.github.io/vm-checking-and-detecting/" target="_blank" rel="external">http://securitykitten.github.io/vm-checking-and-detecting/</a></li>
<li>“Question about keylogged PC - Printable Version,” <a href="http://webcache.googleusercontent.com/search?q=cache:hackforums.net/printthread.php?tid=3733605" target="_blank" rel="external">http://webcache.googleusercontent.com/search?q=cache:hackforums.net/printthread.php?tid=3733605</a></li>
<li>“[FUD][FREE] Agent Tesla [Keylogger] [ClipboardLogger] [On-Screen Keyboard Logger] - Page 16],” <a href="http://webcache.googleusercontent.com/search?q=cache:wrb-hdtEFFkJ:www.hackforums.net/showthread.php%3Ftid%3D4522377%26page%3D16+&amp;cd=9&amp;hl=ja&amp;ct=clnk&amp;gl=jp" target="_blank" rel="external">http://webcache.googleusercontent.com/search?q=cache:wrb-hdtEFFkJ:www.hackforums.net/showthread.php%3Ftid%3D4522377%26page%3D16+&amp;cd=9&amp;hl=ja&amp;ct=clnk&amp;gl=jp</a></li>
<li>Katsunari Yoshioka, Yoshihiko Hosobuchi, Tatsunori Orii, Tsutomu Matsumoto,<br>“<a href="http://ieeexplore.ieee.org/xpl/login.jsp?tp=&amp;arnumber=5598065&amp;url=http%3A%2F%2Fieeexplore.ieee.org%2Fxpls%2Fabs_all.jsp%3Farnumber%3D5598065" target="_blank" rel="external">Vulnerability in Public Malware Sandbox Analysis Systems</a>,”<br>IEEE/IPSJ 12th International Symposium on Applications and the Internet, pp. 265-268, 2010.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2015/03/14/sandbox-transparency-in-the-wild/" data-id="cjbiq70sf001j8w7t1n9pszkh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-machine-introspection/">virtual machine introspection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-xen-libvmi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/01/31/xen-libvmi/">XenとLibVMI</a>
  

      </header>
    
    <time class="article-date" datetime="2015-01-31T14:39:37.000Z" itemprop="datePublished">01-31-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p><a href="https://github.com/libvmi/libvmi" target="_blank" rel="external">LibVMI</a>はXenならびにKVMを対象としたVMIライブラリである．ここでは，その基盤と応用についてまとめる．</p>
<h1 id="libxc"><a href="#libxc" class="headerlink" title="libxc"></a>libxc</h1><p>そもそもXenにおけるVMIの研究ではかねてより，各ドメインの制御機能ないしハイパーコールを提供するlibxcというライブラリが用いられてきた．libxcという名称はthe Xen Control libraryの略称であり，Xenによって公式に提供されている(<code>tools/libxc/</code>)．なお，libxcとして提供されている関数は<code>xc_</code>というprefixを備えている．<br>このうち，VMIと密接に関連があるのは<code>xenctrl.h</code>と<code>xenguest.h</code>である．なかでも<code>xenctrl.h</code>はlibxenctrlとも呼ばれ，PFNの参照やハイパーコールの追加などの機能が提供されている．<br>LibVMIのソースコードにgrepを掛けると，libxcに由来する構造体と関数が多く用いられていることが分かる．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">% grep -rhoe &quot;xc_[a-zA-z]*_[a-zA-z]*&quot; . | grep -v &quot;]&quot; | sort | uniq</div><div class="line">xc_domain_debug_control</div><div class="line">xc_domain_decrease_reservation_exact</div><div class="line">xc_domain_getinfo</div><div class="line">xc_domain_getinfolist</div><div class="line">xc_domain_hvm_getcontext</div><div class="line">xc_domain_hvm_getcontext_partial</div><div class="line">xc_domain_hvm_setcontext</div><div class="line">xc_domain_maximum_gpfn</div><div class="line">xc_domain_pause</div><div class="line">xc_domain_populate_physmap_exact</div><div class="line">xc_domain_set_access_required</div><div class="line">xc_domain_unpause</div><div class="line">xc_domaininfo_t</div><div class="line">xc_dominfo_t</div><div class="line">xc_evtchn_bind_interdomain</div><div class="line">xc_evtchn_close</div><div class="line">xc_evtchn_fd</div><div class="line">xc_evtchn_notify</div><div class="line">xc_evtchn_open</div><div class="line">xc_evtchn_pending</div><div class="line">xc_evtchn_t</div><div class="line">xc_evtchn_unbind</div><div class="line">xc_evtchn_unmask</div><div class="line">xc_get_hvm_param</div><div class="line">xc_hvm_get_mem_access</div><div class="line">xc_hvm_inject_trap</div><div class="line">xc_hvm_set_mem_access</div><div class="line">xc_interface_close</div><div class="line">xc_interface_open</div><div class="line">xc_map_foreign_batch</div><div class="line">xc_map_foreign_range</div><div class="line">xc_mem_access_disable</div><div class="line">xc_mem_access_enable</div><div class="line">xc_mem_access_resume</div><div class="line">xc_mem_event_disable</div><div class="line">xc_mem_event_enable</div><div class="line">xc_memory_op</div><div class="line">xc_set_hvm_param</div><div class="line">xc_set_mem_access</div><div class="line">xc_vcpu_getcontext</div><div class="line">xc_vcpu_setcontext</div></pre></td></tr></table></figure>
<p>とりわけVMIにおいて重要なのは<code>xc_map_foreign_range()</code>という関数である．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void *xc_map_foreign_ranges(xc_interface *xch, uint32_t dom,</div><div class="line">                            size_t size, int prot, size_t chunksize,</div><div class="line">                            privcmd_mmap_entry_t entries[], int nentries);</div></pre></td></tr></table></figure>
<p>Xenの各ドメインにはドメインや仮想CPUの構造体(<code>xen/include/xen/sched.h</code>)のほか，マシンメモリ（物理メモリ）と擬似物理メモリが割り当てられる．ドメインにおけるページングは，このマシンフレーム番号(MFN)と疑似物理フレーム番号(PFN)とを対応付けるP2Mテーブルによって実現されている．つまり，ドメインの仮想アドレスは擬似物理メモリフレーム番号に対応し，その疑似物理フレーム番号はさらにマシンフレーム番号に対応する．なお，Intel EPTが有効な環境においてはP2MはEPTによって代替される(<code>ept-p2m.c</code>)．<br><code>xc_map_foreign_range()</code>はこうした仕組みに基づき，ページテーブルを辿ってDom0のメモリ空間にDomUのマシンフレームを割り当てる．<br>VMIに求められるデータ構造の解釈はXenにおいて，この関数があることから成り立つものである．また，これによるフォールトインジェクションに関してもかつて研究が行われていたようだ．</p>
<h1 id="libxenstore"><a href="#libxenstore" class="headerlink" title="libxenstore"></a>libxenstore</h1><p>Xenではxenstore-lsやxenstore-readなどのコマンドからxenstoredというデーモンを経由して各ドメインの情報を読み出すことができる．この仕組みをXenStoreといい，関連してlibxenstoreというライブラリが提供されている．(<code>tools/xenstore/</code>)．libxsと呼ばれることもある．<br>XenStoreは名の通りKVSとしてドメインのUUIDやドメイン名，メモリのコミット状況などを格納している．<br>LibVMIにおいても，xenstordへのアクセスのため用いられている(<code>xen_private.h</code>)．</p>
<h1 id="libxenlight"><a href="#libxenlight" class="headerlink" title="libxenlight"></a>libxenlight</h1><p>libxenlightはlibxcとlibxenstoreのラッパとして公式に開発されているライブラリである(<code>tools/libxl/</code>)．<br>LibVMIでは用いられていないものの，Xen Projectの本流ではこちらが推進されているように見受けられる．</p>
<h1 id="XenAccess"><a href="#XenAccess" class="headerlink" title="XenAccess"></a>XenAccess</h1><p><a href="https://code.google.com/p/xenaccess/" target="_blank" rel="external">XenAccess</a>はlibxcのラッパであり，LibVMIの前身にあたる．<br>目的としてセマンティックギャップの解決が掲げられており，任意のPIDに対応するEPROCESS構造体を取得することができる．<br>EPROCESS構造体はWindowsの各プロセスに割り当てられる構造体であり，Windowsのプロセスリストはこの構造体のActiveProcessLinksメンバからなる双方向リンクリストによって成り立っている．タスクマネージャが参照するのはこの構造体である．<br>XenAccessはこの構造体を手掛かりにカーネルのベースアドレスを取得する．<br>まず，メモリ空間をPEヘッダの先頭すなわちMZという文字列で検索する．そして，発見したアドレスについてシステムプロセス固有のPsInitialSystemProcessのオフセットを加算し，EPROCESS構造体の先頭メンバである_EPROCESS.Pcb.headerにあたるシグネチャと比較する．一致した場合，発見したアドレスがベースアドレスということになる(<code>windows_memory.c</code>, <code>windows_core.c</code>, <code>windows_process.c</code>)．<br>これによって，プロセスリストと任意のプロセスの情報を取得することができるようになった．</p>
<h1 id="LibVMI"><a href="#LibVMI" class="headerlink" title="LibVMI"></a>LibVMI</h1><p>LibVMIはXenAccessの後継であり，かつてvmitoolsとも呼ばれていた．<br>先述したようなカーネル空間の解析機能をLibVMIはフォレンジックツールに委譲した．フォレンジックツールを導入するメリットとして，より詳細な構造体の解析を低い実装コストで実現できるという点が挙げられる．<br>さて，LibVMIは<a href="https://github.com/volatilityfoundation/volatility" target="_blank" rel="external">Volatility</a>と<a href="https://github.com/google/rekall" target="_blank" rel="external">Rekall</a>という二種類のフォレンジックツールに対応している．RekallはGoogleによるVolatilityの拡張であり，かつてはLibVMIのサポート外だったものの，<a href="https://github.com/libvmi/libvmi/commit/a4f065a31b986562dc39c9a10d9dff080792f3f4" target="_blank" rel="external">commit a4f065a31b986562dc39c9a10d9dff080792f3f4</a>にて導入された．<br>では，両者の差異はどこにあるのか．</p>
<h1 id="Kernel-Debugger-Block"><a href="#Kernel-Debugger-Block" class="headerlink" title="Kernel Debugger Block"></a>Kernel Debugger Block</h1><p>XenAccessが行っていたようなEPROCESS構造体のスキャンについて考えてみよう．<br>VolatilityとRekallはいずれも，まずリンクリストの先頭であるPsActiveProcessHeadを特定しようとする．<br>x86において，このPsActiveProcessHeadは，KPCR(Kernel Processor Control Region)構造体のKdVersionBlockメンバが示すKDDEBUGGER_DATA32構造体から取得することができる．<br>このKPCR構造体だが，x86ではFSレジスタ，x86_64ではGSレジスタが先頭アドレスを保持しており，Windows XPでは0xFFDFF000というマジックナンバーを用いて検索することができる．<br>では，KdVersionBlockはどうか．なんと，Windows 7の64-bit版からこのメンバは空になってしまっている．ゆえに，x86_64ではKDDEBUGGER_DATA64構造体をKdVersionBlockに頼らず検索する必要が生ずる．<br>ここで，VolatilityはKDDEBUGGER_DATA64構造体のヘッダに存在するKDBGシグネチャをスキャンするのに対し(<code>kdbgscan.py</code>)，Rekallはカーネルのバージョンに対応したプロファイル情報を用いて構造体にアクセスする．</p>
<h1 id="DRAKVUF"><a href="#DRAKVUF" class="headerlink" title="DRAKVUF"></a>DRAKVUF</h1><p><a href="https://github.com/tklengyel/drakvuf" target="_blank" rel="external">DRAKVUF</a>はTamas K Lengyelによって開発されたサンドボックスであり，論文のオーサーにはXenAccessとLibVMIの開発者であるBryan D. Payneも名を連ねている．<br>LibVMIにRekallのサポートを追加したのがほかでもないTamas K Lengyelその人である．<br>Volatilityは前述の通りメモリからKDBG構造体を検索する．だが，ゲストOSのメモリはマルウェアによって改竄されてしまうおそれがあることに加え，Windows 8の64-bit版ではKDBG構造体が難読化されているという問題点がある．<br>一方で，Rekallのプロファイルはゲストから不可視であり，改竄の影響を受けないため，この問題を解決することができる．<br>DRAKVUFはマルウェア解析を目的としてLibVMIを拡張しており，当然プログラムの実行をトラップする機能を備えている．<br>特筆すべきは，Intel EPTを用いたメモリアクセスの監視である(<code>vmi.c</code>)．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">// Now we can set the EPT permissions</div><div class="line">if (!container-&gt;guard) &#123;</div><div class="line">    container-&gt;guard = g_malloc0(sizeof(vmi_event_t));</div><div class="line">    SETUP_MEM_EVENT(container-&gt;guard, container-&gt;pa, VMI_MEMEVENT_PAGE,</div><div class="line">            VMI_MEMACCESS_RW, trap_guard);</div><div class="line">    if (VMI_FAILURE == vmi_register_event(vmi, container-&gt;guard)) &#123;</div><div class="line">        printf(&quot;*** FAILED TO REGISTER MEMORY GUARD @ PAGE %lu ***\n&quot;,</div><div class="line">                pa &gt;&gt; 12);</div><div class="line">        free(container-&gt;guard);</div><div class="line">        free(container);</div><div class="line">        continue;</div><div class="line">    &#125;</div><div class="line">    container-&gt;guard-&gt;data = g_hash_table_new(g_int64_hash,</div><div class="line">            g_int64_equal);</div><div class="line">    printf(&quot;\t\tNew memory event trap set on page %lu\n&quot;, pa &gt;&gt; 12);</div><div class="line">&#125; else &#123;</div><div class="line">    printf(&quot;\t\tMemory event trap already set on page %lu\n&quot;, pa &gt;&gt; 12);</div><div class="line">&#125;</div><div class="line"></div><div class="line">struct memevent *test = g_hash_table_lookup(container-&gt;guard-&gt;data,</div><div class="line">        &amp;container-&gt;pa);</div><div class="line">if (!test) &#123;</div><div class="line">    g_hash_table_insert(container-&gt;guard-&gt;data, &amp;container-&gt;pa,</div><div class="line">            container);</div><div class="line">&#125; else if (test-&gt;sID == SYMBOLWRAP) &#123;</div><div class="line">    printf(&quot;Address is already guarded\n&quot;);</div><div class="line">&#125; else &#123;</div><div class="line">    printf(&quot;Address is trapped by another feature! ERROR/TODO!\n&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>このアイデア自体はKVMをベースとして開発されたCXPInspectorを下敷きにしている．<br>かつては任意のアドレスについてNX bitを設定し，ページフォルトハンドラをブレークポイントとする手法が一般的であった．これがカーネル空間から可視であるのに対し，EPTは不可視であるためよりカーネルルートキットの解析に適している．</p>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>LibVMIの登場と洗練によってもはや，セマンティックギャップは過去の問題になりつつある．XenにおけるVMIにおいて，これを用いない手はないだろう．</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li>“Where to start with Xen? - Stack Overflow,”<br><a href="http://stackoverflow.com/questions/11575299/where-to-start-with-xen" target="_blank" rel="external">http://stackoverflow.com/questions/11575299/where-to-start-with-xen</a></li>
<li>Linux Technical Sales, IBM Japan,<br>“Xen ハイパーバイザー準仮想化モードの内部構造入門,”<br><a href="http://www-06.ibm.com/jp/linux/tech/doc/attachments/00393cd9_xen_pv_internal_v1_0.pdf" target="_blank" rel="external">http://www-06.ibm.com/jp/linux/tech/doc/attachments/00393cd9_xen_pv_internal_v1_0.pdf[PDF]</a></li>
<li>Kenichi Kourai and Shigeru Chiba,<br>“<a href="http://dl.acm.org/citation.cfm?id=1065006&amp;dl=ACM&amp;coll=DL&amp;CFID=595394357&amp;CFTOKEN=42837423" target="_blank" rel="external">HyperSpector: Virtual Distributed Monitoring Environments for Secure Intrusion Detection</a>,”<br>Proceedings of the 1st ACM/USENIX International Conference on Virtual Execution Environments, pp. 197-207, NY, USA, 2005.</li>
<li>新井 昇鎬, 千葉 滋,<br>“<a href="http://www.csg.ci.i.u-tokyo.ac.jp/paper/tadokoro-master2009.pdf" target="_blank" rel="external">複数OSに対応した仮想マシン間プロセススケジューリング[PDF]</a>,”<br>学士論文, 東京工業大学, 2009.</li>
<li>安積 武志, 千葉 滋,<br>“<a href="http://www.csg.ci.i.u-tokyo.ac.jp/paper/azumi-master2011.pdf" target="_blank" rel="external">踏み台攻撃だけを抑制できるVMMレベルパケット・フィルタ[PDF]</a>,”<br>修士論文, 東京工業大学, 2011.</li>
<li>Bryan D. Payne, Martim D. P. de A. Carbone, and Wenke Lee,<br>“<a href="http://www.acsac.org/2007/papers/138.pdf" target="_blank" rel="external">Secure and Flexible Monitoring of Virtual Machines[PDF]</a>“,<br>Proceedings of the 23rd Annual Computer Security Applications Conference, pp. 385-397, Miami Beach, FL, 2007.</li>
<li>Bryan D. Payne,<br>“<a href="http://prod.sandia.gov/techlib/access-control.cgi/2012/127818.pdf" target="_blank" rel="external">Simplifying Virtual Machine Introspection Using LibVMI[PDF]</a>,”<br>SANDIA REPORT, 2012.</li>
<li>“Do we need the Kernel Debugging Block? - Rekall Memory Forensic Flamework,”<br><a href="http://www.rekall-forensic.com/posts/2014-02-21-do-we-need-kdbg.html" target="_blank" rel="external">http://www.rekall-forensic.com/posts/2014-02-21-do-we-need-kdbg.html</a></li>
<li>Amit Vasudevan, Ramesh Yerraballi,<br>“<a href="https://www.acsac.org/2005/papers/72.pdf" target="_blank" rel="external">Stealth Breakpoints[PDF]</a>,”<br>Proceedings of the 21st Annual Computer Security Applications Conference, pp. 381-392, AZ, USA, 2005.</li>
<li>Carsten Willems, Ralf Hund, and Thorsten Holz,<br>“<a href="https://www.hgi.rub.de/media/emma/veroeffentlichungen/2012/11/26/TR-HGI-2012-002.pdf" target="_blank" rel="external">CXPInspector: Hypervisor-Based, Hardware-Assisted System Monitoring[PDF]</a>,”<br>Technical Report TR-HGI-2012-002, Ruhr-Uni­ver­si­tät Bo­chum, Horst Görtz Institut für IT-Sicherheit(HGI), 2012.</li>
<li>Tamas K. Lengyel, Steve Maresca, Bryan D. Payne, George D. Webster, Sebastian Vogl, and Aggelos Kiayias,<br>“<a href="https://www.sec.in.tum.de/assets/Uploads/scalability-fidelity-stealth.pdf" target="_blank" rel="external">Scalability, Fidelity and Stealth in the DRAKVUF Dynamic Malware Analysis System[PDF]</a>,”<br>Proceedings of the 30th Annual Computer Security Applications Conference, pp. 386-395, NY, USA, 2014.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2015/01/31/xen-libvmi/" data-id="cjbiq70sp00248w7tdlbhks7h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-machine-introspection/">virtual machine introspection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sandbox-transparency" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/01/23/sandbox-transparency/">サンドボックスの透明性</a>
  

      </header>
    
    <time class="article-date" datetime="2015-01-23T14:45:59.000Z" itemprop="datePublished">01-23-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="VMI"><a href="#VMI" class="headerlink" title="VMI"></a>VMI</h1><p>仮想マシンモニタからゲストのリソースを監視・制御する技術をVMI(Virtual Machine Introspection)という．<br>その発祥は2003年に遡る．当時はハニーポットの研究が盛んな時期であり，VMIは仮想マシンにおける侵入検知を実現する手法として提案された．これはマルウェア解析の自動化に応用されており，仮想マシンモニタによるサンドボックスを構築し，VMIによってマルウェアの挙動を監視するというアプローチが一般的となっている．<br>さて，VMIにおける問題点にセマンティックギャップというものがある．原義は高級言語とハードウェアとの乖離であるが，OSと同じ粒度で情報を取得することのできるゲスト内部(in-the-box)とハードウェアの粒度で情報を取得することしかできないゲスト外部(out-of-the-box)の乖離という意味でも援用される．</p>
<h1 id="Transparent-Sandbox"><a href="#Transparent-Sandbox" class="headerlink" title="Transparent Sandbox"></a>Transparent Sandbox</h1><p>セマンティックギャップを解決する方法として，ゲスト内部にエージェントを挿入し，仮想マシンモニタに情報を送信するというアプローチが考えられる．<br>だがマルウェア解析において，ゲスト内部にエージェントを挿入することは，自らの姿を曝け出していることにほかならない．ファイルやサービス名，フックによって変化するAPIの挙動といったものは，マルウェアがエージェントと同じ権限で動作する限り避けられない．そもそも仮想マシンモニタは特権を有していたところで<code>RDTSC</code>や<code>ICEBP</code>などの命令，あるいはハードウェア名やIDTといった要素から検出される可能性を孕んでいる．そのため，ゲスト内部にエージェントを挿入することは，仮想マシンモニタがマルウェアから検出される可能性を高めることに繋がる．フォレンジックにおける完全性(integrity)のためにも，ゲスト内部にエージェントを挿入すべきではないと私は考える．<br>この議論に関して，マルウェアから検出されない仮想マシンモニタをtransparent sandbox（透明なサンドボックス？）といい，仮想マシンモニタの検出を試みるマルウェアをevasive malwareという．<br>ではどのような仮想マシンモニタがより「透明」に近いのか．</p>
<h1 id="仮想マシンモニタの歴史"><a href="#仮想マシンモニタの歴史" class="headerlink" title="仮想マシンモニタの歴史"></a>仮想マシンモニタの歴史</h1><p>ここでPopekとGoldbergの仮想化要件に立ち返ると，ベアメタルな仮想マシンモニタは等価性(equivalence)，資源管理(resource control)，効率性(efficiency)の三原則を実現しており，なおかつユーザセンシティブ命令が特権命令でなければならない．センシティブ命令かつ特権命令でなければ，例外によって仮想マシンモニタに通知することができないためである．<br>だが，以前のx86アーキテクチャはこの要件を満たしていなかった．そこで，ニ種類の解決方法が編み出された．<br>一つ目はバイナリ変換(binary translation)による完全仮想化である．これはソフトウェアで命令をエミュレートする手法で，QEMUやVMwareが該当する．QEMUは全ての命令を中間コードに変換するのに対し，VMwareはPopekとGoldbergの仮想化要件を満たさない命令をライブラリ呼び出しに変換する．<br>二つ目は準仮想化である．これはPopekとGoldbergの仮想化要件を満たさない命令に差し掛かると仮想マシンモニタに通知されるようゲストOSのカーネルを修正する手法で，Xenが該当する．<br>ではバイナリ変換による完全仮想化とカーネル書き換えによる準仮想化のどちらがより「透明」に近いのか．<br>その前にIntel VT-xについて考えなければならない．Intel VT-xはCPUのモード切り替えによってセンシティブ命令かつ特権命令でない命令のトラップを実現する拡張機能である．すなわちPopekとGoldbergの仮想化要件を満たすハードウェア側からのアプローチである．これにより準仮想化カーネルの必要はなくなった．エージェントの挿入が「透明」性に関わるのと同様，カーネルの書き換えは仮想マシンモニタを検出する手掛かりとなる．<br>そのためマルウェア解析においては，バイナリ変換による完全仮想化か，Intel VT-xによる完全仮想化が前提となる．なおKVMはIntel Vt-xを前提としているが，部分的にQEMUを用いている．<br>ではどちらの手法がより「透明」に近いのか．</p>
<h1 id="バイナリ変換とIntel-VT-x"><a href="#バイナリ変換とIntel-VT-x" class="headerlink" title="バイナリ変換とIntel VT-x"></a>バイナリ変換とIntel VT-x</h1><p>Christopher KruegelはWineのようなシステムコール単位のエミュレーションあるいはフックは情報量として不十分であり，またIntel VT-xによる完全仮想化はRedPillのようなアプローチで検出可能であることから，バイナリ変換による完全仮想化すなわちQEMUを支持している．<br>システムコール単位の監視は<code>IsDebuggerPresent</code>のようなカーネルモードに遷移せず構造体を参照するだけの処理を見逃してしまう．システムコールのフックを用いた研究や製品は多数存在するが，それらは不完全である．この点で私は氏と意見を一にするが，バイナリ変換がより「透明」に近いかどうかは検討の余地があるだろう．寧ろ氏は実行パスの拡張がより容易に行えるがゆえにバイナリ変換を支持しているのだろうということは読み取れるが，氏がチーフサイエンティストを務めるLastlineの製品がQEMUをベースとしていることもあり，些かポジショントークのようにも感じられる．<br>このような論調でバイナリ変換とIntel VT-xを二項対立の図式に落とし込んでいる論文が数多く見られる．しかし，どちらがより「透明」に近いのかという議論はナンセンスであろう．<br>ゲスト内部にエージェントを挿入することで，果たして本当にマルウェアから検出されやすくなるのかと言うと，それは飽くまで可能性でしかない．だがゲスト内部にエージェントを挿入しないという選択で，その問題は検討項目から外すことができる．一方で，バイナリ変換であるという理由でIntel VT-xを用いた仮想マシンモニタよりも検出されにくいといったことはない．逆もまた然りである．<br>そしてそもそも，ネットワーク経由で仮想マシンモニタを検出するという手法がある以上，完全に「透明」なサンドボックスは実現不可能であるとされる．<br>ゆえにそれぞれのアプローチについて「透明」性の他にもメリット・デメリットを検討し，なおかつ両者を接合するようなシステムこそが望ましい．</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li>Tal Garfinkel, Mendel Rosenblu,<br>“<a href="http://suif.stanford.edu/papers/vmi-ndss03.pdf" target="_blank" rel="external">A Virtual Machine Introspection Based Architecture for Intrusion Detection[PDF]</a>,”<br>Proceedings of the 10th Annual Network and Distributed System Security Symposium, pp. 191–206, SD, USA, 2003.</li>
<li>Gerald J. Popek, Robert P. Goldberg,<br>“<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.141.4815&amp;rep=rep1&amp;type=pdf" target="_blank" rel="external">Formal Requirements for Virtualizable Third Generation Architectures[PDF]</a>,”<br>Communications of the ACM CACM Homepage archive, Vol. 17, Issue. 7, pp. 412-421, NY, USA, 1974.</li>
<li>John Scott Robin, Cynthia E. Irvine,<br>“<a href="http://www.cse.psu.edu/~bhuvan/teaching/spring06/papers/analysis-pentium.pdf" target="_blank" rel="external">Analysis of the Intel Pentium’s Ability to Support a Secure Virtual Machine Monitor[PDF]</a>,”<br>Proceedings of the 9th conference on USENIX Security Symposium, Vol. 9, pp. 10-10, CA, USA, 2000.</li>
<li>Christopher Kruegel,<br>“<a href="https://www.blackhat.com/docs/us-14/materials/us-14-Kruegel-Full-System-Emulation-Achieving-Successful-Automated-Dynamic-Analysis-Of-Evasive-Malware-WP.pdf" target="_blank" rel="external">Full System Emulation: Achieving Successful Automated Dynamic Analysis of Evasive Malware[PDF]</a>,”<br>Black Hat USA, 2014.</li>
<li>Tal Garfinkel, Keith Adams, Andrew Warfield and Jason Franklin,<br>“<a href="http://www.cs.cmu.edu/~jfrankli/hotos07/vmm_detection_hotos07.pdf" target="_blank" rel="external">Compatibility is Not Transparency: VMM Detection Myths and Realities[PDF]</a>,”<br>Proceedings of the 11th USENIX workshop on Hot topics in operating systems, No. 6, CA, USA, 2007.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2015/01/23/sandbox-transparency/" data-id="cjbiq70sb001a8w7t8ff2uvrx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dynamic-binary-translation/">dynamic binary translation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-machine-introspection/">virtual machine introspection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-v2e" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2014/12/09/v2e/">マルウェア解析におけるRecord and Replayの設計</a>
  

      </header>
    
    <time class="article-date" datetime="2014-12-09T09:00:00.000Z" itemprop="datePublished">12-09-2014</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>“<a href="http://www.cl.cam.ac.uk/research/srg/netos/vee_2012/papers/p227.pdf" target="_blank" rel="external">V2E: Combining Hardware Virtualization and Software Emulation for Transparent and Extensible Malware Analysis[PDF]</a>“という論文を通して，Record and Replayを用いた解析環境の設計を学ぶ．</p>
<h1 id="著者"><a href="#著者" class="headerlink" title="著者"></a>著者</h1><p>この論文のラストオーサーであるYinはSyracuse Universityの助教である．彼はテイント解析の第一人者として知られ，現在は<a href="https://code.google.com/p/decaf-platform/" target="_blank" rel="external">DECAF</a>の開発を主導している．またBitBlaze ProjectのDawn Songや，マルウェア解析の大御所であるChristopher Kruegelと過去に共著を出している．<br>ファーストオーサーのYanは提案手法をAndroidに適用し，2013年に博士論文を著している．Android向けの拡張にあたっては，DECAFのサブプロジェクトであるDroidScopeを用いているようだ．</p>
<h1 id="Record-and-Replay"><a href="#Record-and-Replay" class="headerlink" title="Record and Replay"></a>Record and Replay</h1><p>あるいはLogging and Replay, Lockstep, 順序再演法，最小情報トレースなどと呼ばれるこれらは，仮想マシンモニタ上のイベントを記録し，再生するための技術である．乱暴に言うとhistoryからdockerfileやvagrantfileを作成し，deployするようなものだ．<br>一般にステートマシンにおける命令の出力は，内部状態から一意に与えられる．そこで，ある環境の初期状態と入力のみを記録(Record)し，同じ環境を別の環境の上に再生(Raplay)するといった試みがなされてきた．実マシンにおいては，時刻や割り込みなどの非決定性とその記録の困難性からRecord and Replayは不可能であるとされる．だが，仮想マシンモニタの世界ではこれらの問題をある程度無視できる．実際，VMware Workstationなどにこの機能は実装されている．<br>本論文では，マルウェア解析に求められるサンドボックスの特性を加味したRecord and Replayについて論じられている．かつて大居さん(<a href="https://twitter.com/a4lg" target="_blank" rel="external">@a4lg</a>)が研究されていた内容に近い．</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>マルウェアを解析するためのサンドボックスは検出不可能(transparent)であり，なおかつ拡張可能であるべきだ．<br>いかに仮想マシンモニタの存在を隠蔽しようと，Timing Attackなどが成り立つ以上，transparentなサンドボックスを実現することは不可能である．しかし，Intel VTなどハードウェア仮想化技術を用いることで，ほぼtransparentな環境を作り出すことは可能である．例えば，<a href="http://ether.gtisc.gatech.edu/" target="_blank" rel="external">Ether</a>は命令・システムコール単位の解析機能を備えているが，Xenをベースに高いtransparent性を実現している．<br>だが，ハードウェア仮想化技術に依存した解析環境には拡張性の点で問題がある．特に，instrumentationによる詳細な解析が不可能であるという点は，大きな痛手である．<br>他方，QEMUなどのソフトウェアエミュレーションは動的バイナリ変換を用いることでDBI(dynamic binary instrumentation)と解析効率の向上を実現している．しかし，transparentなサンドボックスには至れない．<br>QEMUの動的バイナリ変換はバイナリをコードブロック単位で変換し，softmmuからTLBを参照してアドレス変換を行うというものだ．<br>そしてその性質から，以下のような自己書き換えコードによって検出されうる．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">__asm&#123;</div><div class="line">	xor eax, eax</div><div class="line">	mov edi, target</div><div class="line">	mov esi, copy_insn</div><div class="line">	mov ecx, 3</div><div class="line"></div><div class="line">target:</div><div class="line">	rep movsw		// f3 66 a5</div><div class="line">	jmp qemu_found		// eb XX</div><div class="line">	nop			// 90</div><div class="line"></div><div class="line">non_qemu:</div><div class="line">	...</div><div class="line"></div><div class="line">qemu_found:</div><div class="line">	...</div><div class="line"></div><div class="line">copy_insn:</div><div class="line">	_emit 0xeb		// eb</div><div class="line">	_emit 0x01		// 01</div><div class="line">	_emit 0x90		// 90</div><div class="line">	_emit 0xeb</div><div class="line">	_emit 0x01</div><div class="line">	_emit 0x90</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>実マシンでは，<code>ecx*word=6</code>バイトが1回で書き換わるが，QEMUの動的バイナリ変換では2バイトずつ3回で書き換わる．そのため，1回目の書き換えで<code>0xeb 0x01 0xa5</code>すなわち<code>jmp +01</code>になってしまい，<code>qemu_found</code>にジャンプしてしまう．<br>その他には，ページ境界を越えてブロックの変換が行われた場合にページフォルトが発生してしまうことも考えられるし，ブロック境界でのみ割り込みが行われる，CPUサイクルの消費が著しいといった実マシンとの相違点もある．<br>さらに問題なのが，フラグの遅延評価だ．例えば，<code>cmp</code>と<code>jz</code>の組み合わせなどの条件分岐は，EFLAGSを更新する．だが，QEMUにおいては<code>cmp</code>が実行される段階でEFLAGSの計算は行われない．実際に計算されるのは<code>jz</code>の実行時，それも分岐を決定するためのZFのみが計算される．この設計はエミュレーションの高速化に寄与しているが，もちろん検出に用いることが可能だ．<br>当然ながら命令のエミュレーション自体にも限界がある．SIMDさえ厳しいのだ，システム管理モードやIntel TXTなんてものは考えたくないだろう．<br>このように，QEMUによるエミュレーションが検出される余地は枚挙に暇がない．<br>なお，解析環境検出をテーマとした最近の研究では，第2回システム系論文輪読会で<a href="http://ntddk.github.io/barecloud/">紹介した</a>BareCloudや忠鉢さん(<a href="https://twitter.com/yuzuhara" target="_blank" rel="external">@yuzuhara</a>)のTENTACLEなどがある．</p>
<h1 id="研究目的"><a href="#研究目的" class="headerlink" title="研究目的"></a>研究目的</h1><p>ハードウェア仮想化技術を用いる解析環境とソフトウェアエミュレーションを用いる解析環境にはそれぞれ問題がある．そこで，ハードウェア仮想化技術を用いる解析環境でRecordを行い，ソフトウェアエミュレーションを用いる解析環境でReplayを行うことで，検出不可能性と拡張可能性という二つの目的について達成したのが，今回紹介するV2Eである．</p>
<h1 id="形式的定義"><a href="#形式的定義" class="headerlink" title="形式的定義"></a>形式的定義</h1><p>本論文におけるRecord and Replayの設計はどのようなものか．<br>Recorderにおける遷移関数<code>f</code>について，毎時<sub><code>i</code></sub>におけるプログラムの状態を<code>S</code><sub><code>i</code></sub>とし，入力を<code>I</code><sub><code>i</code></sub>とする．すなわち<code>f</code>は<code>S</code><sub><code>i</code></sub><code>= f(S</code><sub><code>i-1</code></sub><code>, I</code><sub><code>i-1</code></sub><code>)</code>と表される．<br>次にReplayerにおける遷移関数<code>f&#39;</code>についてプログラムの初期状態を<code>S</code><sub><code>0</code></sub>とし，全ての入力を<code>I</code>としたとき，<code>f = f&#39;</code>と言えないだろうか．<br>これは二つのチューリング機械の同値性が解決可能であるかという問題に相当する．だが<code>EQ</code><sub><code>TM</code></sub><code>= {(M</code><sub><code>1</code></sub><code>, M</code><sub><code>2</code></sub>)<code>|M</code><sub><code>1</code></sub><code>とM</code><sub><code>2</code></sub><code>はTMであり，L(M</code><sub><code>1</code></sub><code>) = L(M</code><sub><code>2</code></sub><code>)}</code>は判定不可能とされ（『計算理論の基礎』における定理5.4），実装上でもハードウェアの割り込みなどの要因から<code>f != f&#39;</code>となってしまう．<br>そこでV2Eは，プログラムの初期状態と全ての入力を保存することに加え，<code>S</code><sub><code>j</code></sub><code>= S&#39;</code><sub><code>j</code></sub>となるような<sub><code>j</code></sub>について状態の変化を保存することにした．これは<code>⊿</code><sub><code>j</code></sub><code>= S</code><sub><code>j</code></sub><code>- S</code><sub><code>j-1</code></sub>と表される．<br>ここで，新たな遷移関数<code>f&#39;</code><sub><code>r</code></sub>を<code>S&#39;</code><sub><code>i</code></sub><code>= f&#39;</code><sub><code>r</code></sub><code>(S&#39;</code><sub><code>i-1</code></sub><code>, I</code><sub><code>i-1</code></sub><code>, ⊿</code><sub><code>i</code></sub><code>)</code>として定義する．これは，<code>⊿</code><sub><code>i</code></sub><code>!= null</code>のとき<code>S&#39;</code><sub><code>i-1</code></sub><code>+ ⊿</code><sub><code>i</code></sub>と同値であり，それ以外について<code>f&#39;(S</code><sub><code>i-1</code></sub><code>, I</code><sub><code>i-1</code></sub><code>)</code>と同値をとる．<br>なお，<code>S</code><sub><code>0</code></sub>, <code>I</code>, <code>⊿</code>および<code>f&#39;</code><sub><code>r</code></sub>, <code>S&#39;</code><sub><code>i</code></sub><code>= S</code><sub><code>i</code></sub>は<code>i ∈ [0, n]</code>について恒真である．<br>これを実装に起こすと，特定の命令やイベントが正しくエミュレート可能な場合は単にそれらをエミュレートし，そうでなければ状態の変化を記録し，Replayにあたって変更を適用するというアプローチになる．</p>
<h1 id="理論と実際"><a href="#理論と実際" class="headerlink" title="理論と実際"></a>理論と実際</h1><p>プログラムの大部分を占める<code>mov</code>, <code>push</code>, <code>pop</code>などのデータ転送命令，<code>call</code>, <code>ret</code>, <code>jz</code>, <code>jmp</code>などの制御転送命令，<code>add</code>, <code>shl</code>などの整数演算命令におけるエミュレーションは失敗しないものと見做せる．これらはそのままRecorderでエミュレートされる．<br>一方で，割り込み，MMIO, Port IO, DMA, TSCについては，V2Eは既存研究を踏襲し，監視領域においてのみこれらをRecordするようになっている．<br>では，例外，モデル固有レジスタ，<code>cpuid</code>はどうすべきだろうか．既存手法は，これらのエミュレーションは困難であるという理由から，そもそも入力として扱わない戦略を採っていたようだ．V2Eではこれらを<code>⊿</code>, すなわちエミュレートが困難な状態の変化としてRecordすることで，Replayの正確性を高めている．<br>次に問題となるのが浮動小数点演算とSIMDの扱いだ．MMXやSSEを正確にエミュレートするのは難しい．だが，<code>⊿</code>として命令の結果を記録する設計は大幅なパフォーマンスの低下を招く．そこでV2EはReplayにあたってこれらの命令をパススルーする．もちろん，ReplayerはSIMDをサポートしているマシンで実行されることが前提にある．</p>
<h1 id="Transparent-Recorder"><a href="#Transparent-Recorder" class="headerlink" title="Transparent Recorder"></a>Transparent Recorder</h1><p>RecorderはKVMを用いて実装されている．<br>V2EはRecord対象の領域とそれ以外のシステムを分割するため，TDP(two dimensional paging)を用いている．何のことかと思ったら，Intel EPTやAMD NPTの総称らしい．<br><img src="/image/tdp.jpg"><br>要するに，TDPとは仮想マシンと物理マシン間のページテーブルのことだ．通常のページングでは，メモリアクセスに応じてMMUによってページテーブルが参照され，仮想アドレスが物理アドレスへと変換される．TDPでは，ゲストマシンからの仮想メモリ空間へのアクセスに応じてCR3にセットされたページテーブルが参照され，ゲスト物理アドレスがホスト物理アドレスへと変換される．<br>この仕組を用いたV2Eは，<strong>監視対象用のTDPテーブルと，それ以外用のTDPテーブルを別々に作成する</strong>．マルウェアに属するページはCR3の監視に基づき監視対象用のTDPテーブルに書き込まれる．マルウェアとそれ以外の部分のインタラクションはTDPページフォルトや<code>VMExit</code>によって媒介される．共有されるデータは読み取り専用として双方に与えられる．なお，TDPページフォルトに応じてCPUの状態が入力<code>I</code><sub><code>i</code></sub>として保存される．</p>
<h1 id="Precise-Replayer"><a href="#Precise-Replayer" class="headerlink" title="Precise Replayer"></a>Precise Replayer</h1><p>ReplayerはTEMUを用いて実装されている．バイナリ変換器に中間表現がなく，単純に古いQEMU 0.9.1をベースとしているのが玉に瑕だが，TEMUは動的テイント解析に求められる機能をほぼ網羅している．<br>TEMUはプラグインを共有ライブラリとしてロードし，コールバック関数からテイント解析の機能を呼び出すプラットフォームとなっている．V2EのReplayerは既存のプラグインであるtracecap, unpackerを用いる．だがRecordされたログには監視対象の情報のみが記述されているため，<br><code>return ((*TEMU_cpu_hflags &amp; HF_CPL_MASK) != 3)</code>といった，現在実行しているコードが解析対象のものかどうか判定するコードは除去されているようだ．TEMUのプラグインについては，こうした僅かな変更しか施されていない．<br>一方でその下で動くQEMUには結構手が加えられている．フラグの遅延評価は廃止され，ページフォルト以外の例外は除去されており，SIMDについては独自のヘルパー関数が追加されたようだ．QEMUのdyngenに手を加えるのはなかなか骨の折れる作業だと思う．<br>さて，Replayを行うためには，ReplayerはRecorderと同様のページングの仕組みをエミュレーションによって再現しなければならない．そこで，V2Eは物理ページコンテナという仕組みを用いている．これは，物理ページがログからロードされていることを示すものである．通常，物理ページコンテナは監視対象用のTDPテーブルを複製する．Replayされたプログラムが物理ページコンテナに存在しないページにアクセスした場合，Replayerは適切なタイミングでログからCPUの状態を復元し，ロードするようになっている．<br>V2Eにおけるテイント解析はおそらく，マルウェアのメモリ領域を正確に把握するためのものではない．それは，Recorderの段階でTDPテーブルの分割というアプローチによって実現されるべきものだからだ．TEMUのプラグインを使いたかったのだろうが，論文中からはあまりテイント解析を導入することのメリットが読み取れなかった．ここでのテイント解析は解析環境検出の対策に先立つものとして設定されているのだろうか．</p>
<h1 id="評価"><a href="#評価" class="headerlink" title="評価"></a>評価</h1><p>解析環境検出については問題なし．<code>cpuid</code>, <code>rdtsc</code>, <code>cmpxch8b</code>, <code>icbp</code>, <code>rep stosb</code>, <code>fnstcw</code>といった命令や，一般保護例外などについてテストされている．なお，<code>rdtsc</code>については<code>VMRESUME</code>前にホストのTSCを参照することで対応している．<br>in-the-wildのマルウェアについても実験が行われており，アンパッカーとして期待できるパフォーマンスを見せている．<br>Recordにおける速度だが，コンテキストスイッチが頻繁に発生するカーネルモードルートキットで17倍，Internet Explorerで5倍と高速だ．KVMのシングルステップモードには3000倍のオーバーヘッドがあると言うのに．<br>全体的にpositiveな結果で，かなり良い．</p>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>マルウェアによる解析環境検出に対して，復数の環境を組み合わせたRecord and Replayを用いる研究について紹介した．何より，監視対象とそれ以外で別個にTDPテーブルを作るというアプローチが素晴らしい．自分も研究でテイント解析を扱っているが，この流れを包摂していきたい．<br>ただ，これはサンドボックス全般に言えることなのだが，感染ホストにおけるユーザーのブラウザ操作が条件分岐に影響するMITBマルウェアについて，どう対処すべきなのだろうか．正常系のユーザーのブラウザ操作をデータセットとしてRecorderに与えたいところだが，果たしてどうなるのか．<br>このエントリは<a href="http://www.adventar.org/calendars/440" target="_blank" rel="external">システム系論文紹介 Advent Calendar 2014</a>の9日目として書かれた．</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li>Lok-Kwong Yan, Manjukumar Jayachandra, Mu Zhang and Heng Yin,<br>“<a href="http://www.cl.cam.ac.uk/research/srg/netos/vee_2012/papers/p227.pdf" target="_blank" rel="external">V2E: Combining Hardware Virtualization and Software Emulation for Transparent and Extensible Malware Analysis[PDF]</a>,”<br>Proceedings of the 8th ACM SIGPLAN/SIGOPS conference on Virtual Execution Environments, pp. 227-238, NY, USA, 2012.</li>
<li>George W. Dunlap, Samuel T. King, Sukru Cinar, Murtaza A. Basrai and Peter M. Chen,<br>“<a href="http://web.engr.illinois.edu/~kingst/Research_files/dunlap02.pdf" target="_blank" rel="external">ReVirt: Enabling Intrusion Analysis through Virtual-Machine Logging and Replay[PDF]</a>,”<br>Proceedings of the 2002 Symposium on Operating Systems Design and Implementation, pp. 211-224, NY, USA, 2002.</li>
<li>A. Dinaburg, P. Royal, M. Sharif and W. Lee.<br>“<a href="http://ether.gtisc.gatech.edu/ether_ccs_2008.pdf" target="_blank" rel="external">Ether: malware analysis via hardware virtualization extensions[PDF]</a>,”<br>Proceedings of the 15th ACM Conference on Computer and Communications Security, pp. 51–62, NY, USA, 2008.</li>
<li>大居司,<br>“<a href="http://www.slideshare.net/a4lg/a-new-tracer-for-reverse-engineering" target="_blank" rel="external">リバースエンジニアリングのための新しいトレース手法</a>,”<br>PacSec 2010, 東京, 日本, 2010.</li>
<li>Dhilung Kirat, Giovanni Vigna, and Christopher Kruegel,<br>“<a href="https://www.usenix.org/system/files/conference/usenixsecurity14/sec14-paper-kirat.pdf" target="_blank" rel="external">BareCloud: Bare-metal Analysis-based Evasive Malware Detection[PDF]</a>,”<br>Proceedings of the 23rd USENIX conference on Security Symposium, pp. 287-301, CA, USA, 2014.</li>
<li>忠鉢洋輔, 愛甲健二,<br>“<a href="https://pacsec.jp/psj14/PSJ2014_chubachi_final_ja.pdf" target="_blank" rel="external">TENTACLE: Environment-Sensitive Malware Palpation[PDF]</a>,”<br>PacSec Tokyo 2014, 東京, 日本, 2014.</li>
<li>M. Siper,<br>“<a href="http://www.cs.virginia.edu/~robins/Sipser_2006_Second_Edition_Problems.pdf" target="_blank" rel="external">Introduction to the Theory of Computation. International</a>,”<br>Thomson Publishing, 1996.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2014/12/09/v2e/" data-id="cjbiq70so00208w7tqt0ji00u" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dynamic-binary-translation/">dynamic binary translation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/taint-analysis/">taint analysis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-machine-introspection/">virtual machine introspection</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 ntddk<br>
      <a href="https://github.com/ntddk/hexo-theme-jathena" target="_blank">JAthena</a> by <a href="https://ntddk.github.io" target="_blank">ntddk</a> | Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>

<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
</body>
</html>