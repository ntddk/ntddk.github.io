<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tag: reversing | 一生あとで読んでろ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="技術ブログ">
<meta property="og:type" content="website">
<meta property="og:title" content="一生あとで読んでろ">
<meta property="og:url" content="http://ntddk.github.io/tags/reversing/index.html">
<meta property="og:site_name" content="一生あとで読んでろ">
<meta property="og:description" content="技術ブログ">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一生あとで読んでろ">
<meta name="twitter:description" content="技術ブログ">
  
  
  <link href="//fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">一生あとで読んでろ</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技術ブログ</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-home-icon" class="nav-icon" href="/"></a>
        
          <a id="nav-about-icon" class="nav-icon" href="/about"></a>
        
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-def-con-ctf-qualifier-2019-round-up" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2019/05/13/def-con-ctf-qualifier-2019-round-up/">DEF CON CTF Qualifier 2019 Round-up</a>
  

      </header>
    
    <time class="article-date" datetime="2019-05-13T11:00:00.000Z" itemprop="datePublished">05-13-2019</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’ve participated in DC 27 QUALS as a member of Team Enu (30th place) and solved speedrun-008, speedrun-010, know_your_mem, and vitor. I shall write down my impressions.</p>
<h1 id="speedrun-008"><a href="#speedrun-008" class="headerlink" title="speedrun-008"></a>speedrun-008</h1><p>Leaking stack canary + ROP. やるだけ。</p>
<h1 id="speedrun-010"><a href="#speedrun-010" class="headerlink" title="speedrun-010"></a>speedrun-010</h1><p>UAF + One gadget RCE. やるだけ。</p>
<h1 id="know-your-mem"><a href="#know-your-mem" class="headerlink" title="know_your_mem"></a>know_your_mem</h1><p>Binary search for mmap-ed regions.</p>
<h2 id="vitor"><a href="#vitor" class="headerlink" title="vitor"></a>vitor</h2><p>A long journey through Android/Crypto/shellcode/ROP/JS/Z3. JS part was analyzed by my teammate. To set DWORD PTR constraints with a left shift is a bit confusing: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">ecx = 0;</div><div class="line">edi = (_DWORD *)(flag + 0x10);</div><div class="line">edx = 2;</div><div class="line">do</div><div class="line">&#123;</div><div class="line">    ecx ^= *edi;</div><div class="line">    edi += 4;</div><div class="line">    --edx;</div><div class="line">&#125;</div><div class="line">while (edx);</div><div class="line">'''</div><div class="line"></div><div class="line">ecx = <span class="number">0</span></div><div class="line">ecx ^= (flag[<span class="number">2</span> * <span class="number">0x10</span> + <span class="number">0</span>] &lt;&lt; <span class="number">24</span> | flag[<span class="number">2</span> * <span class="number">0x10</span> + <span class="number">1</span>] &lt;&lt; <span class="number">16</span> | flag[<span class="number">2</span> * <span class="number">0x10</span> + <span class="number">2</span>] &lt;&lt; <span class="number">8</span> | flag[<span class="number">2</span> * <span class="number">0x10</span> + <span class="number">3</span>] &lt;&lt; <span class="number">0</span>)</div><div class="line">ecx ^= (flag[<span class="number">1</span> * <span class="number">0x10</span> + <span class="number">0</span>] &lt;&lt; <span class="number">24</span> | flag[<span class="number">1</span> * <span class="number">0x10</span> + <span class="number">1</span>] &lt;&lt; <span class="number">16</span> | flag[<span class="number">1</span> * <span class="number">0x10</span> + <span class="number">2</span>] &lt;&lt; <span class="number">8</span> | flag[<span class="number">1</span> * <span class="number">0x10</span> + <span class="number">3</span>] &lt;&lt; <span class="number">0</span>)</div><div class="line">s.add(ecx == <span class="number">0x42183313</span>)</div></pre></td></tr></table></figure>
<h1 id="gloryhost"><a href="#gloryhost" class="headerlink" title="gloryhost"></a>gloryhost</h1><p>I couldn’t find a way to get a flag within the time. I wish I could have noticed that it was a side-channel (especially, Spectre) task when I found the reference to <code>rdtsc</code>.<br>While Ubuntu 16.04 implicitly specifies <code>-N</code> as the argument of <code>nc</code> command, Ubuntu 18.04 does not, resulting waste of time in find a way to get a message from the exported function <code>this_is_what_ive_got()</code>. The concept of it was interesting, but such an environment-dependent behavior is not my preference.</p>
<h1 id="RTOoOS"><a href="#RTOoOS" class="headerlink" title="RTOoOS"></a>RTOoOS</h1><p>Hypervisor.framework-based VM escape task. The first attack surface is <code>export</code>. I was exhausted when I got a dump of <code>honcho</code> … and couldn’t solve it within the time.</p>
<h1 id="Random-Thoughts"><a href="#Random-Thoughts" class="headerlink" title="Random Thoughts"></a>Random Thoughts</h1><p>There wasn’t a very good task, but Speedruns are good for beginners and retirees (me) to practice as they can be solved in a straightforward way. The top-tier teams have solved Speedruns in about 5 minutes, but I took one and a half hours to solve ‘em. 弱すぎますね。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2019/05/13/def-con-ctf-qualifier-2019-round-up/" data-id="cjvozzsrt000lxo7tvylve3w1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/exploitation/">exploitation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-the-art-of-de-obfuscation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2018/10/15/the-art-of-de-obfuscation/">The Art of De-obfuscation</a>
  

      </header>
    
    <time class="article-date" datetime="2018-10-15T11:00:00.000Z" itemprop="datePublished">10-15-2018</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>Last week, I gave a talk at <a href="https://wakate.org/2018/07/28/51th-general/" target="_blank" rel="external">第51回 情報科学若手の会</a>.</p>
<script async class="speakerdeck-embed" data-id="d581afa782624a629964475fd0e0aa98" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>

<p>I am pleased to be able to tell the relationship between the artisanship of reverse engineering and the principle of computer science. The questions asked at the site are as follows:</p>
<table>
<thead>
<tr>
<th>Q</th>
<th>A</th>
</tr>
</thead>
<tbody>
<tr>
<td>Does the “operation” here mean mathematical operation or anything else?</td>
<td>In this presentation, the word “operation” corresponds to assembly or BitVector operations.</td>
</tr>
<tr>
<td>How much advanced obfuscation is spreading?</td>
<td>Although it is not widely used in malware for masses, it is common in government-grade malware e.g. APT28.</td>
</tr>
</tbody>
</table>
<p>Also, I got the feedback:</p>
<p><blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="en" dir="ltr">Hello - We had done similar work on JEB in 2017 (plugins for our native decompilers) to perform: 1) opaque predicate remove (see <a href="https://t.co/pAp5dD25XL" target="_blank" rel="external">https://t.co/pAp5dD25XL</a>) and 2) CFG un-flattening (see <a href="https://t.co/3fl5Qpr4g7" target="_blank" rel="external">https://t.co/3fl5Qpr4g7</a>) – check out the videos.</p>&mdash; JEB Decompiler (@jebdec) <a href="https://twitter.com/jebdec/status/1049358773045751808?ref_src=twsrc%5Etfw" target="_blank" rel="external">2018年10月8日</a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<p>It sounds great.</p>
<p>In the 会, I’ve enjoyed discussing various topics related to information science:</p>
<ul>
<li><a href="http://polyhedral.info/" target="_blank" rel="external">Polyhedral optimization</a>, a method to optimize a certain kind of loop called SCoP using a linear algebra model.</li>
<li><a href="https://arxiv.org/abs/1809.04098" target="_blank" rel="external">The paper</a> about principle of adversarial examples focusing on Fourier basis functions.</li>
<li><a href="http://www.colm.net/open-source/ragel/" target="_blank" rel="external">Ragel</a>, the parser generator used in the Ruby community. It was news to me.</li>
<li>The hypothesis that the cerebellum may be using reinforcement learning.</li>
<li>The weakness of random number generator of Dragon Quest 4 (PS version).</li>
<li>About quantitative indicator of the beautiness of exploit code.</li>
<li>Some binary analysis platform written in Rust e.g. <a href="https://github.com/danleh/wasabi" target="_blank" rel="external">wasabi</a>, <a href="https://github.com/falconre/falcon" target="_blank" rel="external">falcon</a> and <a href="https://github.com/falconre/finch" target="_blank" rel="external">finch</a>.</li>
<li>The fact that <a href="https://pokemongo.gamepress.gg/s2-cells-foundation-pokemon-go-design" target="_blank" rel="external">Pokemon Go players are knowledgeable about Hilbert curve</a>.</li>
</ul>
<p>If these topics capture your interest, why don’t you join the next 会?</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2018/10/15/the-art-of-de-obfuscation/" data-id="cjvozzssh001vxo7tubab7ltk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/program-synthesis/">program synthesis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-def-con-ctf-qualifier-2018-round-up" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2018/05/14/def-con-ctf-qualifier-2018-round-up/">DEF CON CTF Qualifier 2018 Round-up</a>
  

      </header>
    
    <time class="article-date" datetime="2018-05-14T11:00:00.000Z" itemprop="datePublished">05-14-2018</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>This is too brief to be called write-up. But I’m tired …</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>I’ve participated in DEF CON CTF Qualifier 2018 as a member of a certain team, ignominious 40th place. But somehow I solved 3 tasks:</p>
<ul>
<li>ELF Crumble</li>
<li>babypwn1805</li>
<li>elastic cloud compute (memory) corruption</li>
</ul>
<p>I write down my impressions.</p>
<h1 id="ELF-Crumble"><a href="#ELF-Crumble" class="headerlink" title="ELF Crumble"></a>ELF Crumble</h1><p>This is a task to combine and execute 8 binary fragments correctly. I wrote damn brute-force solver for this, 脳が死んでいるので．</p>
<h1 id="babypwn1805"><a href="#babypwn1805" class="headerlink" title="babypwn1805"></a>babypwn1805</h1><p>A blind pwn task. I accidentally found offset <code>-0x38</code> to the GOT entry of <code>read</code>. Then I wrote the probabilistic solver.</p>
<h1 id="elastic-cloud-compute-memory-corruption"><a href="#elastic-cloud-compute-memory-corruption" class="headerlink" title="elastic cloud compute (memory) corruption"></a>elastic cloud compute (memory) corruption</h1><p>A VM escape task.</p>
<p>We were given <code>qemu-system-x86_64</code> binary with vulnerable PCI device named <code>ooo</code>.　Notable functions are as follows:</p>
<table>
<thead>
<tr>
<th>function</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sub_6E61F4</code></td>
<td>correspond to <code>ooo_mmio_write</code></td>
</tr>
<tr>
<td><code>sub_6E613C</code></td>
<td>correspond to <code>ooo_mmio_read</code></td>
</tr>
<tr>
<td><code>sub_6E64A5</code></td>
<td>invokes <code>system(&quot;cat ./flag&quot;)</code></td>
</tr>
</tbody>
</table>
<p>What matters is use-after-free vulnerability in:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//----- (00000000006E61F4) ----------------------------------------------------</span></div><div class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">sub_6E61F4</span><span class="params">(__int64 opaque, __int64 addr, __int64 value, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd; <span class="comment">// eax</span></div><div class="line">...</div><div class="line"></div><div class="line">  *(_QWORD *)&amp;n[<span class="number">4</span>] = value;</div><div class="line">  cmd = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr &amp; <span class="number">0xF00000</span>) &gt;&gt; <span class="number">20</span>;</div><div class="line">  <span class="keyword">switch</span> ( cmd )</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">1u</span>:</div><div class="line">          <span class="built_in">free</span>(qword_1317940[((<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr &amp; <span class="number">0xF0000</span>) &gt;&gt; <span class="number">16</span>]);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="number">2u</span>:</div><div class="line">          v12 = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr &amp; <span class="number">0xF0000</span>) &gt;&gt; <span class="number">16</span>;</div><div class="line">          v8 = addr;</div><div class="line">          <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)qword_1317940[v12] + (<span class="keyword">signed</span> __int16)addr, &amp;n[<span class="number">4</span>], size);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="number">0u</span>:</div><div class="line">          idx = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr &amp; <span class="number">0xF0000</span>) &gt;&gt; <span class="number">16</span>;</div><div class="line">          <span class="keyword">if</span> ( idx == <span class="number">15</span> )</div><div class="line">          &#123;</div><div class="line">                <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">14</span>; ++i )</div><div class="line">                  qword_1317940[i] = <span class="built_in">malloc</span>(<span class="number">8L</span>L * *(_QWORD *)&amp;n[<span class="number">4</span>]);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">else</span></div><div class="line">          &#123;</div><div class="line">                qword_1317940[idx] = <span class="built_in">malloc</span>(<span class="number">8L</span>L * *(_QWORD *)&amp;n[<span class="number">4</span>]);</div><div class="line">          &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>With the clue of the chunk offset on <code>0x1317940</code>, now we can overwrite <code>malloc@GOT</code> to <code>sub_6E64A5</code> by fastbin attack, in particular using <code>devmem</code>.</p>
<p>I stayed up all night for this. I was tired but it was fun. I used these past write-ups as a reference when solving this task:</p>
<ul>
<li><a href="https://kitctf.de/writeups/hitb2017/babyqemu" target="_blank" rel="external">HITB GSEC 2017: babyqemu</a></li>
<li><a href="https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/" target="_blank" rel="external">QEMU Escape — vm_escape from 0CTF 2017 Finals Writeup - Eadom’s Blog</a></li>
</ul>
<p>Thanks authors!</p>
<h1 id="Final-Words"><a href="#Final-Words" class="headerlink" title="Final Words"></a>Final Words</h1><p>Other tasks I had wanted to solve are:</p>
<ul>
<li>flagsifier</li>
<li>TechSupport</li>
<li>smcauth</li>
</ul>
<p>This year DEFCON’s organizer has changed from LegitBS to OOO (Order of the-Overflow). OOO seems to have the purpose of connecting academic research and CTF. I support this philosophy, but this competition was not perfect. My impressions are summarized as follows:</p>
<table>
<thead>
<tr>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td>Meritocratic rev/pwn. Brand-new topics i.e. blockchain, neural network, reversing of Rust binary.</td>
<td>Many guessing tasks. Some incredible, old-fashioned tasks. In particular, sbva and ghettohackers: Throwback are quite bad.</td>
</tr>
</tbody>
</table>
<p>Anyway, I’m looking forward to that next year.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2018/05/14/def-con-ctf-qualifier-2018-round-up/" data-id="cjvozzsrr000gxo7tj1m5klew" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/exploitation/">exploitation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-def-con-ctf-qualifier-2017-pepperidge-farm-write-up" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/12/04/def-con-ctf-qualifier-2017-pepperidge-farm-write-up/">DEF CON CTF Qualifier 2017 Pepperidge Farm Write-up</a>
  

      </header>
    
    <time class="article-date" datetime="2017-12-03T15:00:00.000Z" itemprop="datePublished">12-04-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>HAI DOMO. This post is for <a href="https://qiita.com/advent-calendar/2017/musashino" target="_blank" rel="external">武蔵野 Advent Calendar 2017</a> and also for <a href="https://adventar.org/calendars/2431" target="_blank" rel="external">CTF Advent Calendar 2017</a>.</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>In May this year, I participated in DEF CON CTF Qualifier 2017 as a member of a certain 武蔵野-related team. Actually, I’m not a top-tier CTF player, but I did my best and solved 4 challenges:</p>
<ul>
<li>crackme1</li>
<li>beatmeonthedl</li>
<li>enlightenment</li>
<li>Pepperidge Farm</li>
</ul>
<p><a href="https://ctftime.org/event/459/tasks/" target="_blank" rel="external">Write-ups</a> already exist except for Pepperidge Farm. So I decided to write about it. FYI: The binaries are available at <a href="https://github.com/legitbs/quals-2017/" target="_blank" rel="external">legitbs/quals-2017</a>.</p>
<h1 id="Pepperidge-Farm"><a href="#Pepperidge-Farm" class="headerlink" title="Pepperidge Farm"></a>Pepperidge Farm</h1><p>Pepperidge Farm is categorized into Reverse Engineering. The problem statement is below:</p>
<blockquote>
<p>Remember when the first CTF was run with a custom architecture? Pepperidge Farm remembers:<br><a href="https://github.com/JonathanSalwan/VMNDH-2k12" target="_blank" rel="external">https://github.com/JonathanSalwan/VMNDH-2k12</a></p>
<p>pepperidge-farm_edb4ad2f103a9efde038346d2cd86a1e.quals.shallweplayaga.me:2012</p>
<p>Files<br><a href="https://2017.notmalware.ru/8a45cf7171e89594cfd1d51671fef0bec3f24d9d/pepperidge_farm" target="_blank" rel="external">https://2017.notmalware.ru/8a45cf7171e89594cfd1d51671fef0bec3f24d9d/pepperidge_farm</a></p>
</blockquote>
<p>It seems like a keygenning challenge on the custom virtual machine–VMNDH-2k12.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ./vmndh -file pepperidge_farm</div><div class="line">Enter your registration code: 31337</div><div class="line">Code does not match any known registered users</div></pre></td></tr></table></figure>
<h1 id="VMNDH-2k12"><a href="#VMNDH-2k12" class="headerlink" title="VMNDH-2k12"></a>VMNDH-2k12</h1><p>VMNDH-2k12 is the VM built for Nuit du Hack CTF Quals 2012 as its name suggests. The architecture is described in <a href="http://shell-storm.org/project/Useless-emulator-for-fun-VMNDH-2k12/" target="_blank" rel="external">shell-storm | Useless emulator for fun (VMNDH-2k12)</a>. This VM parses given serialized binary and repeats fetch, decode and execution.</p>
<p>Writing IDA loader/processor module is a common way to analyze VM-based obfuscated binary. The modules for VMNDH-2k12 and for modified version VMNDH-2k13 already exist:</p>
<ul>
<li><a href="https://bitbucket.org/jonbutler88/ida-ndh/overview" target="_blank" rel="external">jonbutler88 / ida-ndh – Bitbucket</a></li>
<li><a href="http://blog.w4kfu.com/post/ndh2k13_crackme500" target="_blank" rel="external">Another NDH quals another VM wait - w4kfu’s bl0g</a></li>
</ul>
<p>Note that when you try to solve this challenge with above-mentioned processor modules with IDA Pro 7.0, the backward-compatibility issue will occur. For example, you have to change <code>self.regFirstSreg</code> to<code>self.reg_first_sreg</code> in a module.</p>
<p>Also, the Binary Ninja plugin has been released after quals:</p>
<ul>
<li><a href="https://github.com/verylazyguy/binaryninja-vmndh" target="_blank" rel="external">verylazyguy/binaryninja-vmndh: vmndh-2k12 Architecture plugin for Binary Ninja</a></li>
</ul>
<p>But in this post, I describe a solution without both IDA Pro and Binary Ninja. Because VMNDH-2k12 is open-sourced and easy to modify.</p>
<h1 id="Surface-Analysis"><a href="#Surface-Analysis" class="headerlink" title="Surface Analysis"></a>Surface Analysis</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">$ ./vmndh -debug -file pepperidge_farm</div><div class="line">[Console]#&gt; help</div><div class="line">&lt;enter&gt;              Execute next instruction</div><div class="line">run                  Run program</div><div class="line">bp &lt;addr&gt;            Set breakpoint</div><div class="line">info bp              Display info breakpoint</div><div class="line">info reg             Display registers</div><div class="line">show sp              Display SP memory</div><div class="line">show pc              Display PC memory</div><div class="line">dis &lt;addr&gt;:&lt;size&gt;    Disassembly X bytes from ADDR</div><div class="line">x/x &lt;addr&gt;:&lt;size&gt;    Print X bytes from ADDR</div><div class="line">x/s &lt;addr&gt;           Print string addr</div><div class="line">set reg=value        Set value in register</div><div class="line">syscall              Execute &apos;syscall&apos; instruction</div><div class="line">help                 Display this help</div><div class="line">quit                 Quit console debugging</div><div class="line">[Console]#&gt; dis</div><div class="line">Error: Set addr between 0x8000 and 0x882a</div><div class="line">[Console]#&gt; dis 0x8000:82a</div><div class="line">0x8000: jmpl 0x0720</div><div class="line">0x8003: push r2</div><div class="line">0x8007: .byte 0x00</div><div class="line">0x8008: nop</div><div class="line">...</div></pre></td></tr></table></figure>
<p>Yes, the VM has own debugger and disassembler.</p>
<h1 id="Modifying-The-Disassembler"><a href="#Modifying-The-Disassembler" class="headerlink" title="Modifying The Disassembler"></a>Modifying The Disassembler</h1><p>However, there are pitfalls here. </p>
<p>Because it is a unique architecture, the destination of the control flow instructions are different from it shown on the disassembly dump. For example, take a look at <code>src_vm/op_call.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">op_call_dir16</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint16_t</span> operande;</div><div class="line"></div><div class="line">  operande = *(<span class="keyword">uint16_t</span> *)(core.memory.vmem + core.memory.pc + <span class="number">2</span>);</div><div class="line">  <span class="keyword">if</span> (core.flagmode.noverbose == <span class="number">0</span>)</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"%s0x%4.x%s &gt; call 0x%.2x\n"</span>, RED, core.memory.pc, ENDC, operande);</div><div class="line"></div><div class="line">  core.memory.sp -= <span class="number">2</span>; <span class="comment">/* sub sp */</span></div><div class="line">  *(<span class="keyword">uint16_t</span> *)(core.memory.vmem + core.memory.sp) = core.memory.pc + <span class="number">4</span>;</div><div class="line">  core.memory.pc = core.memory.pc + operande + <span class="number">4</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Acording to this, I modified the dissassembler in <code>src_vm/disass.c</code>:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@@ -532,6 +537,7 @@</span></div><div class="line">   uint16_t  operande;</div><div class="line">   uint8_t   reg;</div><div class="line">   char      flag;</div><div class="line"><span class="addition">+  uint16_t dst;</span></div><div class="line"> </div><div class="line">   flag = *(core.memory.vmem + addr + 1);</div><div class="line">   switch (flag)</div><div class="line"><span class="meta">@@ -543,7 +549,8 @@</span></div><div class="line"> </div><div class="line">       case OP_FLAG_DIRECT16:</div><div class="line">         operande = *(uint16_t *)(core.memory.vmem + addr + 2);</div><div class="line"><span class="deletion">-        fprintf(stdout, "%s0x%.4x%s: call 0x%.4x\n", RED, addr, ENDC, operande);</span></div><div class="line"><span class="addition">+        dst = addr + operande + 4;</span></div><div class="line"><span class="addition">+        fprintf(stdout, "%s0x%.4x%s: call 0x%.4x\n", RED, addr, ENDC, dst);</span></div><div class="line">         return (addr + 4);</div><div class="line"> </div><div class="line">       default:</div></pre></td></tr></table></figure>
<p>This makes it possible to correctly display the address of the call destination in the disassembly dump. In addition, jump instructions need to be modified. In the case of <code>jnz</code>:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@@ -463,10 +470,11 @@</span></div><div class="line"> </div><div class="line"> static uint16_t dis_jnz(uint16_t addr)</div><div class="line"> &#123;</div><div class="line"><span class="deletion">-  uint16_t operande;</span></div><div class="line"><span class="addition">+  uint16_t operande, dst;</span></div><div class="line"> </div><div class="line">   operande = *(uint16_t *)(core.memory.vmem + addr + 1);</div><div class="line"><span class="deletion">-  fprintf(stdout, "%s0x%.4x%s: jnz 0x%.4x\n", RED, addr, ENDC, operande);</span></div><div class="line"><span class="addition">+  dst = addr + operande + 3;</span></div><div class="line"><span class="addition">+  fprintf(stdout, "%s0x%.4x%s: jnz 0x%.4x\n", RED, addr, ENDC, dst);</span></div><div class="line"> </div><div class="line">   return (addr + 3);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>Herewith,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">0x86a1: jnz 0x0076</div><div class="line">0x86a4: mov r0, r2</div><div class="line">0x86a8: call 0xfdc5</div><div class="line">0x86ac: test r0, r0</div><div class="line">0x86af: jnz 0x0068</div><div class="line">0x86b2: mov r0, r2</div><div class="line">0x86b6: call 0xfddf</div><div class="line">0x86ba: test r0, r0</div><div class="line">0x86bd: jnz 0x005a</div><div class="line">0x86c0: mov r0, r2</div><div class="line">0x86c4: call 0xfe17</div><div class="line">0x86c8: test r0, r0</div><div class="line">0x86cb: jnz 0x004c</div><div class="line">0x86ce: mov r0, r2</div><div class="line">0x86d2: call 0xfe2c</div><div class="line">0x86d6: test r0, r0</div><div class="line">...</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">0x86a1: jnz 0x871a</div><div class="line">0x86a4: mov r0, r2</div><div class="line">0x86a8: call 0x8471</div><div class="line">0x86ac: test r0, r0</div><div class="line">0x86af: jnz 0x871a</div><div class="line">0x86b2: mov r0, r2</div><div class="line">0x86b6: call 0x8499</div><div class="line">0x86ba: test r0, r0</div><div class="line">0x86bd: jnz 0x871a</div><div class="line">0x86c0: mov r0, r2</div><div class="line">0x86c4: call 0x84df</div><div class="line">0x86c8: test r0, r0</div><div class="line">0x86cb: jnz 0x871a</div><div class="line">0x86ce: mov r0, r2</div><div class="line">0x86d2: call 0x8502</div><div class="line">0x86d6: test r0, r0</div><div class="line">...</div></pre></td></tr></table></figure>
<p>Good.</p>
<p>Also, after <code>0x8759</code> it looks like a data section.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">0x8759: .byte 0x45 (E)</div><div class="line">0x875a: .byte 0x6e (n)</div><div class="line">0x875b: .byte 0x74 (t)</div><div class="line">0x875c: .byte 0x65 (e)</div><div class="line">0x875d: .byte 0x72 (r)</div><div class="line">...</div></pre></td></tr></table></figure>
<p>However, parts such as <code>0x87e8</code> are misinterpreted as codes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0x87e8: inc r82</div></pre></td></tr></table></figure>
<p>The data section was not obfuscated.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">00007e0: 6c61 6700 3ce3 5a9e 9113 8c05 e42e 0a52  lag.&lt;.Z........R</div><div class="line">00007f0: 3dd8 7cf5 9f4b 9f06 d7a8 e9a0 a636 a649  =.|..K.......6.I</div><div class="line">0000800: 3136 9308 eb70 ebbf df28 500d 7be8 96fa  16...p...(P.&#123;...</div><div class="line">0000810: e8b7 a5df c24d f0b8 3b78 6272 b748 1697  .....M..;xbr.H..</div><div class="line">0000820: f019 2d6b 085b 9f94 4987 e624 3752 efb8  ..-k.[..I..$7R..</div></pre></td></tr></table></figure>
<p>So I gave first aid to <code>src_vm/disass.c</code>:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@@ -322,8 +322,15 @@</span></div><div class="line"> static uint16_t dis_inc(uint16_t addr)</div><div class="line"> &#123;</div><div class="line">   uint8_t operande;</div><div class="line"><span class="addition">+  char OP, OP2;</span></div><div class="line"> </div><div class="line"><span class="addition">+  OP = *(core.memory.vmem + addr);</span></div><div class="line"><span class="addition">+  OP2 = *(core.memory.vmem + addr + 1);</span></div><div class="line">   operande = *(core.memory.vmem + addr + 1);</div><div class="line"><span class="addition">+  if(addr &gt; 0x8759)</span></div><div class="line"><span class="addition">+    fprintf(stdout, "%s0x%.4x%s: [DEBUG] .byte 0x%.2x\n", RED, addr, ENDC, (unsigned char)OP);</span></div><div class="line"><span class="addition">+    fprintf(stdout, "%s0x%.4x%s: [DEBUG] .byte 0x%.2x\n", RED, addr + 1, ENDC, (unsigned char)OP2);</span></div><div class="line"><span class="addition">+</span></div><div class="line">   fprintf(stdout, "%s0x%.4x%s: inc r%d\n", RED, addr, ENDC, operande);</div><div class="line"> </div><div class="line">   return (addr + 2);</div></pre></td></tr></table></figure>
<p>Awful… who cares?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0x87e8: [DEBUG] .byte 0x0a</div><div class="line">0x87e9: [DEBUG] .byte 0x52</div><div class="line">0x87e8: inc r82</div><div class="line">0x87ea: .byte 0x3d (=)</div></pre></td></tr></table></figure>
<h1 id="First-Attempt-with-KLEE"><a href="#First-Attempt-with-KLEE" class="headerlink" title="First Attempt with KLEE"></a>First Attempt with KLEE</h1><p>This is a failure case.</p>
<p>As we have seen so far, VMNDH-2k12 is open-sourced. So I tried to solve the challenge with source code-based symbolic execution tool–<a href="http://klee.github.io/" target="_blank" rel="external">KLEE</a>.</p>
<p>I modified <code>src_vm/syscall_write.c</code> for assertion:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">@@ -18,6 +18,8 @@</div><div class="line"> */</div><div class="line"> </div><div class="line"> #include &quot;vmndh.h&quot;</div><div class="line">+#include &lt;klee/klee.h&gt;</div><div class="line">+#include &lt;string.h&gt;</div><div class="line"> </div><div class="line"> void syscall_write(void)</div><div class="line"> &#123;</div><div class="line">@@ -32,7 +34,12 @@</div><div class="line"> </div><div class="line">   if (core.flagmode.noverbose == 0)</div><div class="line">     write(1, txt, strlen(txt));</div><div class="line">+</div><div class="line">+  if (strstr(arg2, &quot;Thank&quot;) != NULL)</div><div class="line">+    klee_assert(0);</div><div class="line">+</div><div class="line">   core.regs.r0 = write(arg1, arg2, arg3);</div><div class="line">+</div><div class="line">   if (core.flagmode.noverbose == 0)</div><div class="line">     write(1, &quot;\n&quot;, 1);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>Here is a modified <code>Makefile</code>:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@@ -17,14 +17,15 @@</span></div><div class="line"> ## Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</div><div class="line"> ##</div><div class="line"> </div><div class="line"><span class="deletion">-DEBUG   = no</span></div><div class="line"><span class="addition">+DEBUG   = yes</span></div><div class="line"> RM      = rm -f</div><div class="line"> INCLUDE = ./includes</div><div class="line"> SRC_DIR = ./src_vm</div><div class="line"><span class="addition">+KLEE_PATH = ../klee_src/include</span></div><div class="line"> NAME    = vmndh</div><div class="line"> </div><div class="line"> ifeq ($(DEBUG),yes)</div><div class="line"><span class="deletion">-    CFLAGS   	= -c -ggdb3 -Wextra -Wall -D _BSD_SOURCE -I$(INCLUDE)</span></div><div class="line"><span class="addition">+    CFLAGS   	= -c -ggdb3 -Wextra -Wall -D _BSD_SOURCE -I$(INCLUDE) -I$(KLEE_PATH) -emit-llvm -g</span></div><div class="line">     LDFLAGS     =</div><div class="line">     CC 		= clang</div><div class="line"> else</div></pre></td></tr></table></figure>
<p>I’d left all of it to KLEE and get to bed…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">$ make</div><div class="line">$ llvm-link src_vm/*.o -o vmndh.bc</div><div class="line">$ klee --optimize --emit-all-errors --libc=uclibc --write-smt2s --posix-runtime vmndh.bc -file pepperidge_farm -sym-stdin 65</div><div class="line">KLEE: NOTE: Using klee-uclibc : /home/klee/klee_build/klee/Release+Debug+Asserts/lib/klee-uclibc.bca</div><div class="line">KLEE: NOTE: Using model: /home/klee/klee_build/klee/Release+Debug+Asserts/lib/libkleeRuntimePOSIX.bca</div><div class="line">KLEE: output directory is &quot;/home/klee/VMNDH-2k12/klee-out-1&quot;</div><div class="line">KLEE: Using STP solver backend</div><div class="line">KLEE: WARNING ONCE: function &quot;__user_main&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_accept&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_bind&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_listen&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_recv&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_send&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_socket&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: calling external: syscall(16, 0, 21505, 44258832) at /home/klee/klee_src/runtime/POSIX/fd.c:1044</div><div class="line">KLEE: WARNING ONCE: Alignment of memory from call &quot;malloc&quot; is not modelled. Using alignment of 8.</div><div class="line">Enter your registration code: KLEE: WARNING ONCE: calling external: vprintf(57126208, 46345808) at /home/klee/klee_build/klee-uclibc/libc/stdio/fprintf.c:36</div><div class="line">[SYSCALL output]: 64</div><div class="line">KLEE: WARNING ONCE: skipping fork (memory cap exceeded)</div><div class="line">...</div><div class="line">KLEE: WARNING: killing 175 states (over memory cap)</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">...</div><div class="line">Code does not match any known registered users</div><div class="line"></div><div class="line">KLEE: done: total instructions = 5117896332</div><div class="line">KLEE: done: completed paths = 81092</div><div class="line">KLEE: done: generated tests = 81092</div></pre></td></tr></table></figure>
<p>… It’s not going to be easy.</p>
<p>I also wrote solver with <a href="http://angr.io/" target="_blank" rel="external">angr</a>. Which symbolizes stdin, but… let’s not talk about it.</p>
<p>An example of insufficient SMTLIB2 representations is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(set-logic QF_AUFBV )</div><div class="line">(declare-fun model_version () (Array (_ BitVec 32) (_ BitVec 8) ) )</div><div class="line">(declare-fun stdin () (Array (_ BitVec 32) (_ BitVec 8) ) )</div><div class="line">(declare-fun stdin-stat () (Array (_ BitVec 32) (_ BitVec 8) ) )</div><div class="line">(assert (let ( (?B1 (select  stdin (_ bv25 32) ) ) (?B2 (select  stdin (_ bv31 32) ) ) (?B3 (select  stdin (_ bv18 32) ) ) (?B4 (select  stdin (_ bv40 32) ) ) (?B5 (select  stdin (_ bv36 32) ) ) (?B6 (select  stdin (_ bv23 32) ) ) (?B7 (select  stdin (_ bv27 32) ) ) (?B8 (select  stdin (_ bv33 32) ) ) (?B9 (select  stdin (_ bv6 32) ) ) (?B10 (select  stdin (_ bv8 32) ) ) ) (let ( (?B13 ((_ zero_extend 16)  ((_ zero_extend 8)  ?B7 ) ) ) (?B14 ((_ zero_extend 16)  ((_ zero_extend 8)  ?B8 ) ) ) (?B12 ((_ zero_extend 16)  ((_ zero_extend 8)  ?B2 ) ) ) (?B11 ((_ zero_extend 16)  ((_ zero_extend 8)  ?B1 ) ) ) ) (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (=  false (=  (_ bv0 64) (bvand  (concat  (select  stdin-stat (_ bv15 32) ) (concat  (select  stdin-stat (_ bv14 32) ) (concat  (select  stdin-stat (_ bv13 32) ) (concat  (select  stdin-stat (_ bv12 32) ) (concat  (select  stdin-stat (_ bv11 32) ) (concat  (select  stdin-stat (_ bv10 32) ) (concat  (select  stdin-stat (_ bv9 32) ) (select  stdin-stat (_ bv8 32) ) ) ) ) ) ) ) ) (_ bv2147483647 64) ) ) ) (bvult  (concat  (select  stdin-stat (_ bv63 32) ) (concat  (select  stdin-stat (_ bv62 32) ) (concat  (select  stdin-stat (_ bv61 32) ) (concat  (select  stdin-stat (_ bv60 32) ) (concat  (select  stdin-stat (_ bv59 32) ) (concat  (select  stdin-stat (_ bv58 32) ) (concat  (select  stdin-stat (_ bv57 32) ) (select  stdin-stat (_ bv56 32) ) ) ) ) ) ) ) ) (_ bv65536 64) ) ) (=  (_ bv1 32) (concat  (select  model_version (_ bv3 32) ) (concat  (select  model_version (_ bv2 32) ) (concat  (select  model_version (_ bv1 32) ) (select  model_version (_ bv0 32) ) ) ) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv0 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv1 32) ) ) ) (=  (_ bv57 8) (select  stdin (_ bv2 32) ) ) ) (=  (_ bv70 8) (select  stdin (_ bv3 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv4 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv5 32) ) ) ) (=  false (=  (_ bv48 8) ?B9 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B9 ) ) ) ) ) (=  false (=  (_ bv48 8) ?B10 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B10 ) ) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv12 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv13 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv14 32) ) ) ) (=  (_ bv57 8) (select  stdin (_ bv15 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv16 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv17 32) ) ) ) (=  false (=  (_ bv48 8) ?B3 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B3 ) ) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv20 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv21 32) ) ) ) (=  (_ bv57 8) (select  stdin (_ bv22 32) ) ) ) (=  false (=  (_ bv48 8) ?B6 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B6 ) ) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv24 32) ) ) ) (=  false (=  (_ bv48 8) ?B1 ) ) ) (bvult  (_ bv48 32) ?B11 ) ) (=  false (=  (_ bv57 8) ?B1 ) ) ) (=  false (bvult  (_ bv57 32) ?B11 ) ) ) (=  (_ bv48 8) (select  stdin (_ bv26 32) ) ) ) (=  false (=  (_ bv48 8) ?B7 ) ) ) (bvult  (_ bv48 32) ?B13 ) ) (=  false (=  (_ bv57 8) ?B7 ) ) ) (=  false (bvult  (_ bv57 32) ?B13 ) ) ) (=  (_ bv48 8) (select  stdin (_ bv28 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv29 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv30 32) ) ) ) (=  false (=  (_ bv48 8) ?B2 ) ) ) (bvult  (_ bv48 32) ?B12 ) ) (=  false (=  (_ bv57 8) ?B2 ) ) ) (=  false (bvult  (_ bv57 32) ?B12 ) ) ) (=  (_ bv48 8) (select  stdin (_ bv32 32) ) ) ) (=  false (=  (_ bv48 8) ?B8 ) ) ) (bvult  (_ bv48 32) ?B14 ) ) (=  false (=  (_ bv57 8) ?B8 ) ) ) (bvult  (_ bv57 32) ?B14 ) ) (=  false (=  (_ bv70 8) ?B8 ) ) ) (bvult  (_ bv70 32) ?B14 ) ) (=  false (=  (_ bv48 8) ?B5 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B5 ) ) ) ) ) (=  false (=  (_ bv48 8) ?B4 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B4 ) ) ) ) ) ) ) )</div><div class="line">(check-sat)</div><div class="line">(exit)</div></pre></td></tr></table></figure>
<h1 id="Solution-with-Z3"><a href="#Solution-with-Z3" class="headerlink" title="Solution with Z3"></a>Solution with Z3</h1><p>Since there is no choice, I read all the disassembly. After some twists and turn, I realized that:</p>
<ul>
<li>Pepperidge Farm checks character codes against transformed <code>0x20</code> bytes values.</li>
<li><code>0x8247(x, y)</code> returns <code>x * 100 + y</code>.</li>
</ul>
<p>Now <a href="https://github.com/Z3Prover/z3" target="_blank" rel="external">Z3</a> time. For example, subroutine <code>0x8269</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">0x8269: push r1</div><div class="line">0x826d: pop r2</div><div class="line">0x826f: mov r7, r0</div><div class="line">0x8273: addb r0, #00</div><div class="line">0x8277: call 0x8247</div><div class="line">0x827b: mov r1, r0</div><div class="line">0x827f: mov r0, r7</div><div class="line">0x8283: addb r0, #14</div><div class="line">0x8287: call 0x8247</div><div class="line">0x828b: mov r2, r0</div><div class="line">0x828f: movl r0, #0x87ec</div><div class="line">0x8294: call 0x8247</div><div class="line">0x8298: xorl r1, #4936</div><div class="line">0x829d: add r1, r2</div><div class="line">0x82a1: xor r0, r1</div><div class="line">0x82a5: pop r2</div><div class="line">0x82a7: pop r1</div><div class="line">0x82a9: ret</div><div class="line">...</div><div class="line">0x87ec: .byte 0x7c (|)</div><div class="line">0x87ed: .byte 0xf5</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.add(((sub_8247(<span class="number">0</span>) ^ <span class="number">0x4936</span>) + sub_8247(<span class="number">0x14</span>)) ^ <span class="number">0x7cf5</span> == <span class="number">0</span>)</div></pre></td></tr></table></figure>
<p>This is satisfiable. But not enough. We need to add rest of constraints.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding: utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> telnetlib, sys</div><div class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</div><div class="line"></div><div class="line">REMOTE = len(sys.argv) &gt;= <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">'r'</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> REMOTE:</div><div class="line">    host = <span class="string">'pepperidge-farm_edb4ad2f103a9efde038346d2cd86a1e.quals.shallweplayaga.me'</span></div><div class="line">    port = <span class="number">2012</span></div><div class="line"><span class="keyword">else</span>:</div><div class="line">    host = <span class="string">'127.0.0.1'</span></div><div class="line">    port = <span class="number">4000</span></div><div class="line"></div><div class="line">values = [BitVec(<span class="string">'x%d'</span> % i, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>)]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_8247</span><span class="params">(x)</span>:</span> <span class="keyword">return</span> ZeroExt(<span class="number">8</span>, values[x]) &lt;&lt; <span class="number">8</span> | ZeroExt(<span class="number">8</span>, values[x + <span class="number">1</span>])</div><div class="line"></div><div class="line">s = Solver()</div><div class="line"></div><div class="line"><span class="comment"># sub_8269</span></div><div class="line">s.add(((sub_8247(<span class="number">0</span>) ^ <span class="number">0x4936</span>) + sub_8247(<span class="number">0x14</span>)) ^ <span class="number">0x7cf5</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_82aa</span></div><div class="line">s.add(sub_8247(<span class="number">6</span>) * sub_8247(<span class="number">8</span>) * (sub_8247(<span class="number">2</span>) ^ <span class="number">0xfdf</span>) ^ <span class="number">0x3dd8</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8304</span></div><div class="line">s.add(((sub_8247(<span class="number">4</span>) ^ <span class="number">0xc7df</span>) + sub_8247(<span class="number">0xe</span>) * sub_8247(<span class="number">0xc</span>)) ^ <span class="number">0xeb70</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_835e</span></div><div class="line">s.add(((sub_8247(<span class="number">6</span>) ^ <span class="number">0xc5db</span>) + <span class="number">0x14aa</span>) ^ <span class="number">0x500d</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_838b</span></div><div class="line">s.add(sub_8247(<span class="number">8</span>) * sub_8247(<span class="number">0x1e</span>) ^ <span class="number">0x7be8</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_83c7</span></div><div class="line">s.add((sub_8247(<span class="number">0xa</span>) + sub_8247(<span class="number">6</span>) + sub_8247(<span class="number">0xC</span>)) ^ <span class="number">0xdf28</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_841c</span></div><div class="line">s.add(((sub_8247(<span class="number">0xC</span>) + <span class="number">0x5432</span>) | <span class="number">0x3008</span>) ^ <span class="number">0x3b78</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8449</span></div><div class="line">s.add((sub_8247(<span class="number">0xE</span>) + <span class="number">0x1212</span>) ^ <span class="number">0x1697</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8471</span></div><div class="line">s.add((sub_8247(<span class="number">0x10</span>) ^ <span class="number">0x8703</span>) ^  <span class="number">0x3136</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8499</span></div><div class="line">s.add(((sub_8247(<span class="number">0x12</span>) + <span class="number">0x4004</span>) + (sub_8247(<span class="number">0x14</span>) ^ <span class="number">0xA52</span>)) ^  <span class="number">0x6272</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_84df</span></div><div class="line">s.add()</div><div class="line"><span class="comment"># sub_8502</span></div><div class="line">s.add((sub_8247(<span class="number">0x16</span>) + sub_8247(<span class="number">0x10</span>)) ^ <span class="number">0x9308</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_853e</span></div><div class="line">s.add(sub_8247(<span class="number">0x18</span>) ^ <span class="number">0x085b</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8561</span></div><div class="line">s.add(((sub_8247(<span class="number">0x1a</span>) ^ <span class="number">0x863c</span>) + <span class="number">0x1234</span>) ^ <span class="number">0x9113</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_858e</span></div><div class="line">s.add((sub_8247(<span class="number">0x1c</span>) + sub_8247(<span class="number">8</span>) + sub_8247(<span class="number">0x12</span>)) ^ <span class="number">0xf0b8</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_85e3</span></div><div class="line">s.add(((sub_8247(<span class="number">0x1e</span>) &amp; <span class="number">0x0f00</span>) + sub_8247(<span class="number">0</span>)) ^ <span class="number">0x9f94</span> == <span class="number">0</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> s.check()</div><div class="line"><span class="keyword">print</span> s.model()</div><div class="line"></div><div class="line">input = <span class="string">''</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>):</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        input += <span class="string">'%02x'</span> % s.model()[values[i]].as_long()</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        input += <span class="string">'??'</span></div><div class="line"></div><div class="line">input = input.upper()</div><div class="line"><span class="keyword">print</span> input</div><div class="line"></div><div class="line">t = telnetlib.Telnet(host, port)</div><div class="line">t.write(input + <span class="string">'\n'</span>)</div><div class="line">t.interact()</div></pre></td></tr></table></figure>
<p>Even with halfway constraints, the process proceeds. So inscount with <a href="https://software.intel.com/en-us/articles/pin-a-dynamic-binary-instrumentation-tool" target="_blank" rel="external">Pin</a> or other dynamic binary instrumentation tools might be helpful.</p>
<p>Finally I got:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Enter your registration code: 90940C6017E5FEB82083F932E73E0485B635796DA353DCD3085BF8E356C87FF8</div><div class="line">Thank you for your patronage!</div><div class="line">Your username is: pepperidge</div><div class="line">This is the flag: th0s3_wh0_l0ok_0nly_to_th3_p4stur3_ar3_cert4in_t0_miss_th3_futur3</div></pre></td></tr></table></figure>
<p>The conclusive SMTLIB2 representation is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">; benchmark</div><div class="line">(set-info :status unknown)</div><div class="line">(set-logic QF_AUFBV)</div><div class="line">(declare-fun x1 () (_ BitVec 8))</div><div class="line">(declare-fun x0 () (_ BitVec 8))</div><div class="line">(declare-fun x31 () (_ BitVec 8))</div><div class="line">(declare-fun x30 () (_ BitVec 8))</div><div class="line">(declare-fun x19 () (_ BitVec 8))</div><div class="line">(declare-fun x18 () (_ BitVec 8))</div><div class="line">(declare-fun x9 () (_ BitVec 8))</div><div class="line">(declare-fun x8 () (_ BitVec 8))</div><div class="line">(declare-fun x29 () (_ BitVec 8))</div><div class="line">(declare-fun x28 () (_ BitVec 8))</div><div class="line">(declare-fun x27 () (_ BitVec 8))</div><div class="line">(declare-fun x26 () (_ BitVec 8))</div><div class="line">(declare-fun x25 () (_ BitVec 8))</div><div class="line">(declare-fun x24 () (_ BitVec 8))</div><div class="line">(declare-fun x17 () (_ BitVec 8))</div><div class="line">(declare-fun x16 () (_ BitVec 8))</div><div class="line">(declare-fun x23 () (_ BitVec 8))</div><div class="line">(declare-fun x22 () (_ BitVec 8))</div><div class="line">(declare-fun x21 () (_ BitVec 8))</div><div class="line">(declare-fun x20 () (_ BitVec 8))</div><div class="line">(declare-fun x15 () (_ BitVec 8))</div><div class="line">(declare-fun x14 () (_ BitVec 8))</div><div class="line">(declare-fun x13 () (_ BitVec 8))</div><div class="line">(declare-fun x12 () (_ BitVec 8))</div><div class="line">(declare-fun x7 () (_ BitVec 8))</div><div class="line">(declare-fun x6 () (_ BitVec 8))</div><div class="line">(declare-fun x11 () (_ BitVec 8))</div><div class="line">(declare-fun x10 () (_ BitVec 8))</div><div class="line">(declare-fun x5 () (_ BitVec 8))</div><div class="line">(declare-fun x4 () (_ BitVec 8))</div><div class="line">(declare-fun x3 () (_ BitVec 8))</div><div class="line">(declare-fun x2 () (_ BitVec 8))</div><div class="line">(assert</div><div class="line"> (let ((?x206 (bvand (bvor (bvshl ((_ zero_extend 8) x30) (_ bv8 16)) ((_ zero_extend 8) x31)) (_ bv3840 16))))</div><div class="line">(let ((?x209 (bvxor (bvadd ?x206 (bvor (bvshl ((_ zero_extend 8) x0) (_ bv8 16)) ((_ zero_extend 8) x1))) (_ bv40852 16))))</div><div class="line">(let (($x210 (= ?x209 (_ bv0 16))))</div><div class="line">(let ((?x82 (bvor (bvshl ((_ zero_extend 8) x8) (_ bv8 16)) ((_ zero_extend 8) x9))))</div><div class="line">(let ((?x200 (bvadd (bvor (bvshl ((_ zero_extend 8) x28) (_ bv8 16)) ((_ zero_extend 8) x29)) ?x82)))</div><div class="line">(let ((?x201 (bvadd ?x200 (bvor (bvshl ((_ zero_extend 8) x18) (_ bv8 16)) ((_ zero_extend 8) x19)))))</div><div class="line">(let (($x204 (= (bvxor ?x201 (_ bv61624 16)) (_ bv0 16))))</div><div class="line">(let ((?x190 (bvxor (bvor (bvshl ((_ zero_extend 8) x26) (_ bv8 16)) ((_ zero_extend 8) x27)) (_ bv34364 16))))</div><div class="line">(let (($x195 (= (bvxor (bvadd ?x190 (_ bv4660 16)) (_ bv37139 16)) (_ bv0 16))))</div><div class="line">(let ((?x183 (bvxor (bvor (bvshl ((_ zero_extend 8) x24) (_ bv8 16)) ((_ zero_extend 8) x25)) (_ bv2139 16))))</div><div class="line">(let (($x184 (= ?x183 (_ bv0 16))))</div><div class="line">(let ((?x174 (bvadd (bvor (bvshl ((_ zero_extend 8) x22) (_ bv8 16)) ((_ zero_extend 8) x23)) (bvor (bvshl ((_ zero_extend 8) x16) (_ bv8 16)) ((_ zero_extend 8) x17)))))</div><div class="line">(let (($x177 (= (bvxor ?x174 (_ bv37640 16)) (_ bv0 16))))</div><div class="line">(let ((?x165 (bvxor (bvor (bvshl ((_ zero_extend 8) x20) (_ bv8 16)) ((_ zero_extend 8) x21)) (_ bv2642 16))))</div><div class="line">(let ((?x163 (bvadd (bvor (bvshl ((_ zero_extend 8) x18) (_ bv8 16)) ((_ zero_extend 8) x19)) (_ bv16388 16))))</div><div class="line">(let (($x169 (= (bvxor (bvadd ?x163 ?x165) (_ bv25202 16)) (_ bv0 16))))</div><div class="line">(let ((?x154 (bvxor (bvor (bvshl ((_ zero_extend 8) x16) (_ bv8 16)) ((_ zero_extend 8) x17)) (_ bv34563 16))))</div><div class="line">(let (($x157 (= (bvxor ?x154 (_ bv12598 16)) (_ bv0 16))))</div><div class="line">(let ((?x145 (bvadd (bvor (bvshl ((_ zero_extend 8) x14) (_ bv8 16)) ((_ zero_extend 8) x15)) (_ bv4626 16))))</div><div class="line">(let (($x148 (= (bvxor ?x145 (_ bv5783 16)) (_ bv0 16))))</div><div class="line">(let ((?x107 (bvor (bvshl ((_ zero_extend 8) x12) (_ bv8 16)) ((_ zero_extend 8) x13))))</div><div class="line">(let (($x143 (= (bvxor (bvor (bvadd ?x107 (_ bv21554 16)) (_ bv12296 16)) (_ bv15224 16)) (_ bv0 16))))</div><div class="line">(let ((?x78 (bvor (bvshl ((_ zero_extend 8) x6) (_ bv8 16)) ((_ zero_extend 8) x7))))</div><div class="line">(let ((?x132 (bvadd (bvor (bvshl ((_ zero_extend 8) x10) (_ bv8 16)) ((_ zero_extend 8) x11)) ?x78)))</div><div class="line">(let (($x136 (= (bvxor (bvadd ?x132 ?x107) (_ bv57128 16)) (_ bv0 16))))</div><div class="line">(let ((?x124 (bvmul ?x82 (bvor (bvshl ((_ zero_extend 8) x30) (_ bv8 16)) ((_ zero_extend 8) x31)))))</div><div class="line">(let (($x127 (= (bvxor ?x124 (_ bv31720 16)) (_ bv0 16))))</div><div class="line">(let (($x119 (= (bvxor (bvadd (bvxor ?x78 (_ bv50651 16)) (_ bv5290 16)) (_ bv20493 16)) (_ bv0 16))))</div><div class="line">(let ((?x108 (bvmul (bvor (bvshl ((_ zero_extend 8) x14) (_ bv8 16)) ((_ zero_extend 8) x15)) ?x107)))</div><div class="line">(let ((?x109 (bvadd (bvxor (bvor (bvshl ((_ zero_extend 8) x4) (_ bv8 16)) ((_ zero_extend 8) x5)) (_ bv51167 16)) ?x108)))</div><div class="line">(let (($x112 (= (bvxor ?x109 (_ bv60272 16)) (_ bv0 16))))</div><div class="line">(let ((?x90 (bvmul (bvmul ?x78 ?x82) (bvxor (bvor (bvshl ((_ zero_extend 8) x2) (_ bv8 16)) ((_ zero_extend 8) x3)) (_ bv4063 16)))))</div><div class="line">(let (($x93 (= (bvxor ?x90 (_ bv15832 16)) (_ bv0 16))))</div><div class="line">(let ((?x50 (bvadd (bvxor (bvor (bvshl ((_ zero_extend 8) x0) (_ bv8 16)) ((_ zero_extend 8) x1)) (_ bv18742 16)) (bvor (bvshl ((_ zero_extend 8) x20) (_ bv8 16)) ((_ zero_extend 8) x21)))))</div><div class="line">(let (($x54 (= (bvxor ?x50 (_ bv31989 16)) (_ bv0 16))))</div><div class="line">(and $x54 $x93 $x112 $x119 $x127 $x136 $x143 $x148 $x157 $x169 $x177 $x184 $x195 $x204 $x210)))))))))))))))))))))))))))))))))))))</div><div class="line">(check-sat)</div></pre></td></tr></table></figure>
<h1 id="Final-Words"><a href="#Final-Words" class="headerlink" title="Final Words"></a>Final Words</h1><p>I enjoyed this challenge. It seems to be easy or medium-easy difficulty rating. If only I could have solved more difficult Reverse Engineering challenges during quals–liberty, godzilla, and so on.</p>
<p>Recently I read <a href="https://www.usenix.org/conference/usenixsecurity17/technical-sessions/presentation/blazytko" target="_blank" rel="external">T. Blazytko et al. USENIX Security’17</a>. The paper says the system named Syntia automatically deobfuscate binaries with program synthesis. Program synthesis is a method to synthesize some pieces of program from given I/O samples and possible operators–like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding: utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</div><div class="line"></div><div class="line">x, y, h = BitVecs([<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'h'</span>], <span class="number">8</span>)</div><div class="line"></div><div class="line"><span class="comment"># I/O samples</span></div><div class="line">t1 = And(x == <span class="number">1</span>, y == <span class="number">2</span>)</div><div class="line">t2 = And(x == <span class="number">2</span>, y == <span class="number">4</span>)</div><div class="line">t3 = And(x == <span class="number">3</span>, y == <span class="number">6</span>)</div><div class="line">phi_1 = Or(t1, t2, t3)</div><div class="line"></div><div class="line"><span class="comment"># h is subject to synthesize</span></div><div class="line">phi_2 = y == x &lt;&lt; h</div><div class="line"></div><div class="line">s = Solver()</div><div class="line">s.add(ForAll([x, y], Implies(phi_1, phi_2)))</div><div class="line"></div><div class="line"><span class="keyword">print</span> s.check() <span class="comment"># sat</span></div><div class="line"><span class="keyword">print</span> s.model() <span class="comment"># [h = 2]</span></div></pre></td></tr></table></figure>
<p>This is just a simple example. In practical, program slicing and path pruning will be needed. Both symbolic execution and program synthesis depend on SMT solver, but according to the paper, program synthesis is more suitable for deobfuscation tasks… really? I’ll investigate further.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/12/04/def-con-ctf-qualifier-2017-pepperidge-farm-write-up/" data-id="cjvozzsrx000pxo7tkj2jpw7p" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/program-synthesis/">program synthesis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-backward-program-slicing-with-idapython-and-triton" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/11/23/backward-program-slicing-with-idapython-and-triton/">Backward Program Slicing with IDAPython and Triton</a>
  

      </header>
    
    <time class="article-date" datetime="2017-11-22T16:30:00.000Z" itemprop="datePublished">11-23-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>As you know, IDAPython is quite useful. And <a href="https://github.com/JonathanSalwan/Triton" target="_blank" rel="external">Triton</a> concolic execution engine has python binding. Then… why not integrate them? I tried to stand on the shoulders of giants.</p>
<h1 id="Backward-Program-Slicing"><a href="#Backward-Program-Slicing" class="headerlink" title="Backward Program Slicing"></a>Backward Program Slicing</h1><p>Roughly speaking, program slicing is a method to extract subset of program which is relevant to given statement. Here is an excerpt from <a href="https://dl.acm.org/citation.cfm?id=802557" target="_blank" rel="external">M. Weiser. ICSE’81</a>:</p>
<blockquote>
<p>Starting from a subset of a program’s behavior, slicing reduces that program to a minimal form which still produces that behavior. The reduced program, called a “slice”, is an independent program guaranteed to faithfully represent the original program within the domain of the specified subset of behavior.</p>
</blockquote>
<p>Kudos to Jonathan Salwan, we can easily apply backward program slicing to binary analysis process with minor modification of <a href="https://github.com/JonathanSalwan/Triton/blob/master/src/examples/python/backward_slicing.py" target="_blank" rel="external"><code>backward_slicing.py</code></a> and <a href="https://github.com/JonathanSalwan/Triton/blob/master/src/examples/python/proving_opaque_predicates.py" target="_blank" rel="external"><code>proving_opaque_predicates.py</code></a>. I wrote a simple, tiny glue between Triton and IDA Pro:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding: utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> idaapi <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> *</div><div class="line"></div><div class="line">ctx = TritonContext()</div><div class="line">regs = &#123;</div><div class="line">        <span class="string">'eax'</span>: REG.X86.EAX,</div><div class="line">        <span class="string">'ebx'</span>: REG.X86.EBX,</div><div class="line">        <span class="string">'ecx'</span>: REG.X86.ECX,</div><div class="line">        <span class="string">'edx'</span>: REG.X86.EDX,</div><div class="line">        &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">symbolization_init</span><span class="params">()</span>:</span></div><div class="line">    ctx.convertRegisterToSymbolicVariable(ctx.registers.eax)</div><div class="line">    ctx.convertRegisterToSymbolicVariable(ctx.registers.ebx)</div><div class="line">    ctx.convertRegisterToSymbolicVariable(ctx.registers.ecx)</div><div class="line">    ctx.convertRegisterToSymbolicVariable(ctx.registers.edx)</div><div class="line">    <span class="keyword">return</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">opaque_predicate_detection</span><span class="params">(pc)</span>:</span></div><div class="line">    ctx.setArchitecture(ARCH.X86)</div><div class="line">    ctx.setAstRepresentationMode(AST_REPRESENTATION.PYTHON)</div><div class="line">    symbolization_init()</div><div class="line">    ast_ctx = ctx.getAstContext()</div><div class="line"></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        instruction = Instruction()</div><div class="line">        instruction.setAddress(pc)</div><div class="line">        opcode = GetManyBytes(pc, ItemSize(pc)) <span class="comment"># Disassemble with IDA Pro</span></div><div class="line">        instruction.setOpcode(opcode)</div><div class="line"></div><div class="line">        ctx.processing(instruction) <span class="comment"># Emulate instruction without Pintool</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> se <span class="keyword">in</span> instruction.getSymbolicExpressions():</div><div class="line">            se.setComment(str(instruction))</div><div class="line"></div><div class="line">        <span class="keyword">if</span> str(instruction.getDisassembly()).split()[<span class="number">0</span>] == <span class="string">'cmp'</span>: <span class="comment"># if instruction.isCompare():</span></div><div class="line">            reg = str(instruction.getOperands()[<span class="number">0</span>]).split(<span class="string">':'</span>)[<span class="number">0</span>] <span class="comment"># Get first operand</span></div><div class="line">            <span class="keyword">if</span> reg <span class="keyword">in</span> regs:</div><div class="line">                Expr = ctx.getSymbolicRegisters()[regs[reg]]</div><div class="line">                slicing = ctx.sliceExpressions(Expr)</div><div class="line">                <span class="keyword">for</span> k, v <span class="keyword">in</span> sorted(slicing.items()):</div><div class="line">                    <span class="keyword">print</span> v.getComment()</div><div class="line">                <span class="keyword">print</span> instruction</div><div class="line">        <span class="keyword">elif</span> instruction.isBranch():</div><div class="line">            <span class="keyword">print</span> instruction</div><div class="line">            <span class="keyword">if</span> instruction.isConditionTaken():</div><div class="line">                <span class="keyword">print</span> <span class="string">'branch will taken'</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">print</span> <span class="string">'branch will not taken'</span></div><div class="line"></div><div class="line">            <span class="keyword">break</span></div><div class="line"></div><div class="line">        pc = NextHead(pc)</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'-'</span> * <span class="number">50</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    ea = ScreenEA() <span class="comment"># Get address corresponding to cursor</span></div><div class="line">    opaque_predicate_detection(ea) </div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    view = main()</div></pre></td></tr></table></figure>
<h1 id="Showcase"><a href="#Showcase" class="headerlink" title="Showcase"></a>Showcase</h1><p>The snippet extracts subset of program which is relevant to branch condition. We can run this from <code>File -&gt; Script file</code> in IDA Pro menu.</p>
<h2 id="Conditional-Branch"><a href="#Conditional-Branch" class="headerlink" title="Conditional Branch"></a>Conditional Branch</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">.text:004074DD     loc_4074DD:</div><div class="line">.text:004074DD 040 mov     dword ptr [edi+18h], 0Ah</div><div class="line">.text:004074E4 040 mov     dword ptr [edi+14h], 0</div><div class="line">.text:004074EB 040 mov     word ptr [edi+8], 8235h</div><div class="line">.text:004074F1 040 mov     dword ptr [edi+0Ch], 3E8h</div><div class="line">.text:004074F8 040 mov     dword ptr [edi+10h], 0BB8h</div><div class="line">.text:004074FF 040 sub     esp, 4</div><div class="line">.text:00407502 044 mov     [esp+40h+Memory], 0B8h ; Size        ; cursor</div><div class="line">.text:00407509 044 call    ??2@YAPAXI@Z    ; operator new(uint)</div><div class="line">.text:0040750E 044 add     esp, 4</div><div class="line">.text:00407511 040 mov     [esi+18h], eax</div><div class="line">.text:00407514 040 mov     eax, dword_591EE4</div><div class="line">.text:00407519 040 mov     ecx, dword_591EE0</div><div class="line">.text:0040751F 040 imul    eax, eax</div><div class="line">.text:00407522 040 imul    edx, eax, 7</div><div class="line">.text:00407525 040 dec     edx</div><div class="line">.text:00407526 040 mov     eax, ecx</div><div class="line">.text:00407528 040 imul    eax, eax</div><div class="line">.text:0040752B 040 cmp     edx, eax</div><div class="line">.text:0040752D 040 jz      short loc_407538</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0x407514: mov eax, dword ptr [0x591ee4]</div><div class="line">0x40751f: imul eax, eax</div><div class="line">0x407522: imul edx, eax, 7</div><div class="line">0x407525: dec edx</div><div class="line">0x40752b: cmp edx, eax</div><div class="line">0x40752d: je 0x407538</div><div class="line">branch will not taken</div></pre></td></tr></table></figure>
<h2 id="Unconditional-Branch"><a href="#Unconditional-Branch" class="headerlink" title="Unconditional Branch"></a>Unconditional Branch</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">.text:004078C3     loc_4078C3:</div><div class="line">.text:004078C3 000 mov     esp, edi           ; cursor</div><div class="line">.text:004078C5 000 mov     eax, dword_591EAC</div><div class="line">.text:004078CA 000 lea     ecx, [eax+4]</div><div class="line">.text:004078CD 000 mov     edx, eax</div><div class="line">.text:004078CF 000 sar     edx, cl</div><div class="line">.text:004078D1 000 lea     eax, [eax+edx*2]</div><div class="line">.text:004078D4 000 mov     dword_591EAC, eax</div><div class="line">.text:004078D9 000 jmp     short loc_4</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0x4078d9: jmp 0x40789a</div><div class="line">branch will taken</div></pre></td></tr></table></figure>
<p>Looks nice.</p>
<h1 id="Last-Words"><a href="#Last-Words" class="headerlink" title="Last Words"></a>Last Words</h1><p>Triton’s emulation iteration is compatible to IDAPython manner. Therefore, The combination of IDA Pro and Triton is pretty good. </p>
<p>Cheers,</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/11/23/backward-program-slicing-with-idapython-and-triton/" data-id="cjvozzsrn0006xo7tzdylh0pt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-a-supplemental-guide-to-migrate-pySide-code-to-pyqt5-within-your-idapython-script" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/11/08/a-supplemental-guide-to-migrate-pySide-code-to-pyqt5-within-your-idapython-script/">A Supplemental Guide to Migrate PySide Code to PyQt5 Within Your IDAPython Script</a>
  

      </header>
    
    <time class="article-date" datetime="2017-11-08T12:00:00.000Z" itemprop="datePublished">11-08-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>IDAPython is a powerful feature of IDA Pro, and there are many open-sourced IDAPython projects. However, we cannot use every GUI-based IDAPython script due to some Qt-related breaking changes between IDA Pro 6.8 and 6.9 or later. The main problem is about migrating no longer supported PySide code to PyQt5.</p>
<p>Recently I ported PySide code within <a href="https://github.com/RobinDavid/idasec" target="_blank" rel="external">idasec</a>–one of the most sophisticated deobfuscation frameworks, which tackles opaque predicates and call stack tampering in terms of infeasibility questions, by utilizing Backward-Bounded Dynamic Symbolic Execution proposed in the remarkably well written paper <a href="https://www.ieee-security.org/TC/SP2017/papers/220.pdf" target="_blank" rel="external">S. Bardin et al. IEEE S&amp;P’17</a>–to PyQt5.</p>
<p>That’s why I decided to write this blog post for a note to self and for someone trying to do similar thing.</p>
<h1 id="Related-Work"><a href="#Related-Work" class="headerlink" title="Related Work"></a>Related Work</h1><p>There are 2 guidances to migrate PySide code to PyQt5:</p>
<ul>
<li><a href="http://www.hexblog.com/?p=975" target="_blank" rel="external">IDAPython: migrating PySide code to PyQt5 – Hex Blog</a></li>
<li><a href="https://github.com/tmr232/Cute" target="_blank" rel="external">idacute</a></li>
</ul>
<p>Please read them before. I only give supplemental information in addition to predecessors.</p>
<h1 id="How-to-Migrate"><a href="#How-to-Migrate" class="headerlink" title="How to Migrate"></a>How to Migrate</h1><p>Now let’s get started.</p>
<h2 id="Change-QtGui-methods-to-QtWidgets"><a href="#Change-QtGui-methods-to-QtWidgets" class="headerlink" title="Change QtGui methods to QtWidgets"></a>Change <code>QtGui</code> methods to <code>QtWidgets</code></h2><p>Most methods in <code>QtGui</code> migrated to <code>QtWidgets</code>. Therefore,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> PySide <span class="keyword">import</span> QtGui, QtCore</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtGui, QtWidgets</div></pre></td></tr></table></figure>
<p>As an example, <code>QTextEdit</code> described in Hex Blog. In additions, the methods to be rewritten are as follows:</p>
<ul>
<li><code>QtWidgets.QLayout</code></li>
<li><code>QtWidgets.QVBoxLayout</code></li>
<li><code>QtWidgets.QHBoxLayout</code></li>
<li><code>QtWidgets.QWidget</code></li>
<li><code>QtWidgets.QTableWidget</code></li>
<li><code>QtWidgets.QListWidget</code></li>
<li><code>QtWidgets.QTabWidget</code></li>
<li><code>QtWidgets.QDockWidget</code></li>
<li><code>QtWidgets.QTreeWidget</code></li>
<li><code>QtWidgets.QTreeWidgetItem</code></li>
<li><code>QtWidgets.QPushButton</code></li>
<li><code>QtWidgets.QRadioButton</code></li>
<li><code>QtWidgets.QToolButton</code></li>
<li><code>QtWidgets.QButtonGroup</code></li>
<li><code>QtWidgets.QGroupBox</code></li>
<li><code>QtWidgets.QSpinBox</code></li>
<li><code>QtWidgets.QCheckBox</code></li>
<li><code>QtWidgets.QComboBox</code></li>
<li><code>QtWidgets.QTextEdit</code></li>
<li><code>QtWidgets.QLineEdit</code></li>
<li><code>QtWidgets.QApplication</code></li>
<li><code>QtWidgets.QLabel</code></li>
<li><code>QtWidgets.QSizePolicy</code></li>
<li><code>QtWidgets.QMenu</code></li>
<li><code>QtWidgets.QFrame</code></li>
<li><code>QtWidgets.QProgressBar</code></li>
<li><code>QtWidgets.QStyle</code></li>
<li><code>QtWidgets.QSpacerItem</code></li>
<li><code>QtWidgets.QScrollArea</code></li>
<li><code>QtWidgets.QSplitter</code></li>
<li>There might be more…</li>
</ul>
<p>My experience says that other than the following 3 methods may be rewritten:</p>
<ul>
<li><code>QtGui.QPixmap</code></li>
<li><code>QtGui.QIcon</code></li>
<li><code>QtGui.QFont</code></li>
</ul>
<p>idacute may overwrite all of <code>QtGui</code> methods, so I think there still needs to be manual works.</p>
<h2 id="Overwrite-fromUtf8"><a href="#Overwrite-fromUtf8" class="headerlink" title="Overwrite _fromUtf8"></a>Overwrite <code>_fromUtf8</code></h2><p>We also need to overwrite <code>_fromUtf8</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    _fromUtf8 = QtCore.QString.fromUtf8</div><div class="line"><span class="keyword">except</span> AttributeError:</div><div class="line">　　　　_fromUtf8 = <span class="keyword">lambda</span> s: s</div></pre></td></tr></table></figure>
<h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><p>These issues are described by predecessors:</p>
<ul>
<li>Handling SIGNAL</li>
<li>Change <code>FormToPySideWidget</code> to <code>FormToPyQtWidget</code></li>
<li>Change <code>setResizeMode</code> to <code>setSectionResizeMode</code></li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>This time, I was able to run idasec on IDA Pro 7.0 with <a href="https://github.com/RobinDavid/idasec/pull/2" target="_blank" rel="external">some bug fixes and dirty patches</a> – like this cool video:</p>
<center><iframe width="560" height="315" src="https://www.youtube.com/embed/Z14ab_rzjfA" frameborder="0" allowfullscreen></iframe></center>

<p>If you are an IDA Pro 7.0 user, note that other backward-compatibility issue described in <a href="https://www.hex-rays.com/products/ida/7.0/docs/idapython_backward_compat_695.shtml" target="_blank" rel="external">IDA: IDAPython backward-compatibility with 6.95 APIs</a> will occur.</p>
<p>Enjoy!</p>
<p>HAI DOMO VIRTUAL YOUTUBER KIZUNA AI DESU. I’m still working on my English.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/11/08/a-supplemental-guide-to-migrate-pySide-code-to-pyqt5-within-your-idapython-script/" data-id="cjvozzsrg0001xo7tneuwnzlu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-suppress-switching-ime-on-xming" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/11/06/suppress-switching-ime-on-xming/">Xmingによる入力言語の切り替えを防ぐ</a>
  

      </header>
    
    <time class="article-date" datetime="2016-11-06T09:40:00.000Z" itemprop="datePublished">11-06-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Xming"><a href="#Xming" class="headerlink" title="Xming"></a>Xming</h1><p>　<a href="http://www.straightrunning.com/XmingNotes/" target="_blank" rel="external">Xming</a>はWindows向けX Window System実装で，WindowsでX11 Forwardingをする場合のデファクトスタンダード．さて，日本語版のWindowsでXmingを利用していると，時折勝手に入力言語が英語に変わってしまうことがある．でまあOSSなのでソースコードを書き換えればいいんだけど，バイナリを読んだほうが早そう，ということでそのようにした．</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>　IDA Proでキーボード関連のAPIの呼び出し元を眺めると，LoadKeyboardLayoutのロケールID引数を英語 (0x0409) に設定していることがわかる．これを日本語 (0x0411) にすればよい．</p>
<p><img src="/image/xming/1.png" width="100%" height="100%"></p>
<p>　素直に.rdataセクションに載っているので，そのまま書き換えられる．</p>
<p><img src="/image/xming/2.png" width="100%" height="100%"></p>
<p>　紀元前のバイナリパッチ方式で書くと下記の通り：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">19AFAA: 30 31</div><div class="line">19AFAB: 39 31</div><div class="line">19AFB5: 55 4A</div><div class="line">19AFB6: 53 50</div></pre></td></tr></table></figure>
<p>　はい．</p>
<h1 id="追記-2016-11-07"><a href="#追記-2016-11-07" class="headerlink" title="追記 (2016.11.07)"></a>追記 (2016.11.07)</h1><p>　XmingのバージョンはPublic Domain Releases 6.9.0.31で，より新しい有償版で修正されているのかどうかは知らない．で，6.9.0.31の当該ソースコード (<code>xc/programs/Xserver/hw/xwin/winconfig.c</code>) にはなにやら不吉なコメントが記されているが，見なかったことにする．うちの環境では，レジストリ設定でCaps LockをCtrlに入れ替えてるし．</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (keyboardType == <span class="number">7</span>)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* Japanese layouts have problems with key event messages</span></div><div class="line">       such as the lack of WM_KEYUP for Caps Lock key.</div><div class="line">       Loading US layout fixes this problem. */</div><div class="line">    <span class="keyword">if</span> (LoadKeyboardLayout(<span class="string">"00000409"</span>, KLF_ACTIVATE) != <span class="literal">NULL</span>)</div><div class="line">      winMsg (X_INFO, <span class="string">"Loading US keyboard layout.\n"</span>);</div><div class="line">    <span class="keyword">else</span></div><div class="line">      winMsg (X_ERROR, <span class="string">"LoadKeyboardLaout failed.\n"</span>);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>　ご自身の責任でやっていってください．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/11/06/suppress-switching-ime-on-xming/" data-id="cjvozzssb001ixo7tqtron6l0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 ntddk<br>
      <a href="https://github.com/ntddk/hexo-theme-jathena" target="_blank">JAthena</a> by <a href="https://ntddk.github.io" target="_blank">ntddk</a> | Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>

<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
</body>
</html>