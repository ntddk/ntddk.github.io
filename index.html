<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>一生あとで読んでろ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="技術ブログ">
<meta property="og:type" content="website">
<meta property="og:title" content="一生あとで読んでろ">
<meta property="og:url" content="http://ntddk.github.io/index.html">
<meta property="og:site_name" content="一生あとで読んでろ">
<meta property="og:description" content="技術ブログ">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一生あとで読んでろ">
<meta name="twitter:description" content="技術ブログ">
  
  
  <link href="//fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">一生あとで読んでろ</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技術ブログ</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-home-icon" class="nav-icon" href="/"></a>
        
          <a id="nav-about-icon" class="nav-icon" href="/about"></a>
        
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-def-con-ctf-qualifier-2018-round-up" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2018/05/14/def-con-ctf-qualifier-2018-round-up/">DEF CON CTF Qualifier 2018 Round-up</a>
  

      </header>
    
    <time class="article-date" datetime="2018-05-14T11:00:00.000Z" itemprop="datePublished">05-14-2018</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>This is too brief to be called write-up. But I’m tired …</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>I’ve participated in DEF CON CTF Qualifier 2018 as a member of a certain team, ignominious 40th place. But somehow I solved 3 tasks:</p>
<ul>
<li>ELF Crumble</li>
<li>babypwn1805</li>
<li>elastic cloud compute (memory) corruption</li>
</ul>
<p>I write down my impressions.</p>
<h1 id="ELF-Crumble"><a href="#ELF-Crumble" class="headerlink" title="ELF Crumble"></a>ELF Crumble</h1><p>This is a task to combine and execute 8 binary fragments correctly. I wrote damn brute-force solver for this, 脳が死んでいるので．</p>
<h1 id="babypwn1805"><a href="#babypwn1805" class="headerlink" title="babypwn1805"></a>babypwn1805</h1><p>A blind pwn task. I accidentally found offset <code>-0x38</code> to the GOT entry of <code>read</code>. Then I wrote the probabilistic solver.</p>
<h1 id="elastic-cloud-compute-memory-corruption"><a href="#elastic-cloud-compute-memory-corruption" class="headerlink" title="elastic cloud compute (memory) corruption"></a>elastic cloud compute (memory) corruption</h1><p>A VM escape task.</p>
<p>We were given <code>qemu-system-x86_64</code> binary with vulnerable PCI device named <code>ooo</code>.　Notable functions are as follows:</p>
<table>
<thead>
<tr>
<th>function</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sub_6E61F4</code></td>
<td>correspond to <code>ooo_mmio_write</code></td>
</tr>
<tr>
<td><code>sub_6E613C</code></td>
<td>correspond to <code>ooo_mmio_read</code></td>
</tr>
<tr>
<td><code>sub_6E64A5</code></td>
<td>invokes <code>system(&quot;cat ./flag&quot;)</code></td>
</tr>
</tbody>
</table>
<p>What matters is use-after-free vulnerability in:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//----- (00000000006E61F4) ----------------------------------------------------</span></div><div class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">sub_6E61F4</span><span class="params">(__int64 opaque, __int64 addr, __int64 value, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd; <span class="comment">// eax</span></div><div class="line">...</div><div class="line"></div><div class="line">  *(_QWORD *)&amp;n[<span class="number">4</span>] = value;</div><div class="line">  cmd = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr &amp; <span class="number">0xF00000</span>) &gt;&gt; <span class="number">20</span>;</div><div class="line">  <span class="keyword">switch</span> ( cmd )</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">1u</span>:</div><div class="line">          <span class="built_in">free</span>(qword_1317940[((<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr &amp; <span class="number">0xF0000</span>) &gt;&gt; <span class="number">16</span>]);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="number">2u</span>:</div><div class="line">          v12 = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr &amp; <span class="number">0xF0000</span>) &gt;&gt; <span class="number">16</span>;</div><div class="line">          v8 = addr;</div><div class="line">          <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)qword_1317940[v12] + (<span class="keyword">signed</span> __int16)addr, &amp;n[<span class="number">4</span>], size);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="number">0u</span>:</div><div class="line">          idx = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr &amp; <span class="number">0xF0000</span>) &gt;&gt; <span class="number">16</span>;</div><div class="line">          <span class="keyword">if</span> ( idx == <span class="number">15</span> )</div><div class="line">          &#123;</div><div class="line">                <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">14</span>; ++i )</div><div class="line">                  qword_1317940[i] = <span class="built_in">malloc</span>(<span class="number">8L</span>L * *(_QWORD *)&amp;n[<span class="number">4</span>]);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">else</span></div><div class="line">          &#123;</div><div class="line">                qword_1317940[idx] = <span class="built_in">malloc</span>(<span class="number">8L</span>L * *(_QWORD *)&amp;n[<span class="number">4</span>]);</div><div class="line">          &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>With the clue of the chunk offset on <code>0x1317940</code>, now we can overwrite <code>malloc@GOT</code> to <code>sub_6E64A5</code> by fastbin attack, in particular using <code>devmem</code>.</p>
<p>I stayed up all night for this. I was tired but it was fun. I used these past write-ups as a reference when solving this task:</p>
<ul>
<li><a href="https://kitctf.de/writeups/hitb2017/babyqemu" target="_blank" rel="external">HITB GSEC 2017: babyqemu</a></li>
<li><a href="https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/" target="_blank" rel="external">QEMU Escape — vm_escape from 0CTF 2017 Finals Writeup - Eadom’s Blog</a></li>
</ul>
<p>Thanks authors!</p>
<h1 id="Final-Words"><a href="#Final-Words" class="headerlink" title="Final Words"></a>Final Words</h1><p>Other tasks I had wanted to solve are:</p>
<ul>
<li>flagsifier</li>
<li>TechSupport</li>
<li>smcauth</li>
</ul>
<p>This year DEFCON’s organizer has changed from LegitBS to OOO (Order of the-Overflow). OOO seems to have the purpose of connecting academic research and CTF. I support this philosophy, but this competition was not perfect. My impressions are summarized as follows:</p>
<table>
<thead>
<tr>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td>Meritocratic rev/pwn. Brand-new topics i.e. blockchain, neural network, reversing of Rust binary.</td>
<td>Many guessing tasks. Some incredible, old-fashioned tasks. In particular, sbva and ghettohackers: Throwback are quite bad.</td>
</tr>
</tbody>
</table>
<p>Anyway, I’m looking forward to that next year.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2018/05/14/def-con-ctf-qualifier-2018-round-up/" data-id="cjkr035sf000kpv7tl0ssumi2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/exploitation/">exploitation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-paper-gestalt-revisited-a-case-study-on-computer-security-conferences" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/12/24/paper-gestalt-revisited-a-case-study-on-computer-security-conferences/">Paper Gestalt Revisited: A Case Study on Computer Security Conferences</a>
  

      </header>
    
    <time class="article-date" datetime="2017-12-23T15:00:00.000Z" itemprop="datePublished">12-24-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>HAI DOMO. This post is for <a href="https://qiita.com/advent-calendar/2017/musashino" target="_blank" rel="external">武蔵野 Advent Calendar 2017</a>.</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>In May this year, I just started my career as an apprentice security researcher at 武蔵野某所．One of my job responsibilities is to write a “good” paper that enough to be accepted to top-tier (non-crypto) security conferences like following:</p>
<ul>
<li>IEEE S&amp;P (Oakland)</li>
<li>ACM CCS</li>
<li>NDSS</li>
<li>USENIX Security</li>
</ul>
<p>However, I am profoundly ignorant of cardinal rules of “good” security research and technical writing. ぜんぜんわからない．俺たちは雰囲気で研究をやっている．I thought I got to do something.</p>
<p>The joke paper entitled <a href="https://vision.cornell.edu/se3/wp-content/uploads/2014/09/gestalt.pdf" target="_blank" rel="external">Paper Gestalt</a>, distributed in CVPR’10, gave me a suggestion.</p>
<p>The key idea of the paper is that “good” paper might be distinguished by image recognition. だるくなってきた．時間がないので日本語で書きます．このジョーク論文では，論文を画像に変換，局所特徴量を抽出し，論文がトップカンファレンスにacceptされるかどうか判定する分類器が提案されている．仔細は<a href="http://d.hatena.ne.jp/n_hidekey/20120101/1325388164" target="_blank" rel="external">Paper Gestalt - n_hidekeyの日記</a>を参照されたい．かっこいい数式や図がある論文はそれっぽく見えてしまうよね，という話．</p>
<p>　そういうわけで，本稿ではPaper Gestaltを参考に，論文がセキュリティ系トップカンファレンスにacceptされるか判定する分類器を作成する．元論文ではAdaBoostを用いていたが，ここでは畳み込みニューラルネットを試す．</p>
<h1 id="Dataset"><a href="#Dataset" class="headerlink" title="Dataset"></a>Dataset</h1><p>　上述のカンファレンスにacceptされた論文4年分を正例，併設ワークショップにacceptされた論文同じく4年分をトップカンファレンスにrejectされた論文とみなして負例とする．負例には諸先輩方の論文が含まれていて，すみません，でもわかってくれると思うんです．</p>
<p>　さて一通りスクレイピングしたのち，ポスターやショートペーパーなど，4ページに満たないものを削除．キーノートやスライドも取り除く．重要なのはフルペーパーだからだ．結果，それぞれの論文数は以下の通り：</p>
<table>
<thead>
<tr>
<th>accepted</th>
<th>rejected</th>
</tr>
</thead>
<tbody>
<tr>
<td>1,266</td>
<td>794</td>
</tr>
</tbody>
</table>
<p>　正例のワードクラウド：</p>
<p><img src="/image/paper-gestalt-revisited/wordcloud_accepted.png"></p>
<p>　負例：</p>
<p><img src="/image/paper-gestalt-revisited/wordcloud_rejected.png"></p>
<p>　なんもわからん．</p>
<h1 id="Pre-processing"><a href="#Pre-processing" class="headerlink" title="Pre-processing"></a>Pre-processing</h1><p>　論文PDFを画像化する．</p>
<p>　論文PDFの各ページを横に並べ，20ページに満たない場合は白紙で埋める処理を施した．例：</p>
<p><img src="/image/paper-gestalt-revisited/preprocessed_image_1.png"></p>
<p>　見ての通り，USENIX系の本会議に通った論文にはかっこいい表紙が付いてくる．他の論文と体裁を合わせるため削除：</p>
<p><img src="/image/paper-gestalt-revisited/preprocessed_image_2.png"></p>
<p>　3時間ほどかけて全PDFをImageMagickで画像化，訓練用・検証用に半々で分割．</p>
<h1 id="Training"><a href="#Training" class="headerlink" title="Training"></a>Training</h1><p>　今回はベンチマークということでLeNet-5をほぼそのまま使う．いつもいつも手書き文字を認識させられるなど過酷な拷問を受けているやつ．</p>
<p><img src="/image/paper-gestalt-revisited/model.png" width="50%" height="50%"></p>
<p>　フレームワークはkeras. データが少数かつclass imbalancedであることを考慮して，<a href="https://blog.keras.io/building-powerful-image-classification-models-using-very-little-data.html" target="_blank" rel="external">Building powerful image classification models using very little data</a>に倣い，augmentationをかけながら訓練することにした．具体的にはズームと水平方向への反転．その他各種パラメータについてはありがちな構成を雰囲気で決めている：</p>
<table>
<thead>
<tr>
<th>活性化関数</th>
<th>損失関数</th>
<th>最適化手法</th>
<th>Dropout</th>
<th>バッチサイズ</th>
<th>エポック</th>
<th>Early stopping</th>
</tr>
</thead>
<tbody>
<tr>
<td>ReLU</td>
<td>クロスエントロピー</td>
<td>RMSProp</td>
<td>50%</td>
<td>64</td>
<td>100</td>
<td>validation accuracy</td>
</tr>
</tbody>
</table>
<p>　本来ならネットワーク構成含め細かくチューニングすべきだが，手元のショボい計算機では投稿日までに計算が終わらなさそうだったため，<a href="https://github.com/hyperopt/hyperopt" target="_blank" rel="external">hyperopt/hyperopt</a>やそのkeras連携機能である<a href="https://github.com/maxpumperla/hyperas" target="_blank" rel="external">maxpumperla/hyperas</a>とか，そういったかっこいいテクニックは使っていない．すみません2.</p>
<h1 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h1><p>　Early stoppingが効いて16エポックで学習打ち止め．学習曲線：</p>
<p><img src="/image/paper-gestalt-revisited/learning_curve_accuracy.png" width="50%" height="50%"><br><img src="/image/paper-gestalt-revisited/learning_curve_loss.png" width="50%" height="50%"></p>
<p>　微妙．しかし自分が学生時代に国内研究会に投げた論文を投入したところ，</p>
<table>
<thead>
<tr>
<th>accepted</th>
<th>rejected</th>
<th>predict</th>
</tr>
</thead>
<tbody>
<tr>
<td>7.3411%</td>
<td>92.6589%</td>
<td>rejected</td>
</tr>
</tbody>
</table>
<p>とまあ正しく判定できているっぽいのでよしとしましょう．なにが正しく判定だ．俺を，馬鹿にしているのか．いま，様々なものに対して害意を抱いています．Saliency mapの可視化とかは気が向いたら．</p>
<h1 id="Final-Words"><a href="#Final-Words" class="headerlink" title="Final Words"></a>Final Words</h1><p>　ACM CCS’17のWelcome Slidesにありがたいことばが載っている：</p>
<script async class="speakerdeck-embed" data-slide="35" data-id="a5ca2b52d1a046d59b1bcc6f7e4ab6b9" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>

<p>　つまりはそういうことです．小手先の浅知恵に逃げるものはなにをやってもだめ．やるぞ〜．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/12/24/paper-gestalt-revisited-a-case-study-on-computer-security-conferences/" data-id="cjkr035sl000wpv7tc14bt4cs" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/machine-learning/">machine learning</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-def-con-ctf-qualifier-2017-pepperidge-farm-write-up" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/12/04/def-con-ctf-qualifier-2017-pepperidge-farm-write-up/">DEF CON CTF Qualifier 2017 Pepperidge Farm Write-up</a>
  

      </header>
    
    <time class="article-date" datetime="2017-12-03T15:00:00.000Z" itemprop="datePublished">12-04-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>HAI DOMO. This post is for <a href="https://qiita.com/advent-calendar/2017/musashino" target="_blank" rel="external">武蔵野 Advent Calendar 2017</a> and also for <a href="https://adventar.org/calendars/2431" target="_blank" rel="external">CTF Advent Calendar 2017</a>.</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>In May this year, I participated in DEF CON CTF Qualifier 2017 as a member of a certain 武蔵野-related team. Actually, I’m not a top-tier CTF player, but I did my best and solved 4 challenges:</p>
<ul>
<li>crackme1</li>
<li>beatmeonthedl</li>
<li>enlightenment</li>
<li>Pepperidge Farm</li>
</ul>
<p><a href="https://ctftime.org/event/459/tasks/" target="_blank" rel="external">Write-ups</a> already exist except for Pepperidge Farm. So I decided to write about it. FYI: The binaries are available at <a href="https://github.com/legitbs/quals-2017/" target="_blank" rel="external">legitbs/quals-2017</a>.</p>
<h1 id="Pepperidge-Farm"><a href="#Pepperidge-Farm" class="headerlink" title="Pepperidge Farm"></a>Pepperidge Farm</h1><p>Pepperidge Farm is categorized into Reverse Engineering. The problem statement is below:</p>
<blockquote>
<p>Remember when the first CTF was run with a custom architecture? Pepperidge Farm remembers:<br><a href="https://github.com/JonathanSalwan/VMNDH-2k12" target="_blank" rel="external">https://github.com/JonathanSalwan/VMNDH-2k12</a></p>
<p>pepperidge-farm_edb4ad2f103a9efde038346d2cd86a1e.quals.shallweplayaga.me:2012</p>
<p>Files<br><a href="https://2017.notmalware.ru/8a45cf7171e89594cfd1d51671fef0bec3f24d9d/pepperidge_farm" target="_blank" rel="external">https://2017.notmalware.ru/8a45cf7171e89594cfd1d51671fef0bec3f24d9d/pepperidge_farm</a></p>
</blockquote>
<p>It seems like a keygenning challenge on the custom virtual machine–VMNDH-2k12.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ./vmndh -file pepperidge_farm</div><div class="line">Enter your registration code: 31337</div><div class="line">Code does not match any known registered users</div></pre></td></tr></table></figure>
<h1 id="VMNDH-2k12"><a href="#VMNDH-2k12" class="headerlink" title="VMNDH-2k12"></a>VMNDH-2k12</h1><p>VMNDH-2k12 is the VM built for Nuit du Hack CTF Quals 2012 as its name suggests. The architecture is described in <a href="http://shell-storm.org/project/Useless-emulator-for-fun-VMNDH-2k12/" target="_blank" rel="external">shell-storm | Useless emulator for fun (VMNDH-2k12)</a>. This VM parses given serialized binary and repeats fetch, decode and execution.</p>
<p>Writing IDA loader/processor module is a common way to analyze VM-based obfuscated binary. The modules for VMNDH-2k12 and for modified version VMNDH-2k13 already exist:</p>
<ul>
<li><a href="https://bitbucket.org/jonbutler88/ida-ndh/overview" target="_blank" rel="external">jonbutler88 / ida-ndh – Bitbucket</a></li>
<li><a href="http://blog.w4kfu.com/post/ndh2k13_crackme500" target="_blank" rel="external">Another NDH quals another VM wait - w4kfu’s bl0g</a></li>
</ul>
<p>Note that when you try to solve this challenge with above-mentioned processor modules with IDA Pro 7.0, the backward-compatibility issue will occur. For example, you have to change <code>self.regFirstSreg</code> to<code>self.reg_first_sreg</code> in a module.</p>
<p>Also, the Binary Ninja plugin has been released after quals:</p>
<ul>
<li><a href="https://github.com/verylazyguy/binaryninja-vmndh" target="_blank" rel="external">verylazyguy/binaryninja-vmndh: vmndh-2k12 Architecture plugin for Binary Ninja</a></li>
</ul>
<p>But in this post, I describe a solution without both IDA Pro and Binary Ninja. Because VMNDH-2k12 is open-sourced and easy to modify.</p>
<h1 id="Surface-Analysis"><a href="#Surface-Analysis" class="headerlink" title="Surface Analysis"></a>Surface Analysis</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">$ ./vmndh -debug -file pepperidge_farm</div><div class="line">[Console]#&gt; help</div><div class="line">&lt;enter&gt;              Execute next instruction</div><div class="line">run                  Run program</div><div class="line">bp &lt;addr&gt;            Set breakpoint</div><div class="line">info bp              Display info breakpoint</div><div class="line">info reg             Display registers</div><div class="line">show sp              Display SP memory</div><div class="line">show pc              Display PC memory</div><div class="line">dis &lt;addr&gt;:&lt;size&gt;    Disassembly X bytes from ADDR</div><div class="line">x/x &lt;addr&gt;:&lt;size&gt;    Print X bytes from ADDR</div><div class="line">x/s &lt;addr&gt;           Print string addr</div><div class="line">set reg=value        Set value in register</div><div class="line">syscall              Execute &apos;syscall&apos; instruction</div><div class="line">help                 Display this help</div><div class="line">quit                 Quit console debugging</div><div class="line">[Console]#&gt; dis</div><div class="line">Error: Set addr between 0x8000 and 0x882a</div><div class="line">[Console]#&gt; dis 0x8000:82a</div><div class="line">0x8000: jmpl 0x0720</div><div class="line">0x8003: push r2</div><div class="line">0x8007: .byte 0x00</div><div class="line">0x8008: nop</div><div class="line">...</div></pre></td></tr></table></figure>
<p>Yes, the VM has own debugger and disassembler.</p>
<h1 id="Modifying-The-Disassembler"><a href="#Modifying-The-Disassembler" class="headerlink" title="Modifying The Disassembler"></a>Modifying The Disassembler</h1><p>However, there are pitfalls here. </p>
<p>Because it is a unique architecture, the destination of the control flow instructions are different from it shown on the disassembly dump. For example, take a look at <code>src_vm/op_call.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">op_call_dir16</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint16_t</span> operande;</div><div class="line"></div><div class="line">  operande = *(<span class="keyword">uint16_t</span> *)(core.memory.vmem + core.memory.pc + <span class="number">2</span>);</div><div class="line">  <span class="keyword">if</span> (core.flagmode.noverbose == <span class="number">0</span>)</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"%s0x%4.x%s &gt; call 0x%.2x\n"</span>, RED, core.memory.pc, ENDC, operande);</div><div class="line"></div><div class="line">  core.memory.sp -= <span class="number">2</span>; <span class="comment">/* sub sp */</span></div><div class="line">  *(<span class="keyword">uint16_t</span> *)(core.memory.vmem + core.memory.sp) = core.memory.pc + <span class="number">4</span>;</div><div class="line">  core.memory.pc = core.memory.pc + operande + <span class="number">4</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Acording to this, I modified the dissassembler in <code>src_vm/disass.c</code>:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@@ -532,6 +537,7 @@</span></div><div class="line">   uint16_t  operande;</div><div class="line">   uint8_t   reg;</div><div class="line">   char      flag;</div><div class="line"><span class="addition">+  uint16_t dst;</span></div><div class="line"> </div><div class="line">   flag = *(core.memory.vmem + addr + 1);</div><div class="line">   switch (flag)</div><div class="line"><span class="meta">@@ -543,7 +549,8 @@</span></div><div class="line"> </div><div class="line">       case OP_FLAG_DIRECT16:</div><div class="line">         operande = *(uint16_t *)(core.memory.vmem + addr + 2);</div><div class="line"><span class="deletion">-        fprintf(stdout, "%s0x%.4x%s: call 0x%.4x\n", RED, addr, ENDC, operande);</span></div><div class="line"><span class="addition">+        dst = addr + operande + 4;</span></div><div class="line"><span class="addition">+        fprintf(stdout, "%s0x%.4x%s: call 0x%.4x\n", RED, addr, ENDC, dst);</span></div><div class="line">         return (addr + 4);</div><div class="line"> </div><div class="line">       default:</div></pre></td></tr></table></figure>
<p>This makes it possible to correctly display the address of the call destination in the disassembly dump. In addition, jump instructions need to be modified. In the case of <code>jnz</code>:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@@ -463,10 +470,11 @@</span></div><div class="line"> </div><div class="line"> static uint16_t dis_jnz(uint16_t addr)</div><div class="line"> &#123;</div><div class="line"><span class="deletion">-  uint16_t operande;</span></div><div class="line"><span class="addition">+  uint16_t operande, dst;</span></div><div class="line"> </div><div class="line">   operande = *(uint16_t *)(core.memory.vmem + addr + 1);</div><div class="line"><span class="deletion">-  fprintf(stdout, "%s0x%.4x%s: jnz 0x%.4x\n", RED, addr, ENDC, operande);</span></div><div class="line"><span class="addition">+  dst = addr + operande + 3;</span></div><div class="line"><span class="addition">+  fprintf(stdout, "%s0x%.4x%s: jnz 0x%.4x\n", RED, addr, ENDC, dst);</span></div><div class="line"> </div><div class="line">   return (addr + 3);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>Herewith,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">0x86a1: jnz 0x0076</div><div class="line">0x86a4: mov r0, r2</div><div class="line">0x86a8: call 0xfdc5</div><div class="line">0x86ac: test r0, r0</div><div class="line">0x86af: jnz 0x0068</div><div class="line">0x86b2: mov r0, r2</div><div class="line">0x86b6: call 0xfddf</div><div class="line">0x86ba: test r0, r0</div><div class="line">0x86bd: jnz 0x005a</div><div class="line">0x86c0: mov r0, r2</div><div class="line">0x86c4: call 0xfe17</div><div class="line">0x86c8: test r0, r0</div><div class="line">0x86cb: jnz 0x004c</div><div class="line">0x86ce: mov r0, r2</div><div class="line">0x86d2: call 0xfe2c</div><div class="line">0x86d6: test r0, r0</div><div class="line">...</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">0x86a1: jnz 0x871a</div><div class="line">0x86a4: mov r0, r2</div><div class="line">0x86a8: call 0x8471</div><div class="line">0x86ac: test r0, r0</div><div class="line">0x86af: jnz 0x871a</div><div class="line">0x86b2: mov r0, r2</div><div class="line">0x86b6: call 0x8499</div><div class="line">0x86ba: test r0, r0</div><div class="line">0x86bd: jnz 0x871a</div><div class="line">0x86c0: mov r0, r2</div><div class="line">0x86c4: call 0x84df</div><div class="line">0x86c8: test r0, r0</div><div class="line">0x86cb: jnz 0x871a</div><div class="line">0x86ce: mov r0, r2</div><div class="line">0x86d2: call 0x8502</div><div class="line">0x86d6: test r0, r0</div><div class="line">...</div></pre></td></tr></table></figure>
<p>Good.</p>
<p>Also, after <code>0x8759</code> it looks like a data section.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">0x8759: .byte 0x45 (E)</div><div class="line">0x875a: .byte 0x6e (n)</div><div class="line">0x875b: .byte 0x74 (t)</div><div class="line">0x875c: .byte 0x65 (e)</div><div class="line">0x875d: .byte 0x72 (r)</div><div class="line">...</div></pre></td></tr></table></figure>
<p>However, parts such as <code>0x87e8</code> are misinterpreted as codes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0x87e8: inc r82</div></pre></td></tr></table></figure>
<p>The data section was not obfuscated.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">00007e0: 6c61 6700 3ce3 5a9e 9113 8c05 e42e 0a52  lag.&lt;.Z........R</div><div class="line">00007f0: 3dd8 7cf5 9f4b 9f06 d7a8 e9a0 a636 a649  =.|..K.......6.I</div><div class="line">0000800: 3136 9308 eb70 ebbf df28 500d 7be8 96fa  16...p...(P.&#123;...</div><div class="line">0000810: e8b7 a5df c24d f0b8 3b78 6272 b748 1697  .....M..;xbr.H..</div><div class="line">0000820: f019 2d6b 085b 9f94 4987 e624 3752 efb8  ..-k.[..I..$7R..</div></pre></td></tr></table></figure>
<p>So I gave first aid to <code>src_vm/disass.c</code>:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@@ -322,8 +322,15 @@</span></div><div class="line"> static uint16_t dis_inc(uint16_t addr)</div><div class="line"> &#123;</div><div class="line">   uint8_t operande;</div><div class="line"><span class="addition">+  char OP, OP2;</span></div><div class="line"> </div><div class="line"><span class="addition">+  OP = *(core.memory.vmem + addr);</span></div><div class="line"><span class="addition">+  OP2 = *(core.memory.vmem + addr + 1);</span></div><div class="line">   operande = *(core.memory.vmem + addr + 1);</div><div class="line"><span class="addition">+  if(addr &gt; 0x8759)</span></div><div class="line"><span class="addition">+    fprintf(stdout, "%s0x%.4x%s: [DEBUG] .byte 0x%.2x\n", RED, addr, ENDC, (unsigned char)OP);</span></div><div class="line"><span class="addition">+    fprintf(stdout, "%s0x%.4x%s: [DEBUG] .byte 0x%.2x\n", RED, addr + 1, ENDC, (unsigned char)OP2);</span></div><div class="line"><span class="addition">+</span></div><div class="line">   fprintf(stdout, "%s0x%.4x%s: inc r%d\n", RED, addr, ENDC, operande);</div><div class="line"> </div><div class="line">   return (addr + 2);</div></pre></td></tr></table></figure>
<p>Awful… who cares?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0x87e8: [DEBUG] .byte 0x0a</div><div class="line">0x87e9: [DEBUG] .byte 0x52</div><div class="line">0x87e8: inc r82</div><div class="line">0x87ea: .byte 0x3d (=)</div></pre></td></tr></table></figure>
<h1 id="First-Attempt-with-KLEE"><a href="#First-Attempt-with-KLEE" class="headerlink" title="First Attempt with KLEE"></a>First Attempt with KLEE</h1><p>This is a failure case.</p>
<p>As we have seen so far, VMNDH-2k12 is open-sourced. So I tried to solve the challenge with source code-based symbolic execution tool–<a href="http://klee.github.io/" target="_blank" rel="external">KLEE</a>.</p>
<p>I modified <code>src_vm/syscall_write.c</code> for assertion:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">@@ -18,6 +18,8 @@</div><div class="line"> */</div><div class="line"> </div><div class="line"> #include &quot;vmndh.h&quot;</div><div class="line">+#include &lt;klee/klee.h&gt;</div><div class="line">+#include &lt;string.h&gt;</div><div class="line"> </div><div class="line"> void syscall_write(void)</div><div class="line"> &#123;</div><div class="line">@@ -32,7 +34,12 @@</div><div class="line"> </div><div class="line">   if (core.flagmode.noverbose == 0)</div><div class="line">     write(1, txt, strlen(txt));</div><div class="line">+</div><div class="line">+  if (strstr(arg2, &quot;Thank&quot;) != NULL)</div><div class="line">+    klee_assert(0);</div><div class="line">+</div><div class="line">   core.regs.r0 = write(arg1, arg2, arg3);</div><div class="line">+</div><div class="line">   if (core.flagmode.noverbose == 0)</div><div class="line">     write(1, &quot;\n&quot;, 1);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>Here is a modified <code>Makefile</code>:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@@ -17,14 +17,15 @@</span></div><div class="line"> ## Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</div><div class="line"> ##</div><div class="line"> </div><div class="line"><span class="deletion">-DEBUG   = no</span></div><div class="line"><span class="addition">+DEBUG   = yes</span></div><div class="line"> RM      = rm -f</div><div class="line"> INCLUDE = ./includes</div><div class="line"> SRC_DIR = ./src_vm</div><div class="line"><span class="addition">+KLEE_PATH = ../klee_src/include</span></div><div class="line"> NAME    = vmndh</div><div class="line"> </div><div class="line"> ifeq ($(DEBUG),yes)</div><div class="line"><span class="deletion">-    CFLAGS   	= -c -ggdb3 -Wextra -Wall -D _BSD_SOURCE -I$(INCLUDE)</span></div><div class="line"><span class="addition">+    CFLAGS   	= -c -ggdb3 -Wextra -Wall -D _BSD_SOURCE -I$(INCLUDE) -I$(KLEE_PATH) -emit-llvm -g</span></div><div class="line">     LDFLAGS     =</div><div class="line">     CC 		= clang</div><div class="line"> else</div></pre></td></tr></table></figure>
<p>I’d left all of it to KLEE and get to bed…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">$ make</div><div class="line">$ llvm-link src_vm/*.o -o vmndh.bc</div><div class="line">$ klee --optimize --emit-all-errors --libc=uclibc --write-smt2s --posix-runtime vmndh.bc -file pepperidge_farm -sym-stdin 65</div><div class="line">KLEE: NOTE: Using klee-uclibc : /home/klee/klee_build/klee/Release+Debug+Asserts/lib/klee-uclibc.bca</div><div class="line">KLEE: NOTE: Using model: /home/klee/klee_build/klee/Release+Debug+Asserts/lib/libkleeRuntimePOSIX.bca</div><div class="line">KLEE: output directory is &quot;/home/klee/VMNDH-2k12/klee-out-1&quot;</div><div class="line">KLEE: Using STP solver backend</div><div class="line">KLEE: WARNING ONCE: function &quot;__user_main&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_accept&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_bind&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_listen&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_recv&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_send&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: function &quot;syscall_socket&quot; has inline asm</div><div class="line">KLEE: WARNING ONCE: calling external: syscall(16, 0, 21505, 44258832) at /home/klee/klee_src/runtime/POSIX/fd.c:1044</div><div class="line">KLEE: WARNING ONCE: Alignment of memory from call &quot;malloc&quot; is not modelled. Using alignment of 8.</div><div class="line">Enter your registration code: KLEE: WARNING ONCE: calling external: vprintf(57126208, 46345808) at /home/klee/klee_build/klee-uclibc/libc/stdio/fprintf.c:36</div><div class="line">[SYSCALL output]: 64</div><div class="line">KLEE: WARNING ONCE: skipping fork (memory cap exceeded)</div><div class="line">...</div><div class="line">KLEE: WARNING: killing 175 states (over memory cap)</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">Code does not match any known registered users</div><div class="line">...</div><div class="line">Code does not match any known registered users</div><div class="line"></div><div class="line">KLEE: done: total instructions = 5117896332</div><div class="line">KLEE: done: completed paths = 81092</div><div class="line">KLEE: done: generated tests = 81092</div></pre></td></tr></table></figure>
<p>… It’s not going to be easy.</p>
<p>I also wrote solver with <a href="http://angr.io/" target="_blank" rel="external">angr</a>. Which symbolizes stdin, but… let’s not talk about it.</p>
<p>An example of insufficient SMTLIB2 representations is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(set-logic QF_AUFBV )</div><div class="line">(declare-fun model_version () (Array (_ BitVec 32) (_ BitVec 8) ) )</div><div class="line">(declare-fun stdin () (Array (_ BitVec 32) (_ BitVec 8) ) )</div><div class="line">(declare-fun stdin-stat () (Array (_ BitVec 32) (_ BitVec 8) ) )</div><div class="line">(assert (let ( (?B1 (select  stdin (_ bv25 32) ) ) (?B2 (select  stdin (_ bv31 32) ) ) (?B3 (select  stdin (_ bv18 32) ) ) (?B4 (select  stdin (_ bv40 32) ) ) (?B5 (select  stdin (_ bv36 32) ) ) (?B6 (select  stdin (_ bv23 32) ) ) (?B7 (select  stdin (_ bv27 32) ) ) (?B8 (select  stdin (_ bv33 32) ) ) (?B9 (select  stdin (_ bv6 32) ) ) (?B10 (select  stdin (_ bv8 32) ) ) ) (let ( (?B13 ((_ zero_extend 16)  ((_ zero_extend 8)  ?B7 ) ) ) (?B14 ((_ zero_extend 16)  ((_ zero_extend 8)  ?B8 ) ) ) (?B12 ((_ zero_extend 16)  ((_ zero_extend 8)  ?B2 ) ) ) (?B11 ((_ zero_extend 16)  ((_ zero_extend 8)  ?B1 ) ) ) ) (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (and  (=  false (=  (_ bv0 64) (bvand  (concat  (select  stdin-stat (_ bv15 32) ) (concat  (select  stdin-stat (_ bv14 32) ) (concat  (select  stdin-stat (_ bv13 32) ) (concat  (select  stdin-stat (_ bv12 32) ) (concat  (select  stdin-stat (_ bv11 32) ) (concat  (select  stdin-stat (_ bv10 32) ) (concat  (select  stdin-stat (_ bv9 32) ) (select  stdin-stat (_ bv8 32) ) ) ) ) ) ) ) ) (_ bv2147483647 64) ) ) ) (bvult  (concat  (select  stdin-stat (_ bv63 32) ) (concat  (select  stdin-stat (_ bv62 32) ) (concat  (select  stdin-stat (_ bv61 32) ) (concat  (select  stdin-stat (_ bv60 32) ) (concat  (select  stdin-stat (_ bv59 32) ) (concat  (select  stdin-stat (_ bv58 32) ) (concat  (select  stdin-stat (_ bv57 32) ) (select  stdin-stat (_ bv56 32) ) ) ) ) ) ) ) ) (_ bv65536 64) ) ) (=  (_ bv1 32) (concat  (select  model_version (_ bv3 32) ) (concat  (select  model_version (_ bv2 32) ) (concat  (select  model_version (_ bv1 32) ) (select  model_version (_ bv0 32) ) ) ) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv0 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv1 32) ) ) ) (=  (_ bv57 8) (select  stdin (_ bv2 32) ) ) ) (=  (_ bv70 8) (select  stdin (_ bv3 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv4 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv5 32) ) ) ) (=  false (=  (_ bv48 8) ?B9 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B9 ) ) ) ) ) (=  false (=  (_ bv48 8) ?B10 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B10 ) ) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv12 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv13 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv14 32) ) ) ) (=  (_ bv57 8) (select  stdin (_ bv15 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv16 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv17 32) ) ) ) (=  false (=  (_ bv48 8) ?B3 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B3 ) ) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv20 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv21 32) ) ) ) (=  (_ bv57 8) (select  stdin (_ bv22 32) ) ) ) (=  false (=  (_ bv48 8) ?B6 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B6 ) ) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv24 32) ) ) ) (=  false (=  (_ bv48 8) ?B1 ) ) ) (bvult  (_ bv48 32) ?B11 ) ) (=  false (=  (_ bv57 8) ?B1 ) ) ) (=  false (bvult  (_ bv57 32) ?B11 ) ) ) (=  (_ bv48 8) (select  stdin (_ bv26 32) ) ) ) (=  false (=  (_ bv48 8) ?B7 ) ) ) (bvult  (_ bv48 32) ?B13 ) ) (=  false (=  (_ bv57 8) ?B7 ) ) ) (=  false (bvult  (_ bv57 32) ?B13 ) ) ) (=  (_ bv48 8) (select  stdin (_ bv28 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv29 32) ) ) ) (=  (_ bv48 8) (select  stdin (_ bv30 32) ) ) ) (=  false (=  (_ bv48 8) ?B2 ) ) ) (bvult  (_ bv48 32) ?B12 ) ) (=  false (=  (_ bv57 8) ?B2 ) ) ) (=  false (bvult  (_ bv57 32) ?B12 ) ) ) (=  (_ bv48 8) (select  stdin (_ bv32 32) ) ) ) (=  false (=  (_ bv48 8) ?B8 ) ) ) (bvult  (_ bv48 32) ?B14 ) ) (=  false (=  (_ bv57 8) ?B8 ) ) ) (bvult  (_ bv57 32) ?B14 ) ) (=  false (=  (_ bv70 8) ?B8 ) ) ) (bvult  (_ bv70 32) ?B14 ) ) (=  false (=  (_ bv48 8) ?B5 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B5 ) ) ) ) ) (=  false (=  (_ bv48 8) ?B4 ) ) ) (=  false (bvult  (_ bv48 32) ((_ zero_extend 16)  ((_ zero_extend 8)  ?B4 ) ) ) ) ) ) ) )</div><div class="line">(check-sat)</div><div class="line">(exit)</div></pre></td></tr></table></figure>
<h1 id="Solution-with-Z3"><a href="#Solution-with-Z3" class="headerlink" title="Solution with Z3"></a>Solution with Z3</h1><p>Since there is no choice, I read all the disassembly. After some twists and turn, I realized that:</p>
<ul>
<li>Pepperidge Farm checks character codes against transformed <code>0x20</code> bytes values.</li>
<li><code>0x8247(x, y)</code> returns <code>x * 100 + y</code>.</li>
</ul>
<p>Now <a href="https://github.com/Z3Prover/z3" target="_blank" rel="external">Z3</a> time. For example, subroutine <code>0x8269</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">0x8269: push r1</div><div class="line">0x826d: pop r2</div><div class="line">0x826f: mov r7, r0</div><div class="line">0x8273: addb r0, #00</div><div class="line">0x8277: call 0x8247</div><div class="line">0x827b: mov r1, r0</div><div class="line">0x827f: mov r0, r7</div><div class="line">0x8283: addb r0, #14</div><div class="line">0x8287: call 0x8247</div><div class="line">0x828b: mov r2, r0</div><div class="line">0x828f: movl r0, #0x87ec</div><div class="line">0x8294: call 0x8247</div><div class="line">0x8298: xorl r1, #4936</div><div class="line">0x829d: add r1, r2</div><div class="line">0x82a1: xor r0, r1</div><div class="line">0x82a5: pop r2</div><div class="line">0x82a7: pop r1</div><div class="line">0x82a9: ret</div><div class="line">...</div><div class="line">0x87ec: .byte 0x7c (|)</div><div class="line">0x87ed: .byte 0xf5</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.add(((sub_8247(<span class="number">0</span>) ^ <span class="number">0x4936</span>) + sub_8247(<span class="number">0x14</span>)) ^ <span class="number">0x7cf5</span> == <span class="number">0</span>)</div></pre></td></tr></table></figure>
<p>This is satisfiable. But not enough. We need to add rest of constraints.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding: utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> telnetlib, sys</div><div class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</div><div class="line"></div><div class="line">REMOTE = len(sys.argv) &gt;= <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">'r'</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> REMOTE:</div><div class="line">    host = <span class="string">'pepperidge-farm_edb4ad2f103a9efde038346d2cd86a1e.quals.shallweplayaga.me'</span></div><div class="line">    port = <span class="number">2012</span></div><div class="line"><span class="keyword">else</span>:</div><div class="line">    host = <span class="string">'127.0.0.1'</span></div><div class="line">    port = <span class="number">4000</span></div><div class="line"></div><div class="line">values = [BitVec(<span class="string">'x%d'</span> % i, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>)]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_8247</span><span class="params">(x)</span>:</span> <span class="keyword">return</span> ZeroExt(<span class="number">8</span>, values[x]) &lt;&lt; <span class="number">8</span> | ZeroExt(<span class="number">8</span>, values[x + <span class="number">1</span>])</div><div class="line"></div><div class="line">s = Solver()</div><div class="line"></div><div class="line"><span class="comment"># sub_8269</span></div><div class="line">s.add(((sub_8247(<span class="number">0</span>) ^ <span class="number">0x4936</span>) + sub_8247(<span class="number">0x14</span>)) ^ <span class="number">0x7cf5</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_82aa</span></div><div class="line">s.add(sub_8247(<span class="number">6</span>) * sub_8247(<span class="number">8</span>) * (sub_8247(<span class="number">2</span>) ^ <span class="number">0xfdf</span>) ^ <span class="number">0x3dd8</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8304</span></div><div class="line">s.add(((sub_8247(<span class="number">4</span>) ^ <span class="number">0xc7df</span>) + sub_8247(<span class="number">0xe</span>) * sub_8247(<span class="number">0xc</span>)) ^ <span class="number">0xeb70</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_835e</span></div><div class="line">s.add(((sub_8247(<span class="number">6</span>) ^ <span class="number">0xc5db</span>) + <span class="number">0x14aa</span>) ^ <span class="number">0x500d</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_838b</span></div><div class="line">s.add(sub_8247(<span class="number">8</span>) * sub_8247(<span class="number">0x1e</span>) ^ <span class="number">0x7be8</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_83c7</span></div><div class="line">s.add((sub_8247(<span class="number">0xa</span>) + sub_8247(<span class="number">6</span>) + sub_8247(<span class="number">0xC</span>)) ^ <span class="number">0xdf28</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_841c</span></div><div class="line">s.add(((sub_8247(<span class="number">0xC</span>) + <span class="number">0x5432</span>) | <span class="number">0x3008</span>) ^ <span class="number">0x3b78</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8449</span></div><div class="line">s.add((sub_8247(<span class="number">0xE</span>) + <span class="number">0x1212</span>) ^ <span class="number">0x1697</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8471</span></div><div class="line">s.add((sub_8247(<span class="number">0x10</span>) ^ <span class="number">0x8703</span>) ^  <span class="number">0x3136</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8499</span></div><div class="line">s.add(((sub_8247(<span class="number">0x12</span>) + <span class="number">0x4004</span>) + (sub_8247(<span class="number">0x14</span>) ^ <span class="number">0xA52</span>)) ^  <span class="number">0x6272</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_84df</span></div><div class="line">s.add()</div><div class="line"><span class="comment"># sub_8502</span></div><div class="line">s.add((sub_8247(<span class="number">0x16</span>) + sub_8247(<span class="number">0x10</span>)) ^ <span class="number">0x9308</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_853e</span></div><div class="line">s.add(sub_8247(<span class="number">0x18</span>) ^ <span class="number">0x085b</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_8561</span></div><div class="line">s.add(((sub_8247(<span class="number">0x1a</span>) ^ <span class="number">0x863c</span>) + <span class="number">0x1234</span>) ^ <span class="number">0x9113</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_858e</span></div><div class="line">s.add((sub_8247(<span class="number">0x1c</span>) + sub_8247(<span class="number">8</span>) + sub_8247(<span class="number">0x12</span>)) ^ <span class="number">0xf0b8</span> == <span class="number">0</span>)</div><div class="line"><span class="comment"># sub_85e3</span></div><div class="line">s.add(((sub_8247(<span class="number">0x1e</span>) &amp; <span class="number">0x0f00</span>) + sub_8247(<span class="number">0</span>)) ^ <span class="number">0x9f94</span> == <span class="number">0</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> s.check()</div><div class="line"><span class="keyword">print</span> s.model()</div><div class="line"></div><div class="line">input = <span class="string">''</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>):</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        input += <span class="string">'%02x'</span> % s.model()[values[i]].as_long()</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        input += <span class="string">'??'</span></div><div class="line"></div><div class="line">input = input.upper()</div><div class="line"><span class="keyword">print</span> input</div><div class="line"></div><div class="line">t = telnetlib.Telnet(host, port)</div><div class="line">t.write(input + <span class="string">'\n'</span>)</div><div class="line">t.interact()</div></pre></td></tr></table></figure>
<p>Even with halfway constraints, the process proceeds. So inscount with <a href="https://software.intel.com/en-us/articles/pin-a-dynamic-binary-instrumentation-tool" target="_blank" rel="external">Pin</a> or other dynamic binary instrumentation tools might be helpful.</p>
<p>Finally I got:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Enter your registration code: 90940C6017E5FEB82083F932E73E0485B635796DA353DCD3085BF8E356C87FF8</div><div class="line">Thank you for your patronage!</div><div class="line">Your username is: pepperidge</div><div class="line">This is the flag: th0s3_wh0_l0ok_0nly_to_th3_p4stur3_ar3_cert4in_t0_miss_th3_futur3</div></pre></td></tr></table></figure>
<p>The conclusive SMTLIB2 representation is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">; benchmark</div><div class="line">(set-info :status unknown)</div><div class="line">(set-logic QF_AUFBV)</div><div class="line">(declare-fun x1 () (_ BitVec 8))</div><div class="line">(declare-fun x0 () (_ BitVec 8))</div><div class="line">(declare-fun x31 () (_ BitVec 8))</div><div class="line">(declare-fun x30 () (_ BitVec 8))</div><div class="line">(declare-fun x19 () (_ BitVec 8))</div><div class="line">(declare-fun x18 () (_ BitVec 8))</div><div class="line">(declare-fun x9 () (_ BitVec 8))</div><div class="line">(declare-fun x8 () (_ BitVec 8))</div><div class="line">(declare-fun x29 () (_ BitVec 8))</div><div class="line">(declare-fun x28 () (_ BitVec 8))</div><div class="line">(declare-fun x27 () (_ BitVec 8))</div><div class="line">(declare-fun x26 () (_ BitVec 8))</div><div class="line">(declare-fun x25 () (_ BitVec 8))</div><div class="line">(declare-fun x24 () (_ BitVec 8))</div><div class="line">(declare-fun x17 () (_ BitVec 8))</div><div class="line">(declare-fun x16 () (_ BitVec 8))</div><div class="line">(declare-fun x23 () (_ BitVec 8))</div><div class="line">(declare-fun x22 () (_ BitVec 8))</div><div class="line">(declare-fun x21 () (_ BitVec 8))</div><div class="line">(declare-fun x20 () (_ BitVec 8))</div><div class="line">(declare-fun x15 () (_ BitVec 8))</div><div class="line">(declare-fun x14 () (_ BitVec 8))</div><div class="line">(declare-fun x13 () (_ BitVec 8))</div><div class="line">(declare-fun x12 () (_ BitVec 8))</div><div class="line">(declare-fun x7 () (_ BitVec 8))</div><div class="line">(declare-fun x6 () (_ BitVec 8))</div><div class="line">(declare-fun x11 () (_ BitVec 8))</div><div class="line">(declare-fun x10 () (_ BitVec 8))</div><div class="line">(declare-fun x5 () (_ BitVec 8))</div><div class="line">(declare-fun x4 () (_ BitVec 8))</div><div class="line">(declare-fun x3 () (_ BitVec 8))</div><div class="line">(declare-fun x2 () (_ BitVec 8))</div><div class="line">(assert</div><div class="line"> (let ((?x206 (bvand (bvor (bvshl ((_ zero_extend 8) x30) (_ bv8 16)) ((_ zero_extend 8) x31)) (_ bv3840 16))))</div><div class="line">(let ((?x209 (bvxor (bvadd ?x206 (bvor (bvshl ((_ zero_extend 8) x0) (_ bv8 16)) ((_ zero_extend 8) x1))) (_ bv40852 16))))</div><div class="line">(let (($x210 (= ?x209 (_ bv0 16))))</div><div class="line">(let ((?x82 (bvor (bvshl ((_ zero_extend 8) x8) (_ bv8 16)) ((_ zero_extend 8) x9))))</div><div class="line">(let ((?x200 (bvadd (bvor (bvshl ((_ zero_extend 8) x28) (_ bv8 16)) ((_ zero_extend 8) x29)) ?x82)))</div><div class="line">(let ((?x201 (bvadd ?x200 (bvor (bvshl ((_ zero_extend 8) x18) (_ bv8 16)) ((_ zero_extend 8) x19)))))</div><div class="line">(let (($x204 (= (bvxor ?x201 (_ bv61624 16)) (_ bv0 16))))</div><div class="line">(let ((?x190 (bvxor (bvor (bvshl ((_ zero_extend 8) x26) (_ bv8 16)) ((_ zero_extend 8) x27)) (_ bv34364 16))))</div><div class="line">(let (($x195 (= (bvxor (bvadd ?x190 (_ bv4660 16)) (_ bv37139 16)) (_ bv0 16))))</div><div class="line">(let ((?x183 (bvxor (bvor (bvshl ((_ zero_extend 8) x24) (_ bv8 16)) ((_ zero_extend 8) x25)) (_ bv2139 16))))</div><div class="line">(let (($x184 (= ?x183 (_ bv0 16))))</div><div class="line">(let ((?x174 (bvadd (bvor (bvshl ((_ zero_extend 8) x22) (_ bv8 16)) ((_ zero_extend 8) x23)) (bvor (bvshl ((_ zero_extend 8) x16) (_ bv8 16)) ((_ zero_extend 8) x17)))))</div><div class="line">(let (($x177 (= (bvxor ?x174 (_ bv37640 16)) (_ bv0 16))))</div><div class="line">(let ((?x165 (bvxor (bvor (bvshl ((_ zero_extend 8) x20) (_ bv8 16)) ((_ zero_extend 8) x21)) (_ bv2642 16))))</div><div class="line">(let ((?x163 (bvadd (bvor (bvshl ((_ zero_extend 8) x18) (_ bv8 16)) ((_ zero_extend 8) x19)) (_ bv16388 16))))</div><div class="line">(let (($x169 (= (bvxor (bvadd ?x163 ?x165) (_ bv25202 16)) (_ bv0 16))))</div><div class="line">(let ((?x154 (bvxor (bvor (bvshl ((_ zero_extend 8) x16) (_ bv8 16)) ((_ zero_extend 8) x17)) (_ bv34563 16))))</div><div class="line">(let (($x157 (= (bvxor ?x154 (_ bv12598 16)) (_ bv0 16))))</div><div class="line">(let ((?x145 (bvadd (bvor (bvshl ((_ zero_extend 8) x14) (_ bv8 16)) ((_ zero_extend 8) x15)) (_ bv4626 16))))</div><div class="line">(let (($x148 (= (bvxor ?x145 (_ bv5783 16)) (_ bv0 16))))</div><div class="line">(let ((?x107 (bvor (bvshl ((_ zero_extend 8) x12) (_ bv8 16)) ((_ zero_extend 8) x13))))</div><div class="line">(let (($x143 (= (bvxor (bvor (bvadd ?x107 (_ bv21554 16)) (_ bv12296 16)) (_ bv15224 16)) (_ bv0 16))))</div><div class="line">(let ((?x78 (bvor (bvshl ((_ zero_extend 8) x6) (_ bv8 16)) ((_ zero_extend 8) x7))))</div><div class="line">(let ((?x132 (bvadd (bvor (bvshl ((_ zero_extend 8) x10) (_ bv8 16)) ((_ zero_extend 8) x11)) ?x78)))</div><div class="line">(let (($x136 (= (bvxor (bvadd ?x132 ?x107) (_ bv57128 16)) (_ bv0 16))))</div><div class="line">(let ((?x124 (bvmul ?x82 (bvor (bvshl ((_ zero_extend 8) x30) (_ bv8 16)) ((_ zero_extend 8) x31)))))</div><div class="line">(let (($x127 (= (bvxor ?x124 (_ bv31720 16)) (_ bv0 16))))</div><div class="line">(let (($x119 (= (bvxor (bvadd (bvxor ?x78 (_ bv50651 16)) (_ bv5290 16)) (_ bv20493 16)) (_ bv0 16))))</div><div class="line">(let ((?x108 (bvmul (bvor (bvshl ((_ zero_extend 8) x14) (_ bv8 16)) ((_ zero_extend 8) x15)) ?x107)))</div><div class="line">(let ((?x109 (bvadd (bvxor (bvor (bvshl ((_ zero_extend 8) x4) (_ bv8 16)) ((_ zero_extend 8) x5)) (_ bv51167 16)) ?x108)))</div><div class="line">(let (($x112 (= (bvxor ?x109 (_ bv60272 16)) (_ bv0 16))))</div><div class="line">(let ((?x90 (bvmul (bvmul ?x78 ?x82) (bvxor (bvor (bvshl ((_ zero_extend 8) x2) (_ bv8 16)) ((_ zero_extend 8) x3)) (_ bv4063 16)))))</div><div class="line">(let (($x93 (= (bvxor ?x90 (_ bv15832 16)) (_ bv0 16))))</div><div class="line">(let ((?x50 (bvadd (bvxor (bvor (bvshl ((_ zero_extend 8) x0) (_ bv8 16)) ((_ zero_extend 8) x1)) (_ bv18742 16)) (bvor (bvshl ((_ zero_extend 8) x20) (_ bv8 16)) ((_ zero_extend 8) x21)))))</div><div class="line">(let (($x54 (= (bvxor ?x50 (_ bv31989 16)) (_ bv0 16))))</div><div class="line">(and $x54 $x93 $x112 $x119 $x127 $x136 $x143 $x148 $x157 $x169 $x177 $x184 $x195 $x204 $x210)))))))))))))))))))))))))))))))))))))</div><div class="line">(check-sat)</div></pre></td></tr></table></figure>
<h1 id="Final-Words"><a href="#Final-Words" class="headerlink" title="Final Words"></a>Final Words</h1><p>I enjoyed this challenge. It seems to be easy or medium-easy difficulty rating. If only I could have solved more difficult Reverse Engineering challenges during quals–liberty, godzilla, and so on.</p>
<p>Recently I read <a href="https://www.usenix.org/conference/usenixsecurity17/technical-sessions/presentation/blazytko" target="_blank" rel="external">T. Blazytko et al. USENIX Security’17</a>. The paper says the system named Syntia automatically deobfuscate binaries with program synthesis. Program synthesis is a method to synthesize some pieces of program from given I/O samples and possible operators–like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding: utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</div><div class="line"></div><div class="line">x, y, h = BitVecs([<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'h'</span>], <span class="number">8</span>)</div><div class="line"></div><div class="line"><span class="comment"># I/O samples</span></div><div class="line">t1 = And(x == <span class="number">1</span>, y == <span class="number">2</span>)</div><div class="line">t2 = And(x == <span class="number">2</span>, y == <span class="number">4</span>)</div><div class="line">t3 = And(x == <span class="number">3</span>, y == <span class="number">6</span>)</div><div class="line">phi_1 = Or(t1, t2, t3)</div><div class="line"></div><div class="line"><span class="comment"># h is subject to synthesize</span></div><div class="line">phi_2 = y == x &lt;&lt; h</div><div class="line"></div><div class="line">s = Solver()</div><div class="line">s.add(ForAll([x, y], Implies(phi_1, phi_2)))</div><div class="line"></div><div class="line"><span class="keyword">print</span> s.check() <span class="comment"># sat</span></div><div class="line"><span class="keyword">print</span> s.model() <span class="comment"># [h = 2]</span></div></pre></td></tr></table></figure>
<p>This is just a simple example. In practical, program slicing and path pruning will be needed. Both symbolic execution and program synthesis depend on SMT solver, but according to the paper, program synthesis is more suitable for deobfuscation tasks… really? I’ll investigate further.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/12/04/def-con-ctf-qualifier-2017-pepperidge-farm-write-up/" data-id="cjkr035t40028pv7tqne33k0i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/program-synthesis/">program synthesis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-how-i-found-the-honeypot-dark-web-osint-and-image-processing" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/12/02/how-i-found-the-honeypot-dark-web-osint-and-image-processing/">How I Found the Honeypot: Dark Web OSINT and Image Processing</a>
  

      </header>
    
    <time class="article-date" datetime="2017-12-01T15:00:00.000Z" itemprop="datePublished">12-02-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>This post is for <a href="https://adventar.org/calendars/2263" target="_blank" rel="external">Honeypot Advent Calendar 2017</a>.</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>In May this year, Trend Micro researchers have announced interesting research results in the article titled <a href="http://blog.trendmicro.com/trendlabs-security-intelligence/red-on-red-the-attack-landscape-of-the-dark-web/" target="_blank" rel="external">Red on Red: The Attack Landscape of the Dark Web - TrendLabs Security Intelligence Blog</a>. They had deployed a honeypot on the dark web and monitored attack activities. They’ve done great work, indeed.</p>
<p>Well then, with the aid of the screenshot in that article, probably I found the honeypot. May I introduce the how and why?</p>
<h1 id="Dark-Web-OSINT"><a href="#Dark-Web-OSINT" class="headerlink" title="Dark Web OSINT"></a>Dark Web OSINT</h1><p>In March this year, when they would have created an presentation slide, I have been running the crawler for the dark web. My purpose was to create a pictorial book of Tor hidden services below:</p>
<p><img src="/image/onionstack/onionstack.png" width="100%" height="100%"></p>
<p>The crawler is simple, just like saying “Hello, world!” to PhantomJS. It has only capability of taking a screenshot.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">service_args = [ </div><div class="line">            <span class="comment"># Do not insert blank to each of args.</span></div><div class="line">            <span class="string">'--proxy=127.0.0.1:9050'</span>,</div><div class="line">            <span class="string">'--proxy-type=socks5'</span></div><div class="line">        ]</div><div class="line">dcap = &#123;</div><div class="line">        <span class="string">'phantomjs.page.settings.userAgent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; rv:31.0) Gecko/20100101 Firefox/31.0'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_title_with_screenshot</span><span class="params">(url)</span>:</span></div><div class="line">    driver = webdriver.PhantomJS(service_args = service_args, desired_capabilities = dcap)</div><div class="line">    driver.set_window_size(<span class="number">1024</span>, <span class="number">512</span>)</div><div class="line">    driver.get(<span class="string">'http://'</span> + url + <span class="string">'.onion'</span>) <span class="comment"># 'http://' is required.</span></div><div class="line">    driver.save_screenshot(url + <span class="string">'.png'</span>)</div><div class="line">    title = driver.title</div><div class="line">    driver.close()</div><div class="line">    <span class="keyword">return</span> title</div></pre></td></tr></table></figure>
<p>I have discovered 40,208 onion domains and confirmed 1,797 domains were active.</p>
<h1 id="Image-Processing"><a href="#Image-Processing" class="headerlink" title="Image Processing"></a>Image Processing</h1><p>Thanks to collecting screenshots by chance, I was able to find a site similar to the screenshot in their article–with histgram calculation:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">list = glob.glob(<span class="string">'./images/*.png'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">cbir</span><span class="params">()</span>:</span></div><div class="line">    target_im = cv2.imread(sys.argv[<span class="number">1</span>])</div><div class="line">    target_hist = cv2.calcHist([target_im], [<span class="number">0</span>], <span class="keyword">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">256</span>])</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> list:</div><div class="line">        comparing_im = cv2.imread(i)</div><div class="line">        comparing_hist = cv2.calcHist([comparing_im], [<span class="number">0</span>], <span class="keyword">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">256</span>])</div><div class="line">        diff = cv2.compareHist(target_hist, comparing_hist, <span class="number">0</span>)</div><div class="line">        <span class="keyword">if</span> diff &gt; float(sys.argv[<span class="number">2</span>]): <span class="comment"># Threshold</span></div><div class="line">            <span class="keyword">print</span> i, diff</div></pre></td></tr></table></figure>
<p>Yet domain names are not posted in their articles, I believe this is it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ wget http://blog.trendmicro.com/trendlabs-security-intelligence/files/2017/05/red-on-red-1.jpg</div><div class="line">$ cbir.py red-on-red-1.jpg</div><div class="line">$ python cbir.py red-on-red-1.jpg 0.9</div><div class="line">./images/s5**********jlp2.png 0.979927357262</div></pre></td></tr></table></figure>
<p>The screenshot:</p>
<p><img src="/image/onionstack/s5__________jlp2.png" width="100%" height="100%"></p>
<p>There are many clone sites in the dark web–for backup, or even for spying? <code>s5**********jlp2.onion</code> might be cloned and have maintained by others. Even in that case, the site is likely to be a honeypot.</p>
<p>Interestingly, I also found some posts like to induce to the site at <a href="https://www.reddit.com/r/onions/" target="_blank" rel="external">r/onions</a>. I believe these are done by researcher.</p>
<h1 id="Last-Words"><a href="#Last-Words" class="headerlink" title="Last Words"></a>Last Words</h1><p>We got a glimpse of deep in abyss. This is just an accidental case study. Needless to say, no insult intended.</p>
<p>My crawler and image processing scripts are available at <a href="https://github.com/ntddk/onionstack" target="_blank" rel="external">ntddk/onionstack</a>. Crawling of the dark web is accompanied by risk. After all, with ethical considerations, I’ve deleted screenshots I’d captured except for the honeypot.</p>
<p>If you interested in the dark web OSINT, <a href="http://www.automatingosint.com/blog/category/dark-web/" target="_blank" rel="external">Dark Web | Automating OSINT Blog</a> will be a good starting point.</p>
<p>Anyway, keep safety.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/12/02/how-i-found-the-honeypot-dark-web-osint-and-image-processing/" data-id="cjkr035sl000ypv7t2qfq8lqq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dark-web/">dark web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/honeypot/">honeypot</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-backward-program-slicing-with-idapython-and-triton" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/11/23/backward-program-slicing-with-idapython-and-triton/">Backward Program Slicing with IDAPython and Triton</a>
  

      </header>
    
    <time class="article-date" datetime="2017-11-22T16:30:00.000Z" itemprop="datePublished">11-23-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>As you know, IDAPython is quite useful. And <a href="https://github.com/JonathanSalwan/Triton" target="_blank" rel="external">Triton</a> concolic execution engine has python binding. Then… why not integrate them? I tried to stand on the shoulders of giants.</p>
<h1 id="Backward-Program-Slicing"><a href="#Backward-Program-Slicing" class="headerlink" title="Backward Program Slicing"></a>Backward Program Slicing</h1><p>Roughly speaking, program slicing is a method to extract subset of program which is relevant to given statement. Here is an excerpt from <a href="https://dl.acm.org/citation.cfm?id=802557" target="_blank" rel="external">M. Weiser. ICSE’81</a>:</p>
<blockquote>
<p>Starting from a subset of a program’s behavior, slicing reduces that program to a minimal form which still produces that behavior. The reduced program, called a “slice”, is an independent program guaranteed to faithfully represent the original program within the domain of the specified subset of behavior.</p>
</blockquote>
<p>Kudos to Jonathan Salwan, we can easily apply backward program slicing to binary analysis process with minor modification of <a href="https://github.com/JonathanSalwan/Triton/blob/master/src/examples/python/backward_slicing.py" target="_blank" rel="external"><code>backward_slicing.py</code></a> and <a href="https://github.com/JonathanSalwan/Triton/blob/master/src/examples/python/proving_opaque_predicates.py" target="_blank" rel="external"><code>proving_opaque_predicates.py</code></a>. I wrote a simple, tiny glue between Triton and IDA Pro:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding: utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> idaapi <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> *</div><div class="line"></div><div class="line">ctx = TritonContext()</div><div class="line">regs = &#123;</div><div class="line">        <span class="string">'eax'</span>: REG.X86.EAX,</div><div class="line">        <span class="string">'ebx'</span>: REG.X86.EBX,</div><div class="line">        <span class="string">'ecx'</span>: REG.X86.ECX,</div><div class="line">        <span class="string">'edx'</span>: REG.X86.EDX,</div><div class="line">        &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">symbolization_init</span><span class="params">()</span>:</span></div><div class="line">    ctx.convertRegisterToSymbolicVariable(ctx.registers.eax)</div><div class="line">    ctx.convertRegisterToSymbolicVariable(ctx.registers.ebx)</div><div class="line">    ctx.convertRegisterToSymbolicVariable(ctx.registers.ecx)</div><div class="line">    ctx.convertRegisterToSymbolicVariable(ctx.registers.edx)</div><div class="line">    <span class="keyword">return</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">opaque_predicate_detection</span><span class="params">(pc)</span>:</span></div><div class="line">    ctx.setArchitecture(ARCH.X86)</div><div class="line">    ctx.setAstRepresentationMode(AST_REPRESENTATION.PYTHON)</div><div class="line">    symbolization_init()</div><div class="line">    ast_ctx = ctx.getAstContext()</div><div class="line"></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        instruction = Instruction()</div><div class="line">        instruction.setAddress(pc)</div><div class="line">        opcode = GetManyBytes(pc, ItemSize(pc)) <span class="comment"># Disassemble with IDA Pro</span></div><div class="line">        instruction.setOpcode(opcode)</div><div class="line"></div><div class="line">        ctx.processing(instruction) <span class="comment"># Emulate instruction without Pintool</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> se <span class="keyword">in</span> instruction.getSymbolicExpressions():</div><div class="line">            se.setComment(str(instruction))</div><div class="line"></div><div class="line">        <span class="keyword">if</span> str(instruction.getDisassembly()).split()[<span class="number">0</span>] == <span class="string">'cmp'</span>: <span class="comment"># if instruction.isCompare():</span></div><div class="line">            reg = str(instruction.getOperands()[<span class="number">0</span>]).split(<span class="string">':'</span>)[<span class="number">0</span>] <span class="comment"># Get first operand</span></div><div class="line">            <span class="keyword">if</span> reg <span class="keyword">in</span> regs:</div><div class="line">                Expr = ctx.getSymbolicRegisters()[regs[reg]]</div><div class="line">                slicing = ctx.sliceExpressions(Expr)</div><div class="line">                <span class="keyword">for</span> k, v <span class="keyword">in</span> sorted(slicing.items()):</div><div class="line">                    <span class="keyword">print</span> v.getComment()</div><div class="line">                <span class="keyword">print</span> instruction</div><div class="line">        <span class="keyword">elif</span> instruction.isBranch():</div><div class="line">            <span class="keyword">print</span> instruction</div><div class="line">            <span class="keyword">if</span> instruction.isConditionTaken():</div><div class="line">                <span class="keyword">print</span> <span class="string">'branch will taken'</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">print</span> <span class="string">'branch will not taken'</span></div><div class="line"></div><div class="line">            <span class="keyword">break</span></div><div class="line"></div><div class="line">        pc = NextHead(pc)</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'-'</span> * <span class="number">50</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    ea = ScreenEA() <span class="comment"># Get address corresponding to cursor</span></div><div class="line">    opaque_predicate_detection(ea) </div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    view = main()</div></pre></td></tr></table></figure>
<h1 id="Showcase"><a href="#Showcase" class="headerlink" title="Showcase"></a>Showcase</h1><p>The snippet extracts subset of program which is relevant to branch condition. We can run this from <code>File -&gt; Script file</code> in IDA Pro menu.</p>
<h2 id="Conditional-Branch"><a href="#Conditional-Branch" class="headerlink" title="Conditional Branch"></a>Conditional Branch</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">.text:004074DD     loc_4074DD:</div><div class="line">.text:004074DD 040 mov     dword ptr [edi+18h], 0Ah</div><div class="line">.text:004074E4 040 mov     dword ptr [edi+14h], 0</div><div class="line">.text:004074EB 040 mov     word ptr [edi+8], 8235h</div><div class="line">.text:004074F1 040 mov     dword ptr [edi+0Ch], 3E8h</div><div class="line">.text:004074F8 040 mov     dword ptr [edi+10h], 0BB8h</div><div class="line">.text:004074FF 040 sub     esp, 4</div><div class="line">.text:00407502 044 mov     [esp+40h+Memory], 0B8h ; Size        ; cursor</div><div class="line">.text:00407509 044 call    ??2@YAPAXI@Z    ; operator new(uint)</div><div class="line">.text:0040750E 044 add     esp, 4</div><div class="line">.text:00407511 040 mov     [esi+18h], eax</div><div class="line">.text:00407514 040 mov     eax, dword_591EE4</div><div class="line">.text:00407519 040 mov     ecx, dword_591EE0</div><div class="line">.text:0040751F 040 imul    eax, eax</div><div class="line">.text:00407522 040 imul    edx, eax, 7</div><div class="line">.text:00407525 040 dec     edx</div><div class="line">.text:00407526 040 mov     eax, ecx</div><div class="line">.text:00407528 040 imul    eax, eax</div><div class="line">.text:0040752B 040 cmp     edx, eax</div><div class="line">.text:0040752D 040 jz      short loc_407538</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0x407514: mov eax, dword ptr [0x591ee4]</div><div class="line">0x40751f: imul eax, eax</div><div class="line">0x407522: imul edx, eax, 7</div><div class="line">0x407525: dec edx</div><div class="line">0x40752b: cmp edx, eax</div><div class="line">0x40752d: je 0x407538</div><div class="line">branch will not taken</div></pre></td></tr></table></figure>
<h2 id="Unconditional-Branch"><a href="#Unconditional-Branch" class="headerlink" title="Unconditional Branch"></a>Unconditional Branch</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">.text:004078C3     loc_4078C3:</div><div class="line">.text:004078C3 000 mov     esp, edi           ; cursor</div><div class="line">.text:004078C5 000 mov     eax, dword_591EAC</div><div class="line">.text:004078CA 000 lea     ecx, [eax+4]</div><div class="line">.text:004078CD 000 mov     edx, eax</div><div class="line">.text:004078CF 000 sar     edx, cl</div><div class="line">.text:004078D1 000 lea     eax, [eax+edx*2]</div><div class="line">.text:004078D4 000 mov     dword_591EAC, eax</div><div class="line">.text:004078D9 000 jmp     short loc_4</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0x4078d9: jmp 0x40789a</div><div class="line">branch will taken</div></pre></td></tr></table></figure>
<p>Looks nice.</p>
<h1 id="Last-Words"><a href="#Last-Words" class="headerlink" title="Last Words"></a>Last Words</h1><p>Triton’s emulation iteration is compatible to IDAPython manner. Therefore, The combination of IDA Pro and Triton is pretty good. </p>
<p>Cheers,</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/11/23/backward-program-slicing-with-idapython-and-triton/" data-id="cjkr035sb000apv7tlk70h3em" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-a-supplemental-guide-to-migrate-pySide-code-to-pyqt5-within-your-idapython-script" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/11/08/a-supplemental-guide-to-migrate-pySide-code-to-pyqt5-within-your-idapython-script/">A Supplemental Guide to Migrate PySide Code to PyQt5 Within Your IDAPython Script</a>
  

      </header>
    
    <time class="article-date" datetime="2017-11-08T12:00:00.000Z" itemprop="datePublished">11-08-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>IDAPython is a powerful feature of IDA Pro, and there are many open-sourced IDAPython projects. However, we cannot use every GUI-based IDAPython script due to some Qt-related breaking changes between IDA Pro 6.8 and 6.9 or later. The main problem is about migrating no longer supported PySide code to PyQt5.</p>
<p>Recently I ported PySide code within <a href="https://github.com/RobinDavid/idasec" target="_blank" rel="external">idasec</a>–one of the most sophisticated deobfuscation frameworks, which tackles opaque predicates and call stack tampering in terms of infeasibility questions, by utilizing Backward-Bounded Dynamic Symbolic Execution proposed in the remarkably well written paper <a href="https://www.ieee-security.org/TC/SP2017/papers/220.pdf" target="_blank" rel="external">S. Bardin et al. IEEE S&amp;P’17</a>–to PyQt5.</p>
<p>That’s why I decided to write this blog post for a note to self and for someone trying to do similar thing.</p>
<h1 id="Related-Work"><a href="#Related-Work" class="headerlink" title="Related Work"></a>Related Work</h1><p>There are 2 guidances to migrate PySide code to PyQt5:</p>
<ul>
<li><a href="http://www.hexblog.com/?p=975" target="_blank" rel="external">IDAPython: migrating PySide code to PyQt5 – Hex Blog</a></li>
<li><a href="https://github.com/tmr232/Cute" target="_blank" rel="external">idacute</a></li>
</ul>
<p>Please read them before. I only give supplemental information in addition to predecessors.</p>
<h1 id="How-to-Migrate"><a href="#How-to-Migrate" class="headerlink" title="How to Migrate"></a>How to Migrate</h1><p>Now let’s get started.</p>
<h2 id="Change-QtGui-methods-to-QtWidgets"><a href="#Change-QtGui-methods-to-QtWidgets" class="headerlink" title="Change QtGui methods to QtWidgets"></a>Change <code>QtGui</code> methods to <code>QtWidgets</code></h2><p>Most methods in <code>QtGui</code> migrated to <code>QtWidgets</code>. Therefore,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> PySide <span class="keyword">import</span> QtGui, QtCore</div></pre></td></tr></table></figure>
<p>becomes:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtGui, QtWidgets</div></pre></td></tr></table></figure>
<p>As an example, <code>QTextEdit</code> described in Hex Blog. In additions, the methods to be rewritten are as follows:</p>
<ul>
<li><code>QtWidgets.QLayout</code></li>
<li><code>QtWidgets.QVBoxLayout</code></li>
<li><code>QtWidgets.QHBoxLayout</code></li>
<li><code>QtWidgets.QWidget</code></li>
<li><code>QtWidgets.QTableWidget</code></li>
<li><code>QtWidgets.QListWidget</code></li>
<li><code>QtWidgets.QTabWidget</code></li>
<li><code>QtWidgets.QDockWidget</code></li>
<li><code>QtWidgets.QTreeWidget</code></li>
<li><code>QtWidgets.QTreeWidgetItem</code></li>
<li><code>QtWidgets.QPushButton</code></li>
<li><code>QtWidgets.QRadioButton</code></li>
<li><code>QtWidgets.QToolButton</code></li>
<li><code>QtWidgets.QButtonGroup</code></li>
<li><code>QtWidgets.QGroupBox</code></li>
<li><code>QtWidgets.QSpinBox</code></li>
<li><code>QtWidgets.QCheckBox</code></li>
<li><code>QtWidgets.QComboBox</code></li>
<li><code>QtWidgets.QTextEdit</code></li>
<li><code>QtWidgets.QLineEdit</code></li>
<li><code>QtWidgets.QApplication</code></li>
<li><code>QtWidgets.QLabel</code></li>
<li><code>QtWidgets.QSizePolicy</code></li>
<li><code>QtWidgets.QMenu</code></li>
<li><code>QtWidgets.QFrame</code></li>
<li><code>QtWidgets.QProgressBar</code></li>
<li><code>QtWidgets.QStyle</code></li>
<li><code>QtWidgets.QSpacerItem</code></li>
<li><code>QtWidgets.QScrollArea</code></li>
<li><code>QtWidgets.QSplitter</code></li>
<li>There might be more…</li>
</ul>
<p>My experience says that other than the following 3 methods may be rewritten:</p>
<ul>
<li><code>QtGui.QPixmap</code></li>
<li><code>QtGui.QIcon</code></li>
<li><code>QtGui.QFont</code></li>
</ul>
<p>idacute may overwrite all of <code>QtGui</code> methods, so I think there still needs to be manual works.</p>
<h2 id="Overwrite-fromUtf8"><a href="#Overwrite-fromUtf8" class="headerlink" title="Overwrite _fromUtf8"></a>Overwrite <code>_fromUtf8</code></h2><p>We also need to overwrite <code>_fromUtf8</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    _fromUtf8 = QtCore.QString.fromUtf8</div><div class="line"><span class="keyword">except</span> AttributeError:</div><div class="line">　　　　_fromUtf8 = <span class="keyword">lambda</span> s: s</div></pre></td></tr></table></figure>
<h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><p>These issues are described by predecessors:</p>
<ul>
<li>Handling SIGNAL</li>
<li>Change <code>FormToPySideWidget</code> to <code>FormToPyQtWidget</code></li>
<li>Change <code>setResizeMode</code> to <code>setSectionResizeMode</code></li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>This time, I was able to run idasec on IDA Pro 7.0 with <a href="https://github.com/RobinDavid/idasec/pull/2" target="_blank" rel="external">some bug fixes and dirty patches</a> – like this cool video:</p>
<center><iframe width="560" height="315" src="https://www.youtube.com/embed/Z14ab_rzjfA" frameborder="0" allowfullscreen></iframe></center>

<p>If you are an IDA Pro 7.0 user, note that other backward-compatibility issue described in <a href="https://www.hex-rays.com/products/ida/7.0/docs/idapython_backward_compat_695.shtml" target="_blank" rel="external">IDA: IDAPython backward-compatibility with 6.95 APIs</a> will occur.</p>
<p>Enjoy!</p>
<p>HAI DOMO VIRTUAL YOUTUBER KIZUNA AI DESU. I’m still working on my English.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/11/08/a-supplemental-guide-to-migrate-pySide-code-to-pyqt5-within-your-idapython-script/" data-id="cjkr035s70005pv7txw1tpg4q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reversing/">reversing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-a-prayer-for-the-dying-antivirus" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/09/10/a-prayer-for-the-dying-antivirus/">死にゆくアンチウイルスへの祈り</a>
  

      </header>
    
    <time class="article-date" datetime="2017-09-10T08:15:00.000Z" itemprop="datePublished">09-10-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　<a href="https://connpass.com/event/62844/" target="_blank" rel="external">Security meets Machine Learning</a>という勉強会にて，上記のタイトルで発表した．資料はこちら：</p>
<script async class="speakerdeck-embed" data-id="5c63dce1d2494dfc9f068fe1c58eab41" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>

<p>　謎の力が働いて会社からの発表になっておりますが，機械学習の研究をしているわけではありません．既存研究の再現実装を試みているとこれ中国語の部屋じゃんという気持ちになる．<br>　ともあれ，これまで各種資料はただSpeakerDeckに載せるだけだったのを今後はブログから一元的に参照できるようにします．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/09/10/a-prayer-for-the-dying-antivirus/" data-id="cjkr035s10001pv7tu4s38jlc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/machine-learning/">machine learning</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-z3py-link-collection" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/08/24/z3py-link-collection/">z3pyリンク集</a>
  

      </header>
    
    <time class="article-date" datetime="2017-08-24T14:59:59.000Z" itemprop="datePublished">08-24-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　なにもかも忘れかけている．</p>
<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>　z3pyはSMTソルバ<a href="https://github.com/Z3Prover/z3" target="_blank" rel="external">Z3</a>のPythonバインディング．たとえば</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">    <span class="keyword">if</span>(x * <span class="number">2</span> + <span class="number">3</span> * y == <span class="number">4</span></div><div class="line">        &amp;&amp; x * <span class="number">3</span> + y == <span class="number">-1</span>)&#123;</div><div class="line">        <span class="built_in">puts</span>(<span class="string">"congrats!"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>のようなプログラムに対して</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</div><div class="line"></div><div class="line">x = Int(<span class="string">'x'</span>)</div><div class="line">y = Int(<span class="string">'y'</span>)</div><div class="line"></div><div class="line">s = Solver()</div><div class="line">s.add(x * <span class="number">2</span> + <span class="number">3</span> * y == <span class="number">4</span>)</div><div class="line">s.add(x * <span class="number">3</span> + y == <span class="number">-1</span>)</div><div class="line"></div><div class="line">print(s.check())</div><div class="line">print(s.model())</div></pre></td></tr></table></figure>
<p>としてやれば期待される入力値<code>[x = -1, y = 2]</code>を算出できる．これだけではだからなに？ という感じだが．シンボリック実行は各命令とメモリの状態からこの割当を自動生成するものだと思えばよい．これが<a href="https://github.com/angr/angr" target="_blank" rel="external">angr</a>やら<a href="https://github.com/JonathanSalwan/Triton" target="_blank" rel="external">Triton</a>やら<a href="https://github.com/cea-sec/miasm" target="_blank" rel="external">miasm</a>やら<a href="https://github.com/trailofbits/manticore" target="_blank" rel="external">manticore</a>やら，その他いまどきのバイナリ解析ツール群の基盤となっているというわけです．</p>
<h1 id="参考になったサイト"><a href="#参考になったサイト" class="headerlink" title="参考になったサイト"></a>参考になったサイト</h1><p>　で，メモっとかないと忘れるので．SAT/SMTソルバのしくみやシンボリック実行全般まで広げると膨大になるということで，z3pyに限っています．前者については<a href="http://www-erato.ist.hokudai.ac.jp/docs/seminar/nabeshima.pdf" target="_blank" rel="external">高速SATソルバーの原理 - 基盤(S)離散構造処理系プロジェクト[PDF]</a>や<a href="https://www.slideshare.net/sakai/satsmt" target="_blank" rel="external">SAT/SMTソルバの仕組み - SlideShare</a>を読むとよいでしょう．いまどきのSAT/SMTソルバにはVSIDSやらLubyリスタートやらいろいろな工夫が盛り込まれているが，とりあえずユーザとしてはDPLLとCDCLさえ抑えておけば問題ないはず．後者，シンボリック実行全般に関するおすすめの文献は秘密．Pythonバインディング以外の記事，angrやTritonなどサードパーティのツール群に関する記事も省いてある．</p>
<table>
<thead>
<tr>
<th>ウェブサイト</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://wiki.mma.club.uec.ac.jp/CTF/Toolkit/z3py" target="_blank" rel="external">CTF/Toolkit/z3py - 電気通信大学MMA</a></td>
<td>日本語で書かれた入門資料．これには書かれてないが<code>BitVecSort</code>も便利．</td>
</tr>
<tr>
<td><a href="https://doar-e.github.io/presentations/securityday2015/SecDay-Lille-2015-Axel-0vercl0k-Souchet.html#/" target="_blank" rel="external">Theorem prover, symbolic execution and practical reverse-engineering</a></td>
<td>z3pyのチュートリアル．まずはこの通りに手を動かす．</td>
</tr>
<tr>
<td><a href="http://doar-e.github.io/blog/2013/09/16/breaking-kryptonites-obfuscation-with-symbolic-execution/" target="_blank" rel="external">Breaking Kryptonite’s Obfuscation: A Static Analysis Approach Relying on Symbolic Execution</a></td>
<td>シンボリック実行の最小構成の実装．</td>
</tr>
<tr>
<td><a href="https://github.com/0vercl0k/z3-playground/" target="_blank" rel="external">0vercl0k/z3-playground</a></td>
<td>上2つの資料で参照されているソースコード群．</td>
</tr>
<tr>
<td><a href="https://anee.me/solving-a-simple-crackme-using-z3-68c55af7f7b1" target="_blank" rel="external">Solving a simple crackme using Z3 – Aneesh Dogra’s Blog</a></td>
<td>簡単なcrackmeのwriteup.</td>
</tr>
<tr>
<td><a href="https://rolandsako.wordpress.com/2016/02/17/playing-with-z3-hacking-the-serial-check/" target="_blank" rel="external">Playing with Z3, hacking the serial check. – rosako’s blog</a></td>
<td>簡単なcrackmeのwriteup.</td>
</tr>
<tr>
<td><a href="https://blog.lse.epita.fr/articles/24-using-sat-and-smt-to-defeat-simple-hashing-algorit.html" target="_blank" rel="external">Using SAT and SMT to defeat simple hashing algorithms - LSE Blog</a></td>
<td>オレオレハッシュ関数の解析．</td>
</tr>
<tr>
<td><a href="https://0xec.blogspot.jp/2016/04/reversing-petya-ransomware-with.html" target="_blank" rel="external">Reversing the petya ransomware with constraint solvers</a></td>
<td>ランサムウェアPetyaのSalsa実装の不備を突くdecryptor.</td>
</tr>
<tr>
<td><a href="https://github.com/thomasjball/PyExZ3" target="_blank" rel="external">thomasjball/PyExZ3</a></td>
<td>シンボリック実行の実装例．z3公式からリンクが貼られている．<code>symbolic/</code>以下，<code>z3_wrap.py</code>, <code>loader.py</code>が参考になる．</td>
</tr>
<tr>
<td><a href="https://yurichev.com/writings/SAT_SMT_draft-EN.pdf" target="_blank" rel="external">Quick introduction into SAT/SMT solvers and symbolic execution (DRAFT) [PDF]</a></td>
<td>いろいろリンク貼ったけどこれだけ読めばいい．SMTソルバの紹介．数独の解き方．マインスイーパの自動化．デコンパイラ．難読化解除．シンボリック実行．ハッシュ関数の解析．全部載っている．Dennis Yurichev氏，<a href="https://beginners.re/" target="_blank" rel="external">Reverse Engineering for Beginners</a>も書いていて，慈善事業家か？</td>
</tr>
</tbody>
</table>
<p>　はてなブックマークを使っていればよかったのではという気がしてきた．</p>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>　z3py便利最高ですね．みなさんは便利最高ですか？<br>　これで次のようなCTFの問題を解くことができます：</p>
<table>
<thead>
<tr>
<th>問題</th>
<th>大会</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unbreakable Enterprise Product Activation</td>
<td>Google CTF 2016</td>
</tr>
<tr>
<td>Ropsynth</td>
<td>SECCON 2016 Online CTF</td>
</tr>
<tr>
<td>baby-re</td>
<td>DEF CON CTF Qualifier 2016</td>
</tr>
<tr>
<td>amandhj</td>
<td>DEF CON CTF Qualifier 2016</td>
</tr>
<tr>
<td>Pepperidge Farm</td>
<td>DEF CON CTF Qualifier 2017</td>
</tr>
</tbody>
</table>
<p>　まあ明らかにangr使ったほうが楽．とりあえずいくつかやってみただけで，ほかにもたくさんあると思う．<br>　Bareflank Hypervisorを読むのはいつになるかわかりません．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/08/24/z3py-link-collection/" data-id="cjkr035t1001ypv7t3cg88ftm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/optimization/">optimization</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-thin-hypervisor-2017" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2017/03/04/thin-hypervisor-2017/">シン・ハイパーバイザ2017 (前編)</a>
  

      </header>
    
    <time class="article-date" datetime="2017-03-04T09:45:00.000Z" itemprop="datePublished">03-04-2017</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　いまさらながら，<a href="http://www.adventar.org/calendars/1401" target="_blank" rel="external">情報セキュリティ系論文紹介 Advent Calendar 2016</a>あるいは<a href="http://qiita.com/advent-calendar/2016/bitvisor" target="_blank" rel="external">BitVisor Advent Calendar 2016</a>に投稿されるはずだった文章を供養する．</p>
<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>　本稿では，シン，すなわち薄いハイパーバイザ (thin hypervisor) の動向を紹介する．<br>　薄いハイパーバイザとは，小規模であることを志向したハイパーバイザだ——ということにしておこう．小規模というのは，一部のイベントのみトラップするということだ．メリットとしては，実装・学習コストやオーバーヘッド，TCB (trusted computing base) を削減できる点が挙げられる．<br>　用語の初出はBitVisorの論文<a href="https://www.os.ecc.u-tokyo.ac.jp/papers/vee2009-shina.pdf" target="_blank" rel="external">[T. Shinagawa, et al. VEE’09]</a>だが，多くはWindows向けルートキットとして開発されたBlue Pillという手法<a href="http://www.blackhat.com/presentations/bh-usa-06/BH-US-06-Rutkowska.pdf" target="_blank" rel="external">[J. Rutkowska. Black Hat USA’06]</a>の流れを汲んでいる．そのため，ブート時からゲストを掌握するのではなく，のちほど——あえてchain of trustの構築を放棄して——カーネルドライバとしてロードされるものが一般的である．そのほか，単一のゲストのみ対象とする，セキュリティを意識しているといった傾向が見られる．<br>　前編となる今回は，3種類の薄いハイパーバイザを見ていく．</p>
<h1 id="ksm"><a href="#ksm" class="headerlink" title="ksm"></a>ksm</h1><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>リポジトリ</td>
<td><a href="https://github.com/asamy/ksm" target="_blank" rel="external">https://github.com/asamy/ksm</a></td>
</tr>
<tr>
<td>形態</td>
<td>カーネルドライバ</td>
</tr>
<tr>
<td>仮想化支援機能</td>
<td>Intel VT-x with EPT</td>
</tr>
<tr>
<td>サポートしている環境</td>
<td>Windows 7/8/8.1/10, Linux</td>
</tr>
<tr>
<td>言語</td>
<td>C, アセンブリ言語</td>
</tr>
<tr>
<td>ライセンス</td>
<td>GNU GPL v2</td>
</tr>
</tbody>
</table>
<p>　ksmは高速，拡張可能かつ小規模であることを旨としているハイパーバイザで，アンチウイルスソフトウェアやサンドボックスへの利用を意識して開発されている．機能は以下の通り：</p>
<ul>
<li>IDT Shadowing</li>
<li>EPT violation #VE (Broadwell以降)</li>
<li>EPTP switching VMFUNC (Haswell以降，もしサポートされていなければVMCALLで代替)</li>
<li>Builtin Userspace physical memory sandboxer (ビルドオプション)</li>
<li>Builtin Introspection engine (ビルドオプション)</li>
<li>APIC virtualization (実験的機能)</li>
<li>VMX Nesting (実験的機能)</li>
</ul>
<p>　主なソースコードは以下の通り：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/main_nt.c" target="_blank" rel="external"><code>main_nt.c</code></a>, <a href="https://github.com/asamy/ksm/blob/master/main_linux.c" target="_blank" rel="external"><code>main_linux.c</code></a></td>
<td>カーネルドライバのエントリポイント，<code>ioctl</code>ディスパッチ</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/ksm.c" target="_blank" rel="external"><code>ksm.c</code></a></td>
<td>ハイパーバイザ全体の初期化</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/vmx.S" target="_blank" rel="external"><code>vmx.S</code></a>, <a href="https://github.com/asamy/ksm/blob/master/vmx.asm" target="_blank" rel="external"><code>vmx.asm</code></a></td>
<td>IDTやEPT violationのトラップ，ゲストのレジスタ退避</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/vcpu.c" target="_blank" rel="external"><code>vcpu.c</code></a></td>
<td>VMCSの読み書き</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/exit.c" target="_blank" rel="external"><code>exit.c</code></a></td>
<td>VMExitのハンドラ</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/um/um.c" target="_blank" rel="external"><code>um/um.c</code></a></td>
<td>ユーザーランドのエージェント</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/sandbox.c" target="_blank" rel="external"><code>sandbox.c</code></a></td>
<td>サンドボックス機能</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/introspect.c" target="_blank" rel="external"><code>introspect.c</code></a></td>
<td>イントロスペクション機能</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/epage.c" target="_blank" rel="external"><code>epage.c</code></a></td>
<td>EPTフック機能</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/mm.c" target="_blank" rel="external"><code>mm.c</code></a></td>
<td>メモリ管理</td>
</tr>
<tr>
<td><a href="https://github.com/asamy/ksm/blob/master/hotplug.c" target="_blank" rel="external"><code>hotplug.c</code></a></td>
<td>CPUホットプラグに関する処理</td>
</tr>
</tbody>
</table>
<p>　カーネルドライバをロードし，ユーザーランドのエージェントから<code>ioctl</code>を発行，サンドボックス機能またはイントロスペクション機能，EPT機能を呼び出すという流れになっている．詳細は<a href="https://github.com/asamy/ksm/blob/master/Documentation/SPEC.rst" target="_blank" rel="external"><code>Documentation/SPEC.rst</code></a>を参照のこと．</p>
<h1 id="SimpleVisor"><a href="#SimpleVisor" class="headerlink" title="SimpleVisor"></a>SimpleVisor</h1><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>リポジトリ</td>
<td><a href="https://github.com/ionescu007/SimpleVisor" target="_blank" rel="external">https://github.com/ionescu007/SimpleVisor</a></td>
</tr>
<tr>
<td>形態</td>
<td>カーネルドライバ</td>
</tr>
<tr>
<td>仮想化支援機能</td>
<td>Intel VT-x with EPT, AMD-V</td>
</tr>
<tr>
<td>サポートしている環境</td>
<td>Windows 8/8.1/10, UEFI</td>
</tr>
<tr>
<td>言語</td>
<td>C, アセンブリ言語</td>
</tr>
<tr>
<td>ライセンス</td>
<td>2 clause BSD</td>
</tr>
</tbody>
</table>
<p>　SimpleVisorは，名前の通り極力シンプルであることをめざしたハイパーバイザだ．全体で1700行程度．開発者はWindows Internalsの著者のひとりで，<a href="https://github.com/ionescu007/SimpleVisor/blob/master/README.md" target="_blank" rel="external"><code>README.md</code></a>にはこう書かれている：</p>
<blockquote>
<p>Have you always been curious on how to build a hypervisor? Has Intel’s documentation (the many hundreds of pages) gotten you down? Have the samples you’ve found online just made things more confusing, or required weeks of reading through dozens of thousands of lines and code? If so, SimpleVisor might be the project for you.</p>
</blockquote>
<p>　そういうわけで，SimpleVisorはIntel SDM (とくに，ハイパーバイザまわりは<a href="http://www.intel.co.jp/content/www/jp/ja/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3c-part-3-manual.html" target="_blank" rel="external">Vol. 3C</a>) の解読にうんざりした人向けだ．学習にはもってこい．<code>CPUID</code>, <code>INVD</code>, <code>VMX</code>, <code>XSETBV</code>のみトラップするようになっており，ネストには対応していない．しかし，XenやBochsでさえ追いついていない最新の仮想化支援機能にいちはやく追随しようとしている．<br>　主なソースコードは以下の通り：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/nt/shvos.c" target="_blank" rel="external"><code>nt/shvos.c</code></a></td>
<td>カーネルドライバのエントリポイント</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shv.c" target="_blank" rel="external"><code>shv.c</code></a></td>
<td>VMExit/VMEntryのコールバック関数の登録</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shvvp.c" target="_blank" rel="external"><code>shvvp.c</code></a></td>
<td>コールバック関数の実体，仮想CPUの初期化</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shvvmx.c" target="_blank" rel="external"><code>shvvmx.c</code></a></td>
<td>VMCSの初期化</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shvvmxhv.c" target="_blank" rel="external"><code>shvvmxhv.c</code></a></td>
<td>VMExitのハンドラ</td>
</tr>
<tr>
<td><a href="https://github.com/ionescu007/SimpleVisor/blob/master/shvutil.c" target="_blank" rel="external"><code>shvutil.c</code></a></td>
<td>GDTの変換</td>
</tr>
</tbody>
</table>
<p>　シンプル．</p>
<h1 id="HyperPlatform"><a href="#HyperPlatform" class="headerlink" title="HyperPlatform"></a>HyperPlatform</h1><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>リポジトリ</td>
<td><a href="https://github.com/tandasat/HyperPlatform" target="_blank" rel="external">https://github.com/tandasat/HyperPlatform</a></td>
</tr>
<tr>
<td>形態</td>
<td>カーネルドライバ</td>
</tr>
<tr>
<td>仮想化支援機能</td>
<td>Intel VT-x with EPT</td>
</tr>
<tr>
<td>サポートしている環境</td>
<td>Windows 7/8.1/10</td>
</tr>
<tr>
<td>言語</td>
<td>C++, アセンブリ言語</td>
</tr>
<tr>
<td>ライセンス</td>
<td>MIT</td>
</tr>
</tbody>
</table>
<p>　HyperPlatformは，カーネルランドで動くコード，すなわちWindows向けルートキットやWindowsカーネル自体の解析を目的として開発されているハイパーバイザ．物理メモリと仮想メモリへのアクセス，関数呼び出し，命令単位のコード実行を監視できるようになっている<a href="https://recon.cx/2016/resources/slides/RECON-0xA-HyperPlatform-Satoshi.pdf" target="_blank" rel="external">[S. Tanda. REcon’16]</a>．<br>　主なソースコードは以下の通り：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/driver.cpp" target="_blank" rel="external"><code>driver.cpp</code></a></td>
<td>カーネルドライバのエントリポイント，各種コールバック関数の登録</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/log.cpp" target="_blank" rel="external"><code>log.cpp</code></a></td>
<td>ログ出力</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/global_object.cpp" target="_blank" rel="external"><code>global_object.cpp</code></a></td>
<td>グローバル変数の初期化</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/performance.cpp" target="_blank" rel="external"><code>performance.cpp</code></a></td>
<td>パフォーマンス計測</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/util.cpp" target="_blank" rel="external"><code>util.cpp</code></a></td>
<td><code>PTE_BASE</code>の取得，メモリアドレス変換，VMCALLのラッパなど</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/power_callback.cpp" target="_blank" rel="external"><code>power_callback.cpp</code></a></td>
<td>電源状態のコールバック関数</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/hotplug_callback.cpp" target="_blank" rel="external"><code>hotplug_callback.cpp</code></a></td>
<td>CPUホットプラグのコールバック関数</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/vm.cpp" target="_blank" rel="external"><code>vm.cpp</code></a></td>
<td>仮想CPUの初期化，VMCSの読み書き</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/ept.cpp" target="_blank" rel="external"><code>ept.cpp</code></a></td>
<td>EPTの構成</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/vmm.cpp" target="_blank" rel="external"><code>vmm.cpp</code></a></td>
<td>命令のトラップ，VMExitのハンドラ</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/Arch/x64/x64.asm" target="_blank" rel="external"><code>Arch/x64/x64.asm</code></a>, <a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/Arch/x86/x86.asm" target="_blank" rel="external"><code>Arch/x86/x86.asm</code></a></td>
<td>VMX命令呼び出しにともなう命令列</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/HyperPlatform/blob/master/HyperPlatform/kernel_stl.cpp" target="_blank" rel="external"><code>kernel_stl.cpp</code></a></td>
<td>ntoskrnl経由でカーネルドライバからSTLを利用する</td>
</tr>
</tbody>
</table>
<p>　エントリポイントから手続き的に書き下されていて，わかりやすい．ハイパーバイザとしての機能もさることながら，STLを強引に呼び出すハックがかっこいい．<br>　この拡張例には以下がある：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/tandasat/MemoryMon" target="_blank" rel="external">MemoryMon</a></td>
<td>カーネルランドへのコード挿入を検知する</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/EopMon" target="_blank" rel="external">EopMon</a></td>
<td>マルウェアによる特権昇格攻撃を検知する</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/DdiMon" target="_blank" rel="external">DdiMon</a></td>
<td>EPTを用いたAPIフック</td>
</tr>
<tr>
<td><a href="https://github.com/tandasat/GuardMon" target="_blank" rel="external">GuardMon</a></td>
<td>PatchGuardの挙動解析</td>
</tr>
</tbody>
</table>
<p>　いずれもカーネルドライバのエントリポイントで追加機能を初期化するしくみ．<br>　やや温め納豆は遠くなりにけり．</p>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>　いずれもSandy Bridge以降のいまどきの環境であれば動作する．<br>　卒業研究ではQEMUをベースとしたマルウェア解析環境を開発していたのだけど，やはり速度面に難があるし，このあたりの技術を再検討しないとなー．<br>　なお，今回取り上げなかったハイパーバイザには以下のようなものがある：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/ainfosec/MoRE" target="_blank" rel="external">MoRE</a></td>
<td>ルートキット文脈のハイパーバイザ．やや古い</td>
</tr>
<tr>
<td><a href="https://github.com/DarthTon/HyperBone" target="_blank" rel="external">HyperBone</a></td>
<td>HyperPlatformと似た機能をもつ．やや古い</td>
</tr>
<tr>
<td><a href="https://github.com/linux-noah/noah" target="_blank" rel="external">Noah</a></td>
<td>未踏のアレ．OS X上でLinuxバイナリを動かす．MacBook持ってないので試せないのだわ</td>
</tr>
<tr>
<td><a href="https://github.com/Bareflank/hypervisor" target="_blank" rel="external">Bareflank</a></td>
<td>type 1, 2, ドライバいずれの形態のVMMもサポートしたライブラリ．しかもC++で書ける</td>
</tr>
</tbody>
</table>
<p>　なかでもBareflankがヤバいので後編ではこれを読んでいきます．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2017/03/04/thin-hypervisor-2017/" data-id="cjkr035sx001rpv7tvr5ruk8d" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-machine-introspection/">virtual machine introspection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-yakiniku-optimization" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/12/04/yakiniku-optimization/">焼肉最適化問題</a>
  

      </header>
    
    <time class="article-date" datetime="2016-12-04T14:59:59.000Z" itemprop="datePublished">12-04-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　本稿は<a href="http://www.adventar.org/calendars/1413" target="_blank" rel="external">SFC-RG Advent Calendar 2016</a>の4日目である．</p>
<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>　あなたは研究の中間発表を終えて，今晩何を食べようか考えている．たしかに準備不足ではあったけれど，研究の前提をいまいち解さないファカルティの高飛車な質問にはうんざりしたし，今日くらいはパーッと気分転換したいものだ．そういうわけで，あなたは⊿館を飛び出して焼肉 ざんまい 湘南台店に行くことにした．</p>
<h1 id="組合せ最適化"><a href="#組合せ最適化" class="headerlink" title="組合せ最適化"></a>組合せ最適化</h1><p>　さて，着席し，メニューを開いたあなたはしばし考える．限られた予算，限られた時間，限られた胃袋の容量——いったい何を頼めば最も<strong>満足</strong>できるだろうか？<br>　そんなとき，組合せ最適化が役に立つんです．騙されたと思って，メニューを必死に転記してみよう：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np, pandas <span class="keyword">as</span> pd</div><div class="line"></div><div class="line">menu = [<span class="string">'カルビ'</span>, <span class="string">'和牛カルビ'</span>, <span class="string">'和牛中落ちカルビ'</span>, <span class="string">'ハラミ'</span>, <span class="string">'厚切りロース'</span>, <span class="string">'ネギ牛タン塩'</span>, <span class="string">'牛タン塩'</span>, </div><div class="line">        <span class="string">'イベリコ豚'</span>, <span class="string">'カシラ'</span>, <span class="string">'豚トロ'</span>, <span class="string">'ネギ豚タン塩'</span>, <span class="string">'豚タン塩'</span>, <span class="string">'厚切りベーコン'</span>, <span class="string">'ウインナー'</span>, <span class="string">'チョリソ'</span>, </div><div class="line">        <span class="string">'ホルモン'</span>, <span class="string">'シロコロホルモン'</span>, <span class="string">'レバー'</span>, <span class="string">'白レバー'</span>, <span class="string">'ハツ'</span>, <span class="string">'ミノ'</span>, </div><div class="line">        <span class="string">'お得!! 三種盛り'</span>, <span class="string">'本日の塩三種盛り'</span>, <span class="string">'本日の味噌三種盛り'</span>]</div><div class="line">price = [<span class="number">720</span>, <span class="number">950</span>, <span class="number">850</span>, <span class="number">720</span>, <span class="number">690</span>, <span class="number">950</span>, <span class="number">850</span>, </div><div class="line">        <span class="number">600</span>, <span class="number">550</span>, <span class="number">580</span>, <span class="number">680</span>, <span class="number">580</span>, <span class="number">500</span>, <span class="number">380</span>, <span class="number">400</span>, </div><div class="line">        <span class="number">550</span>, <span class="number">600</span>, <span class="number">550</span>, <span class="number">450</span>, <span class="number">550</span>, <span class="number">650</span>, </div><div class="line">        <span class="number">1280</span>, <span class="number">780</span>, <span class="number">780</span>]</div><div class="line"></div><div class="line">n = len(menu)</div><div class="line">np.random.seed(<span class="number">0</span>)</div><div class="line">df = pd.DataFrame(&#123;</div><div class="line">    <span class="string">'品目'</span>: menu,</div><div class="line">    <span class="string">'値段'</span>: price,</div><div class="line">    <span class="string">'満足度'</span>: np.random.randint(<span class="number">10</span>, <span class="number">20</span>, n),</div><div class="line">    <span class="string">'焼き時間'</span>: np.random.randint(<span class="number">5</span>, <span class="number">10</span>, n),</div><div class="line">    <span class="string">'量'</span>: np.random.randint(<span class="number">10</span>, <span class="number">20</span>, n),</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">print(df)</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th></th>
<th>値段</th>
<th>品目</th>
<th>満足度</th>
<th>焼き時間</th>
<th>量</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>720</td>
<td>カルビ</td>
<td>15</td>
<td>9</td>
<td>10</td>
</tr>
<tr>
<td>1</td>
<td>950</td>
<td>和牛カルビ</td>
<td>10</td>
<td>8</td>
<td>10</td>
</tr>
<tr>
<td>2</td>
<td>850</td>
<td>和牛中落ちカルビ</td>
<td>13</td>
<td>5</td>
<td>14</td>
</tr>
<tr>
<td>3</td>
<td>720</td>
<td>ハラミ</td>
<td>13</td>
<td>8</td>
<td>15</td>
</tr>
<tr>
<td>4</td>
<td>690</td>
<td>厚切りロース</td>
<td>17</td>
<td>5</td>
<td>15</td>
</tr>
<tr>
<td>5</td>
<td>950</td>
<td>ネギ牛タン塩</td>
<td>19</td>
<td>7</td>
<td>16</td>
</tr>
<tr>
<td>6</td>
<td>850</td>
<td>牛タン塩</td>
<td>13</td>
<td>8</td>
<td>18</td>
</tr>
<tr>
<td>7</td>
<td>600</td>
<td>イベリコ豚</td>
<td>15</td>
<td>5</td>
<td>14</td>
</tr>
<tr>
<td>8</td>
<td>550</td>
<td>カシラ</td>
<td>12</td>
<td>6</td>
<td>11</td>
</tr>
<tr>
<td>9</td>
<td>580</td>
<td>豚トロ</td>
<td>14</td>
<td>8</td>
<td>14</td>
</tr>
<tr>
<td>10</td>
<td>680</td>
<td>ネギ豚タン塩</td>
<td>17</td>
<td>8</td>
<td>19</td>
</tr>
<tr>
<td>11</td>
<td>580</td>
<td>豚タン塩</td>
<td>16</td>
<td>8</td>
<td>18</td>
</tr>
<tr>
<td>12</td>
<td>500</td>
<td>厚切りベーコン</td>
<td>18</td>
<td>5</td>
<td>11</td>
</tr>
<tr>
<td>13</td>
<td>380</td>
<td>ウインナー</td>
<td>18</td>
<td>6</td>
<td>11</td>
</tr>
<tr>
<td>14</td>
<td>400</td>
<td>チョリソ</td>
<td>11</td>
<td>6</td>
<td>17</td>
</tr>
<tr>
<td>15</td>
<td>550</td>
<td>ホルモン</td>
<td>16</td>
<td>6</td>
<td>19</td>
</tr>
<tr>
<td>16</td>
<td>600</td>
<td>シロコロホルモン</td>
<td>17</td>
<td>5</td>
<td>19</td>
</tr>
<tr>
<td>17</td>
<td>550</td>
<td>レバー</td>
<td>17</td>
<td>7</td>
<td>13</td>
</tr>
<tr>
<td>18</td>
<td>450</td>
<td>白レバー</td>
<td>18</td>
<td>9</td>
<td>16</td>
</tr>
<tr>
<td>19</td>
<td>550</td>
<td>ハツ</td>
<td>11</td>
<td>8</td>
<td>17</td>
</tr>
<tr>
<td>20</td>
<td>650</td>
<td>ミノ</td>
<td>15</td>
<td>8</td>
<td>12</td>
</tr>
<tr>
<td>21</td>
<td>1280</td>
<td>お得!! 三種盛り</td>
<td>19</td>
<td>7</td>
<td>10</td>
</tr>
<tr>
<td>22</td>
<td>780</td>
<td>本日の塩三種盛り</td>
<td>18</td>
<td>9</td>
<td>13</td>
</tr>
<tr>
<td>23</td>
<td>780</td>
<td>本日の味噌三種盛り</td>
<td>19</td>
<td>7</td>
<td>15</td>
</tr>
</tbody>
</table>
<p>　メニューがpandasのデータフレームになった．取り急ぎ（？）満足度・焼き時間・量は乱数で埋めている．<br>　あなたはこのメニューの中から，最も満足度の高い組合せを見つけたい．それも，限られた予算，限られた時間，限られた胃袋の容量という条件を満たすような．ここではそのわがままを割当問題として解くことにする．</p>
<table>
<thead>
<tr>
<th>変数</th>
<th><span>$x_i \in \{0, 1\}$</span><!-- Has MathJax --></th>
<th>i番目の料理を選ぶかどうか</th>
</tr>
</thead>
<tbody>
<tr>
<td>目的関数</td>
<td><span>$\sum_i{満足度_i x_i}$</span><!-- Has MathJax --></td>
<td><span>$\rightarrow$</span><!-- Has MathJax --> 最大</td>
</tr>
<tr>
<td>制約条件</td>
<td><span>$\sum_i{予算_i x_i} \le 12000$</span><!-- Has MathJax --></td>
<td>予算制限</td>
</tr>
<tr>
<td></td>
<td><span>$\sum_i{焼き時間_i x_i} \le 120$</span><!-- Has MathJax --></td>
<td>時間制限</td>
</tr>
<tr>
<td></td>
<td><span>$150 \le \sum_i{量_i x_i} \le 200$</span><!-- Has MathJax --></td>
<td>分量制限</td>
</tr>
</tbody>
</table>
<p>　こういった問題はpulpという整数計画法ライブラリを使って解くことができる：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pulp <span class="keyword">import</span> *</div><div class="line"></div><div class="line">m = LpProblem(sense = LpMaximize)	<span class="comment"># 最大化問題</span></div><div class="line">df[<span class="string">'x'</span>] = [LpVariable(<span class="string">'x%d'</span> % i, cat = LpBinary) <span class="keyword">for</span> i <span class="keyword">in</span> range(n)]	<span class="comment"># i番目の品目を選択するかしないか</span></div><div class="line"></div><div class="line">m += lpDot(df.満足度, df.x)	<span class="comment"># 目的関数：満足度の最大化</span></div><div class="line">m += lpDot(df.値段, df.x) &lt;= <span class="number">12000</span>	<span class="comment"># 制約条件：予算</span></div><div class="line">m += lpDot(df.焼き時間, df.x) &lt;= <span class="number">120</span>	<span class="comment"># 制約条件：焼き時間</span></div><div class="line">m += lpDot(df.量, df.x) &gt;= <span class="number">150</span>	<span class="comment"># 制約条件：量</span></div><div class="line">m += lpDot(df.量, df.x) &lt;= <span class="number">200</span>	<span class="comment"># 制約条件：量</span></div><div class="line"></div><div class="line">m.solve()</div><div class="line"><span class="keyword">if</span> m.status == <span class="number">1</span>:</div><div class="line">    df[<span class="string">'val'</span>] = df.x.apply(<span class="keyword">lambda</span> v: value(v))	<span class="comment"># 結果</span></div><div class="line">    print(df[df.val == <span class="number">1</span>].品目)</div><div class="line">    print(<span class="string">'満足度 &#123;&#125;'</span>.format(sum(df[df.val == <span class="number">1</span>].満足度)))</div><div class="line">    print(<span class="string">'値段 &#123;&#125;'</span>.format(sum(df[df.val == <span class="number">1</span>].値段)))</div><div class="line"></div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="number">0</span>           カルビ</div><div class="line"><span class="number">4</span>        厚切りロース</div><div class="line"><span class="number">5</span>        ネギ牛タン塩</div><div class="line"><span class="number">7</span>         イベリコ豚</div><div class="line"><span class="number">8</span>           カシラ</div><div class="line"><span class="number">9</span>           豚トロ</div><div class="line"><span class="number">12</span>      厚切りベーコン</div><div class="line"><span class="number">13</span>        ウインナー</div><div class="line"><span class="number">16</span>     シロコロホルモン</div><div class="line"><span class="number">17</span>          レバー</div><div class="line"><span class="number">18</span>         白レバー</div><div class="line"><span class="number">20</span>           ミノ</div><div class="line"><span class="number">21</span>    お得!! 三種盛り</div><div class="line"><span class="number">22</span>     本日の塩三種盛り</div><div class="line"><span class="number">23</span>    本日の味噌三種盛り</div><div class="line">Name: 品目, dtype: object</div><div class="line">満足度 <span class="number">251</span></div><div class="line">値段 <span class="number">10060</span></div></pre></td></tr></table></figure>
<p>　はい．順番はともかくとして，これらを食べれば満足できそうだ．<br>　ここまで考えたところで，あなたは今月の懐具合がよろしくないことを思い出す．なるべく出費を抑えて，それでいてある程度満足できるような品目の組合せはあるだろうか？<br>　これも同様に割当問題として考えられる．</p>
<table>
<thead>
<tr>
<th>変数</th>
<th><span>$x_i \in \{0, 1\}$</span><!-- Has MathJax --></th>
<th>i番目の料理を選ぶかどうか</th>
</tr>
</thead>
<tbody>
<tr>
<td>目的関数</td>
<td><span>$\sum_i{予算_i x_i}$</span><!-- Has MathJax --></td>
<td><span>$\rightarrow$</span><!-- Has MathJax --> 最小</td>
</tr>
<tr>
<td>制約条件</td>
<td><span>$\sum_i{満足度_i x_i} \le 200$</span><!-- Has MathJax --></td>
<td>満足度制限</td>
</tr>
<tr>
<td></td>
<td><span>$\sum_i{焼き時間_i x_i} \le 120$</span><!-- Has MathJax --></td>
<td>時間制限</td>
</tr>
<tr>
<td></td>
<td><span>$150 \le \sum_i{量_i x_i} \le 200$</span><!-- Has MathJax --></td>
<td>分量制限</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">m = LpProblem(sense = LpMinimize)	<span class="comment"># 最小化問題</span></div><div class="line">a[<span class="string">'v'</span>] = [LpVariable(<span class="string">'v%d'</span> % i, cat = LpBinary) <span class="keyword">for</span> i <span class="keyword">in</span> range(n)]	<span class="comment"># i番目の品目を選択するかしないか</span></div><div class="line"></div><div class="line">m += lpDot(df.値段, df.x)	<span class="comment"># 目的関数：予算の最小化</span></div><div class="line">m += lpDot(df.満足度, df.x) &gt;= <span class="number">200</span>	<span class="comment"># 制約条件：満足度</span></div><div class="line">m += lpDot(df.焼き時間, df.x) &lt;= <span class="number">120</span>	<span class="comment"># 制約条件：焼き時間</span></div><div class="line">m += lpDot(df.量, df.x) &gt;= <span class="number">150</span>	<span class="comment"># 制約条件：量</span></div><div class="line">m += lpDot(df.量, df.x) &lt;= <span class="number">200</span>	<span class="comment"># 制約条件：量</span></div><div class="line">m.solve()</div><div class="line"><span class="keyword">if</span> m.status == <span class="number">1</span>:</div><div class="line">    df[<span class="string">'val'</span>] = df.x.apply(<span class="keyword">lambda</span> v: value(v))	<span class="comment"># 結果</span></div><div class="line">    print(df[df.val == <span class="number">1</span>].品目)</div><div class="line">    print(<span class="string">'満足度 &#123;&#125;'</span>.format(sum(df[df.val == <span class="number">1</span>].満足度)))</div><div class="line">    print(<span class="string">'値段 &#123;&#125;'</span>.format(sum(df[df.val == <span class="number">1</span>].値段)))</div><div class="line"></div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="number">7</span>         イベリコ豚</div><div class="line"><span class="number">10</span>       ネギ豚タン塩</div><div class="line"><span class="number">11</span>         豚タン塩</div><div class="line"><span class="number">12</span>      厚切りベーコン</div><div class="line"><span class="number">13</span>        ウインナー</div><div class="line"><span class="number">14</span>         チョリソ</div><div class="line"><span class="number">15</span>         ホルモン</div><div class="line"><span class="number">16</span>     シロコロホルモン</div><div class="line"><span class="number">17</span>          レバー</div><div class="line"><span class="number">18</span>         白レバー</div><div class="line"><span class="number">22</span>     本日の塩三種盛り</div><div class="line"><span class="number">23</span>    本日の味噌三種盛り</div><div class="line">Name: 品目, dtype: object</div><div class="line">満足度 <span class="number">200</span></div><div class="line">値段 <span class="number">6850</span></div></pre></td></tr></table></figure>
<p>　200の満足度でいいなら豚ばっか食ってろということらしい．</p>
<h1 id="多腕バンディット問題"><a href="#多腕バンディット問題" class="headerlink" title="多腕バンディット問題"></a>多腕バンディット問題</h1><p>　いやいやちょっと待った．乱数でお茶を濁しているけど，あらゆる品目の満足度なんて知らないじゃないか．全品目を食べたことがあるならいざ知らず．それに，毎日同じ店で同じ食事をとるわけでもない．焼肉屋にしたって，湘南台には寅屋にえのもとにとあるわけだ．<br>　そういうわけで，あなたはいろいろな店に行き，いろいろな注文をして，なるべくどれを頼んでも満足度の高い食事のとれる店を見つけたいと考えた．しかしここで疑念が生まれる——いまの店でそこそこ満足できるなら，別の店を探さなくてもよいのではないか？ しかしいまの店に行き続ける限り，別の店の食事を食べることはできないぞ．しかしそこがハズレだとしたら．さてどうしよう——業界用語でこれを<strong>探索</strong>と<strong>利用</strong>のトレードオフ (exploration-exploitation tradeoff) という．</p>
<blockquote>
<p>これまでの学習結果を利用 (exploitation) しようとすると，探索 (exploration) が減ってしまい，機会損失が増えてしまう．一方，探索を増やせば，学習した最良の行動とは異なる行動をとることが増えるため，得られる報酬が減ってしまう．学習した最良の行動との差が，探索のコストということになる．– 牧野，et al. 『<a href="https://www.amazon.co.jp/dp/4627880316" target="_blank" rel="external">これからの強化学習</a>』</p>
</blockquote>
<p>　このトレードオフを解消する試みを多腕バンディット問題という．多腕バンディット問題は，複数のスロットマシンのレバー（腕）を次々と引いていき，最終的に得られる報酬を最大化するというもので，強化学習の一種といえる．各スロットマシンの報酬はそれぞれ一定の確率分布に従っている．言い換えれば，いろいろな店のメニューにある品目を試していき，最終的に得られる満足度を最大化していく，ということになる．もちろん，品目によって得られる満足度に違いはあるが，なるべく何を食べても満足度の高い店を絞り込んでいきたい．<br>　そのためのアルゴリズムのうち，ここでは<span>$\epsilon$</span><!-- Has MathJax -->-GreedyとUCB1を紹介したい．</p>
<h2 id="Greedy"><a href="#Greedy" class="headerlink" title="-Greedy"></a><span>$\epsilon$</span><!-- Has MathJax -->-Greedy</h2><p>　デフォルトで現在最良な選択肢を選ぶが，一定の確率でいま最良と思っていないような選択肢を選びにいく手法．</p>
<ul>
<li><span>$1 - \epsilon$</span><!-- Has MathJax -->の確率で最適だと思われる選択肢を利用する</li>
<li><span>$\epsilon / 2$</span><!-- Has MathJax -->の確率で最適だと思われる選択肢を探索する</li>
<li><span>$\epsilon / 2$</span><!-- Has MathJax -->の確率で最悪だと思われる選択肢を探索する</li>
</ul>
<p>　<span>$\epsilon$</span><!-- Has MathJax -->-Greedyはつまり行きつけの店に入り浸るタイプのアルゴリズムだ．ただし<span>$0 &lt; \epsilon &lt; 1$</span><!-- Has MathJax -->.</p>
<h2 id="UCB1"><a href="#UCB1" class="headerlink" title="UCB1"></a>UCB1</h2><p>　それもいいが，実はいまの行きつけよりもっといい店なのに，一度行って微妙だったからといって行かないままになっている店がないだろうか？ UCB1は，それぞれの店についてどれくらい知っているかを考慮に入れ，なるべく多くの店のことを知ろうとするアルゴリズムだ．具体的には，各店（腕）についてUCB (Upper Confidence Bound) という値を計算する．</p>
<p>　<span>$\overline {x}_{j}+c\sqrt {\dfrac {2\log n} {x_{j}}}$</span><!-- Has MathJax --></p>
<p>　ただし<span>$\overline {x}_{j}$</span><!-- Has MathJax -->は<span>$_{j}$</span><!-- Has MathJax -->番目の店の満足度（報酬）の期待値，<span>$n$</span><!-- Has MathJax -->はそれまでに店を回った回数の合計，<span>$n_{j}$</span><!-- Has MathJax -->は<span>$_{j}$</span><!-- Has MathJax -->番目の店に行った回数，<span>$c$</span><!-- Has MathJax -->は定数．UCB1は，この値が最大になる店に飛び込んでいく．あなたが好奇心旺盛なら，こちらのアルゴリズムを使って考えたほうがいいだろう．<br>　この手法のメリットとして，ベストでない店に行く回数を確率<span>$1$</span><!-- Has MathJax -->で<span>$O(\log n)$</span><!-- Has MathJax -->以内に抑えられる．長々とした証明は<a href="http://homes.di.unimi.it/~cesabian/Pubblicazioni/ml-02.pdf" target="_blank" rel="external">論文</a>を参照していただくとして，これは店に行く回数が十分大きい場合の理論限界に到達している．デメリットとしては，探索のためによくない店にあたってしまうことが多いという点が挙げられる．</p>
<h2 id="実験"><a href="#実験" class="headerlink" title="実験"></a>実験</h2><p>　では，<span>$\epsilon$</span><!-- Has MathJax -->-GreedyとUCB1が<strong>最良の店を選ぶ過程</strong>はどうなっているだろうか？ 『<a href="http://www.oreilly.co.jp/books/9784873116273/" target="_blank" rel="external">バンディットアルゴリズムによる最適化手法</a>』の<a href="https://github.com/johnmyleswhite/BanditsBook" target="_blank" rel="external">サンプルコード</a>をPython3 + numpy向けに改変して実験．</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> math</div><div class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BernoulliArm</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, p)</span>:</span></div><div class="line">        self.p = p</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">draw</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> random.random() &gt; self.p:</div><div class="line">            <span class="keyword">return</span> <span class="number">0.0</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">1.0</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EpsilonGreedy</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, epsilon, counts, values)</span>:</span></div><div class="line">        self.epsilon = epsilon</div><div class="line">        self.counts = counts</div><div class="line">        self.values = values</div><div class="line">        <span class="keyword">return</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self, n_arms)</span>:</span></div><div class="line">        self.counts = np.zeros(n_arms)</div><div class="line">        self.values = np.zeros(n_arms)</div><div class="line">        <span class="keyword">return</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">select_arm</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> random.random() &gt; self.epsilon:</div><div class="line">            <span class="keyword">return</span> np.argmax(self.values)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> np.random.randint(<span class="number">0</span>, len(self.values))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, chosen_arm, reward)</span>:</span></div><div class="line">        self.counts[chosen_arm] += <span class="number">1</span></div><div class="line">        n = self.counts[chosen_arm]</div><div class="line"></div><div class="line">        value = self.values[chosen_arm]</div><div class="line">        new_value = ((n<span class="number">-1</span>) / float(n)) * value + (<span class="number">1</span> / float(n)) * reward</div><div class="line">        self.values[chosen_arm] = new_value</div><div class="line">        <span class="keyword">return</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UCB1</span><span class="params">()</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, counts, values)</span>:</span></div><div class="line">    self.counts = counts</div><div class="line">    self.values = values</div><div class="line">    <span class="keyword">return</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self, n_arms)</span>:</span></div><div class="line">    self.counts = np.zeros(n_arms)</div><div class="line">    self.values = np.zeros(n_arms)</div><div class="line">    <span class="keyword">return</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">select_arm</span><span class="params">(self)</span>:</span></div><div class="line">    n_arms = len(self.counts)</div><div class="line">    <span class="keyword">for</span> arm <span class="keyword">in</span> range(n_arms):</div><div class="line">      <span class="keyword">if</span> self.counts[arm] == <span class="number">0</span>:</div><div class="line">        <span class="keyword">return</span> arm</div><div class="line"></div><div class="line">    ucb_values = [<span class="number">0.0</span> <span class="keyword">for</span> arm <span class="keyword">in</span> range(n_arms)]</div><div class="line">    total_counts = sum(self.counts)</div><div class="line">    <span class="keyword">for</span> arm <span class="keyword">in</span> range(n_arms):</div><div class="line">      bonus = math.sqrt((<span class="number">2</span> * math.log(total_counts)) / float(self.counts[arm]))</div><div class="line">      ucb_values[arm] = self.values[arm] + bonus</div><div class="line">    <span class="keyword">return</span> np.argmax(ucb_values)</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, chosen_arm, reward)</span>:</span></div><div class="line">    self.counts[chosen_arm] = self.counts[chosen_arm] + <span class="number">1</span></div><div class="line">    n = self.counts[chosen_arm]</div><div class="line"></div><div class="line">    value = self.values[chosen_arm]</div><div class="line">    new_value = ((n - <span class="number">1</span>) / float(n)) * value + (<span class="number">1</span> / float(n)) * reward</div><div class="line">    self.values[chosen_arm] = new_value</div><div class="line">    <span class="keyword">return</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_algorithm</span><span class="params">(algo, arms, num_sims, horizon)</span>:</span></div><div class="line">    chosen_arms = np.zeros(num_sims * horizon)</div><div class="line">    rewards = np.zeros(num_sims * horizon)</div><div class="line">    cumulative_rewards = np.zeros(num_sims * horizon)</div><div class="line">    sim_nums = np.zeros(num_sims * horizon)</div><div class="line">    times = np.zeros(num_sims * horizon)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> sim <span class="keyword">in</span> range(num_sims):</div><div class="line">        sim += <span class="number">1</span></div><div class="line">        algo.initialize(len(arms))</div><div class="line"></div><div class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> range(horizon):</div><div class="line">            t += <span class="number">1</span></div><div class="line">            index = (sim - <span class="number">1</span>) * horizon + t - <span class="number">1</span></div><div class="line">            sim_nums[index] = sim</div><div class="line">            times[index] = t</div><div class="line"></div><div class="line">            chosen_arm = algo.select_arm()</div><div class="line">            chosen_arms[index] = chosen_arm</div><div class="line"></div><div class="line">            reward = arms[chosen_arm].draw()</div><div class="line">            rewards[index] = reward</div><div class="line"></div><div class="line">            <span class="keyword">if</span> t == <span class="number">1</span>:</div><div class="line">                cumulative_rewards[index] = reward</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                cumulative_rewards[index] = cumulative_rewards[index - <span class="number">1</span>] + reward</div><div class="line"></div><div class="line">            algo.update(chosen_arm, reward)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [sim_nums, times, chosen_arms, rewards, cumulative_rewards]</div><div class="line"></div><div class="line">means = np.array([<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.9</span>])</div><div class="line">n_arms = len(means) <span class="comment"># 腕は5本</span></div><div class="line">random.shuffle(means)</div><div class="line"></div><div class="line">arms = [BernoulliArm(x) <span class="keyword">for</span> x <span class="keyword">in</span> means]</div><div class="line"></div><div class="line"><span class="keyword">for</span> epsilon <span class="keyword">in</span> [<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.3</span>, <span class="number">0.4</span>, <span class="number">0.5</span>]: <span class="comment"># epsilonを変えたらどうなるか？</span></div><div class="line">    algo = EpsilonGreedy(epsilon, [], [])</div><div class="line">    algo.initialize(n_arms)</div><div class="line">    results = test_algorithm(algo, arms, <span class="number">5000</span>, <span class="number">500</span>)</div><div class="line"></div><div class="line">    df = pd.DataFrame(&#123;<span class="string">"times"</span>: results[<span class="number">1</span>], <span class="string">"rewards"</span>: results[<span class="number">3</span>]&#125;)</div><div class="line">    grouped = df[<span class="string">"rewards"</span>].groupby(df[<span class="string">"times"</span>])</div><div class="line"></div><div class="line">    plt.plot(grouped.mean(), label=<span class="string">"epsilon="</span>+str(epsilon))</div><div class="line"></div><div class="line">algo = UCB1([], [])</div><div class="line">algo.initialize(n_arms)</div><div class="line">results = test_algorithm(algo, arms, <span class="number">5000</span>, <span class="number">500</span>)</div><div class="line"></div><div class="line">df = pd.DataFrame(&#123;<span class="string">"times"</span>: results[<span class="number">1</span>], <span class="string">"rewards"</span>: results[<span class="number">3</span>]&#125;)</div><div class="line">grouped = df[<span class="string">"rewards"</span>].groupby(df[<span class="string">"times"</span>])</div><div class="line"></div><div class="line">plt.plot(grouped.mean(), label=<span class="string">"UCB1"</span>)</div><div class="line"></div><div class="line">plt.legend(loc=<span class="string">"best"</span>)</div><div class="line">plt.show()</div></pre></td></tr></table></figure>
<p><img src="/image/bandits/bandits.png"></p>
<p>　好奇心旺盛な人は序盤それなりに苦労することがわかる．</p>
<h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>　こうしたナイーブな実装で焼肉の頼み方を最適化したり，店の巡り方を最適化できるかどうかというとまあ実際微妙（たとえば焼肉の各品目から得られる満足度は，限界効用逓減の法則に従ってすり減っていく）だが，日々の意思決定をアルゴリズム的に考えてみる遊びはそれなりにおもしろい．ソーシャルゲームにどう課金するか，というのもこの俎上に載せられる．<br>　『<a href="https://www.amazon.co.jp/dp/B015CKNWJI/" target="_blank" rel="external">Algorithms to Live By: The Computer Science of Human Decisions</a>』という本はそういう，情報系の人間がよくやる与太話をまじめに考察したものだ——書類はどのキャッシュアルゴリズムに従って並べるべきかとか．先に挙げた探索と利用のトレードオフについても述べられている．YouTubeで著者らの講演を観てほしい．</p>
<center><iframe width="560" height="315" src="https://www.youtube.com/embed/OwKj-wgXteo" frameborder="0" allowfullscreen></iframe></center>

<p>　はい．</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li><a href="http://qiita.com/Tsutomu-KKE@github/items/f8be15f56cbacdbb7bd9" target="_blank" rel="external">献立を組合せ最適化で考える - Qiita</a></li>
<li><a href="http://qiita.com/makora9143/items/9e90a533c95c24b85a94" target="_blank" rel="external">備忘録＠Python ORセミナー: Pulp - Qiita</a></li>
<li><a href="http://qiita.com/yuku_t/items/6844aac6008911401b19" target="_blank" rel="external">A/Bテストよりすごい？バンディットアルゴリズムとは一体何者か - Qiita</a></li>
<li><a href="http://minerva.cs.uec.ac.jp/~ito/entcog/contents/lecture/date/5-yoshizoe.pdf" target="_blank" rel="external">コンピュータ囲碁における モンテカルロ法 ~理論編~[PDF]</a></li>
</ul>
<h1 id="追記-2016-12-06"><a href="#追記-2016-12-06" class="headerlink" title="追記 (2016.12.06)"></a>追記 (2016.12.06)</h1><p>　今回のような設定では多腕バンディット問題というより最適腕識別として考えたほうがよさそう．多腕バンディット問題は累積報酬の最大化が目的だけれど，最適腕識別はどの腕が最良か発見するのが目的．将来の報酬が最大の腕を見つける，ということ．『<a href="https://www.amazon.co.jp/dp/406152917X/" target="_blank" rel="external">バンディット問題の理論とアルゴリズム</a>』を読めばいいんだとか．</p>
<h1 id="追記-2018-08-13"><a href="#追記-2018-08-13" class="headerlink" title="追記 (2018.08.13)"></a>追記 (2018.08.13)</h1><p>　<span>$\epsilon - 1$</span><!-- Has MathJax -->となっていたのを<span>$1 - \epsilon$</span><!-- Has MathJax -->に修正．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/12/04/yakiniku-optimization/" data-id="cjkr035t40026pv7tr3fhxilg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/machine-learning/">machine learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/optimization/">optimization</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 ntddk<br>
      <a href="https://github.com/ntddk/hexo-theme-jathena" target="_blank">JAthena</a> by <a href="https://ntddk.github.io" target="_blank">ntddk</a> | Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>

<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
</body>
</html>